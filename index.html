<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>üß© MateBlocks ‚Äî Aventura Matem√°tica</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
.app,.center-panel,.left-panel,.right-panel{user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}
:root{
  --bg:#1a1a2e;--board:#16213e;--cell:#0f3460;--cell-hover:#1a4a7a;
  --green:#00d68f;--blue:#38bdf8;--orange:#ff9f43;--pink:#ff6b9d;
  --red:#ff4757;--purple:#a78bfa;--yellow:#ffd43b;--cyan:#22d3ee;
  --text:#e2e8f0;--text-dim:#64748b;--panel:#1e293b;--card:#0f172a;
  --glow-green:rgba(0,214,143,.3);--glow-blue:rgba(56,189,248,.3);
}
html,body{height:100%;overflow:hidden;overscroll-behavior:none;-webkit-overflow-scrolling:touch}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;overscroll-behavior-y:contain}

/* Elemento fantasma para drag t√°ctil */
.drag-ghost{position:fixed;pointer-events:none;z-index:9999;font-size:3rem;filter:drop-shadow(0 4px 8px rgba(0,0,0,.5));transform:translate(-50%,-50%);transition:none}

.header{text-align:center;padding:6px 12px;flex-shrink:0;display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap}
.header h1{font-weight:900;font-size:1.2rem;background:linear-gradient(135deg,var(--green),var(--blue),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.score-bar{display:flex;gap:16px;align-items:center}
.score-item{text-align:center;padding:4px 12px;background:var(--panel);border-radius:8px}
.score-item .val{font-weight:900;font-size:1rem}
.score-item .lbl{font-size:.6rem;font-weight:700;color:var(--text-dim);text-transform:uppercase}
.score-item.adventures .val{color:var(--purple)}
.score-item.streak .val{color:var(--yellow)}
.score-item.stars .val{color:var(--cyan)}

.app{flex:1;display:grid;grid-template-columns:280px 1fr 260px;gap:10px;padding:8px 12px;min-height:0;overflow:hidden}

.left-panel{display:flex;flex-direction:column;gap:8px;overflow:hidden}
.story-panel{background:linear-gradient(135deg, var(--card), var(--panel));border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,.08);flex-shrink:0}
.story-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.story-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--pink));display:flex;align-items:center;justify-content:center;font-size:1.4rem}
.story-meta{flex:1}
.story-title{font-weight:900;font-size:.85rem;color:var(--yellow)}
.story-chapter{font-size:.65rem;color:var(--text-dim);font-weight:700}
.story-text{background:rgba(0,0,0,.2);border-radius:8px;padding:10px;font-size:.8rem;line-height:1.5;border-left:3px solid var(--purple)}
.story-text .highlight{color:var(--yellow);font-weight:800}
.story-text .number{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;border-radius:6px;font-weight:900;font-size:.85rem;padding:0 4px;background:rgba(0,214,143,.2);color:var(--green);border:1px solid var(--green)}
.progress-bar{display:flex;align-items:center;gap:6px;margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,.08)}
.progress-step{flex:1;height:6px;border-radius:3px;background:rgba(255,255,255,.1)}
.progress-step.done{background:var(--green)}
.progress-step.current{background:rgba(255,212,59,.3);border:1px solid var(--yellow)}
.progress-label{font-size:.6rem;font-weight:800;color:var(--text-dim)}

.challenge-card{background:var(--panel);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,.08);flex-shrink:0}
.challenge-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.challenge-title{font-size:.75rem;font-weight:800;color:var(--cyan)}
.challenge-op{padding:3px 10px;border-radius:12px;font-size:.65rem;font-weight:800;text-transform:uppercase}
.challenge-op.suma{background:rgba(0,214,143,.15);color:var(--green)}
.challenge-op.resta{background:rgba(255,159,67,.15);color:var(--orange)}
.challenge-op.multi{background:rgba(56,189,248,.15);color:var(--blue)}
.challenge-op.divi{background:rgba(255,107,157,.15);color:var(--pink)}
.challenge-equation{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;background:rgba(0,0,0,.2);border-radius:10px}
.challenge-equation .num{min-width:32px;height:32px;border-radius:10px;font-weight:900;font-size:1.1rem;display:flex;align-items:center;justify-content:center;padding:0 6px}
.challenge-equation .num.a{background:rgba(0,214,143,.15);color:var(--green)}
.challenge-equation .num.b{background:rgba(56,189,248,.15);color:var(--blue)}
.challenge-equation .op-sym{font-size:1.3rem;color:var(--text-dim);font-weight:800}
.challenge-equation .eq{font-size:1.2rem;color:var(--yellow);font-weight:800}
.challenge-equation .result-box{background:rgba(255,212,59,.1);color:var(--yellow);border:2px dashed var(--yellow);min-width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1.1rem}

.hint-panel{background:var(--card);border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,.06);flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px}
.hint-panel h4{font-size:.7rem;font-weight:800;color:var(--cyan);display:flex;align-items:center;gap:6px}
.hint-level{padding:8px;border-radius:8px;font-size:.72rem;line-height:1.4;display:none}
.hint-level.active{display:block}
.hint-level.hint-1{background:rgba(167,139,250,.1);border-left:3px solid var(--purple);color:var(--text)}
.hint-level.hint-2{background:rgba(255,212,59,.1);border-left:3px solid var(--yellow);color:var(--text)}
.hint-level.hint-3{background:rgba(0,214,143,.1);border-left:3px solid var(--green);color:var(--text)}
.hint-level b{color:var(--yellow)}

.center-panel{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;min-height:0}

/* Source area - where objects come from */
.source-area{background:linear-gradient(135deg, var(--panel), var(--card));border-radius:16px;padding:16px;border:2px solid rgba(255,255,255,.1);margin-bottom:12px;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}
.source-title{font-size:.75rem;font-weight:800;color:var(--text-dim);text-align:center;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:6px}
.source-title .icon{font-size:1rem}
.tap-hint{font-size:.6rem;color:var(--cyan);text-align:center;margin-top:6px;opacity:.8}
.source-groups{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.source-group{background:rgba(0,0,0,.2);border-radius:12px;padding:10px;min-width:80px;border:2px dashed rgba(255,255,255,.15)}
.source-group.empty{opacity:.5;border-style:dotted}
.source-group-label{font-size:.65rem;font-weight:700;color:var(--text-dim);text-align:center;margin-bottom:6px}
.source-items{display:flex;flex-wrap:wrap;gap:4px;justify-content:center;min-height:40px;align-items:center}
.source-emoji{font-size:1.8rem;cursor:grab;transition:all .15s;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;-webkit-user-drag:element;animation:emojiPop .3s ease}
.source-emoji:active{cursor:grabbing}
.source-emoji:hover{transform:scale(1.15)}
.source-emoji:active{transform:scale(.95)}
.source-emoji.dragging{opacity:.4;transform:scale(.8)}
.source-emoji.selected{transform:scale(1.2);filter:drop-shadow(0 0 8px var(--yellow));animation:selectedPulse 1s ease infinite}

/* Trash bin */
.trash-row{display:flex;justify-content:center;align-items:center;gap:16px;margin-top:10px}
.trash-bin{width:50px;height:50px;border-radius:12px;background:rgba(255,71,87,.1);border:2px dashed var(--red);display:flex;align-items:center;justify-content:center;font-size:1.5rem;transition:all .2s;opacity:.6;cursor:pointer}
.trash-bin:hover{opacity:1;transform:scale(1.05)}
.trash-bin.drag-over{opacity:1;transform:scale(1.15);background:rgba(255,71,87,.25);border-style:solid;box-shadow:0 0 20px rgba(255,71,87,.4)}
.trash-bin.waiting{opacity:1;border-color:var(--cyan);animation:zonePulse 1.5s ease infinite}

/* Workspace area */
.workspace{display:flex;flex-direction:column;gap:12px;align-items:center;width:100%;max-width:600px;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}
.workspace-title{font-size:.85rem;font-weight:700;color:var(--cyan);text-align:center;background:rgba(56,189,248,.1);padding:8px 16px;border-radius:20px;border:1px solid rgba(56,189,248,.2)}

/* Drop zones for operations */
.drop-zones{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;align-items:flex-start}
.drop-zone{background:var(--card);border-radius:16px;padding:12px;border:3px dashed rgba(255,255,255,.15);min-width:120px;min-height:100px;display:flex;flex-direction:column;align-items:center;gap:8px;transition:all .2s}
.drop-zone:hover{border-color:rgba(255,255,255,.3);background:rgba(255,255,255,.03)}
.drop-zone.highlight{border-color:var(--yellow);background:rgba(255,212,59,.05);transform:scale(1.02)}
.drop-zone.waiting{border-color:var(--cyan);animation:zonePulse 1.5s ease infinite}
.drop-zone-label{font-size:.7rem;font-weight:800;color:var(--text-dim);display:flex;align-items:center;gap:4px}
.drop-zone-label .zone-emoji{font-size:1.2rem}
.drop-zone-items{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;min-height:50px;align-items:center}
.placed-emoji{font-size:2rem;cursor:grab;transition:all .15s;animation:emojiPop .3s cubic-bezier(.34,1.56,.64,1);user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;-webkit-user-drag:element}
.placed-emoji:active{cursor:grabbing}
.placed-emoji:hover{transform:scale(1.2)}
.placed-emoji:active{transform:scale(.95)}
.placed-emoji.selected{transform:scale(1.2);filter:drop-shadow(0 0 8px var(--yellow));animation:selectedPulse 1s ease infinite}
.placed-emoji.removing{animation:emojiRemove .2s ease-out forwards}
.placed-emoji.shake{animation:emojiShake .35s ease}
.placed-emoji.glow{animation:emojiGlow .5s ease}
.placed-emoji.dragging{opacity:0.5;transform:scale(0.8)}
.placed-emoji.bounce{animation:emojiBounce .4s ease}
.placed-emoji.wiggle{animation:emojiWiggle .3s ease}

/* Zone effects */
.drop-zone.pulse{animation:zonePulse 1s ease infinite}
.drop-zone.success{animation:successBurst .4s ease;border-color:var(--green);background:rgba(0,214,143,.1)}

/* Stars effect */
.star-earned{animation:starSparkle .5s ease;display:inline-block}

/* Feedback animations */
.feedback.correct{animation:successBurst .5s ease}
.feedback.wrong .big-emoji{animation:emojiShake .5s ease}

/* Single zone for suma/multi */
.single-zone{min-width:200px;min-height:140px}
.single-zone .drop-zone-items{gap:8px}

/* Two zones for resta */
.resta-zones .drop-zone{flex:1;max-width:180px}
.resta-zones .drop-zone.zone-keep{border-color:var(--green);background:rgba(0,214,143,.05)}
.resta-zones .drop-zone.zone-remove{border-color:var(--orange);background:rgba(255,159,67,.05)}

/* Multiple zones for multi */
.multi-zones{gap:12px}
.multi-zones .drop-zone{flex:1;min-width:90px;max-width:130px;min-height:90px}
.multi-group{position:relative}
.multi-group::before{content:'';position:absolute;top:-3px;left:50%;transform:translateX(-50%);width:20px;height:6px;background:rgba(255,255,255,.2);border-radius:0 0 4px 4px}

/* Multiple zones for divi */
.divi-zones .drop-zone{flex:1;min-width:100px;max-width:140px}

@keyframes emojiPop{0%{transform:scale(0) rotate(-10deg)}50%{transform:scale(1.3) rotate(5deg)}100%{transform:scale(1) rotate(0deg)}}
@keyframes emojiRemove{0%{transform:scale(1) rotate(0deg)}100%{transform:scale(0) rotate(30deg);opacity:0}}
@keyframes emojiShake{0%,100%{transform:translateX(0) rotate(0deg)}20%{transform:translateX(-5px) rotate(-5deg)}40%{transform:translateX(5px) rotate(5deg)}60%{transform:translateX(-3px) rotate(-3deg)}80%{transform:translateX(3px) rotate(3deg)}}
@keyframes emojiGlow{0%,100%{filter:drop-shadow(0 0 0 transparent);transform:scale(1)}50%{filter:drop-shadow(0 0 15px var(--yellow));transform:scale(1.1)}}
@keyframes emojiBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes emojiWiggle{0%,100%{transform:rotate(0deg)}25%{transform:rotate(-10deg)}75%{transform:rotate(10deg)}}
@keyframes selectedPulse{0%,100%{filter:drop-shadow(0 0 8px var(--yellow))}50%{filter:drop-shadow(0 0 15px var(--yellow))}}
@keyframes zonePulse{0%,100%{box-shadow:0 0 0 0 rgba(255,212,59,0)}50%{box-shadow:0 0 20px 5px rgba(255,212,59,.3)}}
@keyframes starSparkle{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.2);opacity:.8}}
@keyframes successBurst{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
@keyframes countFloat{0%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-100%) scale(1.3)}}

.board-counters{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
.counter-chip{padding:4px 10px;border-radius:6px;font-weight:800;font-size:.7rem;display:flex;align-items:center;gap:4px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)}
.counter-dot{width:10px;height:10px;border-radius:3px}

.right-panel{display:flex;flex-direction:column;gap:8px;overflow:hidden}
.actions{display:flex;flex-direction:column;gap:6px}
.btn{border:none;padding:12px 18px;border-radius:12px;font-family:'Nunito',sans-serif;font-weight:800;font-size:.9rem;cursor:pointer;transition:all .2s;text-align:center}
.btn:hover{transform:scale(1.03)}
.btn-check{background:linear-gradient(135deg, var(--green), #00b377);color:#fff;box-shadow:0 4px 15px var(--glow-green)}
.btn-new{background:var(--purple);color:#fff}

.result-card{background:var(--panel);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,.05);flex:1;overflow:auto}
.result-card h3{font-size:.75rem;font-weight:800;color:var(--text-dim);margin-bottom:8px}
.feedback{padding:12px;border-radius:10px;text-align:center;font-weight:700;font-size:.85rem}
.feedback.correct{background:rgba(0,214,143,.1);border:2px solid var(--green);color:var(--green)}
.feedback.wrong{background:rgba(255,71,87,.1);border:2px solid var(--red);color:var(--red)}
.feedback.info{background:rgba(56,189,248,.08);border:2px solid rgba(56,189,248,.3);color:var(--blue)}
.feedback.thinking{background:rgba(167,139,250,.1);border:2px solid var(--purple);color:var(--purple)}
.feedback .big-emoji{font-size:1.8rem;display:block;margin-bottom:6px}
.feedback .detail{font-size:.72rem;color:var(--text-dim);margin-top:6px;line-height:1.4}

.encouragement{background:rgba(255,212,59,.1);border-radius:8px;padding:8px 10px;font-size:.7rem;color:var(--yellow);text-align:center;font-weight:700;margin-top:8px}
.attempts-indicator{display:flex;gap:4px;justify-content:center;margin-top:8px}
.attempt-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.15)}
.attempt-dot.used{background:var(--orange)}
.attempt-dot.success{background:var(--green)}

.sound-toggle{position:fixed;top:8px;right:10px;z-index:100;background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:5px 8px;cursor:pointer;font-size:1rem;transition:all .2s}
.sound-toggle:hover{transform:scale(1.1)}

.celebration{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:999}
.celebration-content{background:linear-gradient(135deg,var(--panel),var(--card));border-radius:16px;padding:24px 32px;text-align:center;max-width:360px;border:2px solid var(--yellow);box-shadow:0 0 30px rgba(255,212,59,.3)}
.celebration h2{font-weight:900;font-size:1.4rem;color:var(--yellow);margin-bottom:8px}
.celebration p{color:var(--text);font-size:.9rem;margin-bottom:16px;line-height:1.5}
.celebration .stars{font-size:2rem;margin-bottom:12px}
.celebration .btn{padding:10px 24px}

/* Modal de Historia con Quiz de Operaci√≥n */
.story-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;z-index:998;padding:20px;overflow:auto}
.story-modal-content{background:linear-gradient(135deg,var(--panel),var(--card));border-radius:20px;padding:28px 32px;text-align:center;max-width:480px;width:100%;border:2px solid var(--purple);box-shadow:0 0 40px rgba(167,139,250,.3);animation:modalAppear .4s ease}
@keyframes modalAppear{0%{opacity:0;transform:scale(.9) translateY(20px)}100%{opacity:1;transform:scale(1) translateY(0)}}
.story-modal-avatar{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--pink));display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin:0 auto 16px;box-shadow:0 4px 20px rgba(167,139,250,.4)}
.story-modal-title{font-weight:900;font-size:1.4rem;color:var(--yellow);margin-bottom:4px}
.story-modal-chapter{font-size:.8rem;color:var(--text-dim);margin-bottom:16px;font-weight:700}
.story-modal-text{background:rgba(0,0,0,.3);border-radius:12px;padding:16px 20px;font-size:1rem;line-height:1.6;color:var(--text);border-left:4px solid var(--purple);text-align:left;margin-bottom:20px}
.story-modal-text .highlight{color:var(--yellow);font-weight:800}
.story-modal-text .number{display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;border-radius:8px;font-weight:900;font-size:.95rem;padding:0 6px;background:rgba(0,214,143,.2);color:var(--green);border:1px solid var(--green)}
.story-modal-question{font-size:1.1rem;font-weight:800;color:var(--cyan);margin-bottom:16px}
.quiz-section{margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,.1)}
.quiz-label{font-size:.85rem;font-weight:700;color:var(--text-dim);margin-bottom:12px}
.operation-btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.op-btn{flex:1;min-width:100px;padding:14px 12px;border-radius:14px;border:2px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:var(--text);font-weight:800;font-size:.9rem;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:4px}
.op-btn:hover{border-color:rgba(255,255,255,.3);transform:scale(1.03)}
.op-btn:active{transform:scale(.97)}
.op-btn.suma{border-color:var(--green);background:rgba(0,214,143,.1)}
.op-btn.suma:hover{background:rgba(0,214,143,.2);box-shadow:0 0 15px rgba(0,214,143,.3)}
.op-btn.resta{border-color:var(--orange);background:rgba(255,159,67,.1)}
.op-btn.resta:hover{background:rgba(255,159,67,.2);box-shadow:0 0 15px rgba(255,159,67,.3)}
.op-btn.multi{border-color:var(--blue);background:rgba(56,189,248,.1)}
.op-btn.multi:hover{background:rgba(56,189,248,.2);box-shadow:0 0 15px rgba(56,189,248,.3)}
.op-btn.divi{border-color:var(--pink);background:rgba(255,107,157,.1)}
.op-btn.divi:hover{background:rgba(255,107,157,.2);box-shadow:0 0 15px rgba(255,107,157,.3)}
.op-btn .op-sym{font-size:1.4rem;font-weight:900}
.op-btn .op-name{font-size:.7rem;text-transform:uppercase;letter-spacing:1px}
.op-btn.disabled{opacity:.5;cursor:not-allowed;pointer-events:none}
.op-btn.correct{animation:correctPulse .5s ease;border-color:var(--green)!important;background:rgba(0,214,143,.3)!important}
.op-btn.wrong{animation:wrongShake .5s ease;border-color:var(--red)!important;background:rgba(255,71,87,.2)!important}
@keyframes correctPulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
@keyframes wrongShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
.quiz-feedback{margin-top:16px;padding:14px;border-radius:12px;font-size:.9rem;line-height:1.5;display:none}
.quiz-feedback.show{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{0%{opacity:0;transform:translateY(-10px)}100%{opacity:1;transform:translateY(0)}}
.quiz-feedback.wrong{background:rgba(255,71,87,.15);border:2px solid var(--red);color:var(--text)}
.quiz-feedback.wrong .feedback-title{color:var(--red);font-weight:800;display:block;margin-bottom:8px}
.quiz-feedback .tip-box{background:rgba(0,0,0,.2);border-radius:8px;padding:10px 12px;margin-top:10px;font-size:.82rem;text-align:left}
.quiz-feedback .tip-box b{color:var(--yellow)}
.quiz-cooldown{margin-top:12px;font-size:.8rem;color:var(--text-dim);font-weight:700}
.quiz-cooldown .timer{color:var(--yellow);font-weight:900;font-size:1rem}

/* Lectura en voz alta */
.voice-reading-indicator{display:flex;align-items:center;justify-content:center;gap:10px;padding:12px 16px;background:rgba(167,139,250,.15);border-radius:12px;margin-bottom:16px;border:2px solid var(--purple)}
.voice-reading-indicator .voice-icon{font-size:1.5rem;animation:voicePulse 1s ease infinite}
.voice-reading-indicator .voice-text{font-size:.85rem;font-weight:700;color:var(--purple)}
.voice-reading-indicator .voice-dots{display:flex;gap:4px}
.voice-reading-indicator .voice-dots span{width:8px;height:8px;border-radius:50%;background:var(--purple);animation:voiceDot 1.4s ease infinite}
.voice-reading-indicator .voice-dots span:nth-child(2){animation-delay:.2s}
.voice-reading-indicator .voice-dots span:nth-child(3){animation-delay:.4s}
@keyframes voicePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
@keyframes voiceDot{0%,60%,100%{opacity:.3;transform:scale(.8)}30%{opacity:1;transform:scale(1.2)}}
.story-modal-text.reading{border-color:var(--yellow);background:rgba(255,212,59,.1);animation:readingGlow 2s ease infinite}
.story-modal-question.reading{color:var(--yellow);animation:readingGlow 2s ease infinite}
@keyframes readingGlow{0%,100%{box-shadow:0 0 5px rgba(255,212,59,.2)}50%{box-shadow:0 0 20px rgba(255,212,59,.4)}}
.quiz-section.hidden{opacity:.3;pointer-events:none}
.quiz-section.hidden .quiz-label::after{content:' (Escucha primero...)';color:var(--yellow);font-style:italic}
.voice-btn{position:absolute;top:12px;right:12px;width:40px;height:40px;border-radius:50%;border:2px solid var(--purple);background:rgba(167,139,250,.2);color:var(--purple);font-size:1.2rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
.voice-btn:hover{background:rgba(167,139,250,.4);transform:scale(1.1)}
.voice-btn.speaking{background:var(--purple);color:white;animation:speakingPulse 1s ease infinite}
@keyframes speakingPulse{0%,100%{box-shadow:0 0 0 0 rgba(167,139,250,.5)}50%{box-shadow:0 0 0 10px rgba(167,139,250,0)}}
.story-modal-content{position:relative}

/* Bot√≥n de escuchar prominente */
.listen-btn{display:flex;align-items:center;justify-content:center;gap:12px;width:100%;padding:16px 24px;margin-bottom:20px;border-radius:16px;border:3px solid var(--purple);background:linear-gradient(135deg,rgba(167,139,250,.2),rgba(255,107,157,.2));color:var(--text);font-size:1.1rem;font-weight:800;cursor:pointer;transition:all .3s;animation:listenPulse 2s ease infinite}
.listen-btn:hover{transform:scale(1.03);background:linear-gradient(135deg,rgba(167,139,250,.4),rgba(255,107,157,.4));box-shadow:0 0 25px rgba(167,139,250,.4)}
.listen-btn:active{transform:scale(.98)}
.listen-btn .listen-icon{font-size:1.8rem;animation:speakerBounce 1s ease infinite}
@keyframes listenPulse{0%,100%{box-shadow:0 0 10px rgba(167,139,250,.3)}50%{box-shadow:0 0 25px rgba(167,139,250,.5)}}
@keyframes speakerBounce{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}

/* Mobile adjustments for modal */
@media(max-width:900px){
  .story-modal{padding:15px}
  .story-modal-content{padding:20px;border-radius:16px}
  .story-modal-avatar{width:70px;height:70px;font-size:2rem;margin-bottom:12px}
  .story-modal-title{font-size:1.2rem}
  .story-modal-text{padding:14px 16px;font-size:.95rem}
  .story-modal-question{font-size:1rem}
  .operation-btns{gap:8px}
  .op-btn{min-width:80px;padding:12px 10px;font-size:.85rem}
  .op-btn .op-sym{font-size:1.2rem}
  .quiz-feedback{padding:12px;font-size:.85rem}
}

/* Modal de Repaso Matem√°tico */
.math-review-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;z-index:997;padding:20px;overflow:auto}
.math-review-content{background:linear-gradient(135deg,var(--panel),var(--card));border-radius:20px;padding:24px 28px;text-align:center;max-width:540px;width:100%;border:2px solid var(--cyan);box-shadow:0 0 40px rgba(56,189,248,.3);animation:modalAppear .4s ease;max-height:90vh;overflow-y:auto}
.math-review-header{margin-bottom:16px}
.math-review-header h2{font-size:1.2rem;font-weight:900;color:var(--yellow);margin-bottom:4px;display:flex;align-items:center;justify-content:center;gap:8px}
.math-review-header p{font-size:.85rem;color:var(--text-dim)}
.math-review-header p b{color:var(--cyan)}

/* Operaci√≥n formal con etiquetas */
.formal-operation{background:rgba(0,0,0,.3);border-radius:16px;padding:16px 12px;margin-bottom:16px}
.formal-operation-title{font-size:.7rem;font-weight:700;color:var(--cyan);margin-bottom:16px;text-transform:uppercase;letter-spacing:1px}

/* Display de la operaci√≥n - dise√±o mejorado */
.operation-display{display:flex;align-items:flex-start;justify-content:center;gap:6px;margin-bottom:12px}
.math-element{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:60px}
.math-element .value{font-size:1.8rem;font-weight:900;width:52px;height:52px;display:flex;align-items:center;justify-content:center;border-radius:12px;background:rgba(255,255,255,.08);border:2px solid rgba(255,255,255,.15)}
.math-element .value.num-a{background:rgba(0,214,143,.15);border-color:var(--green);color:var(--green)}
.math-element .value.num-b{background:rgba(56,189,248,.15);border-color:var(--blue);color:var(--blue)}
.math-element .value.symbol{background:rgba(255,159,67,.15);border-color:var(--orange);color:var(--orange);font-size:1.5rem;width:44px;height:52px}
.math-element .value.equals{background:transparent;border:none;color:var(--text-dim);font-size:1.4rem;width:30px}
.math-element .value.result{background:rgba(255,212,59,.15);border-color:var(--yellow);color:var(--yellow)}
.math-element .label{font-size:.55rem;font-weight:800;color:var(--text-dim);text-transform:uppercase;letter-spacing:.3px;line-height:1.1;min-height:22px;display:flex;align-items:center;text-align:center}
.math-element .label.highlight{color:var(--cyan)}

/* Divisi√≥n como fracci√≥n (numerador arriba, denominador abajo) */
.division-display{align-items:center}
.fraction-container{display:flex;flex-direction:column;align-items:center;gap:4px;margin-right:8px}
.fraction-top,.fraction-bottom{display:flex;flex-direction:column;align-items:center;gap:4px}
.fraction-top .value{font-size:1.8rem;font-weight:900;width:52px;height:52px;display:flex;align-items:center;justify-content:center;border-radius:12px;background:rgba(0,214,143,.15);border:2px solid var(--green);color:var(--green)}
.fraction-bottom .value{font-size:1.8rem;font-weight:900;width:52px;height:52px;display:flex;align-items:center;justify-content:center;border-radius:12px;background:rgba(56,189,248,.15);border:2px solid var(--blue);color:var(--blue)}
.fraction-top .label,.fraction-bottom .label{font-size:.55rem;font-weight:800;color:var(--cyan);text-transform:uppercase;letter-spacing:.3px;line-height:1.1}
.fraction-line-container{display:flex;flex-direction:column;align-items:center;margin:6px 0}
.fraction-line{width:70px;height:4px;background:var(--orange);border-radius:2px}
.fraction-symbol-label{font-size:.5rem;font-weight:800;color:var(--orange);text-transform:uppercase;letter-spacing:.3px;margin-top:4px}

/* Tabla de t√©rminos - redise√±ada */
.terms-table{background:rgba(0,0,0,.25);border-radius:12px;padding:12px;margin-top:12px}
.terms-table-title{font-size:.7rem;font-weight:700;color:var(--purple);margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:6px}
.terms-grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:8px}
.term-item{background:rgba(255,255,255,.06);border-radius:10px;padding:10px 8px;text-align:center;border-top:3px solid var(--purple)}
.term-item .term-name{font-size:.6rem;font-weight:800;color:var(--cyan);text-transform:uppercase;margin-bottom:4px;letter-spacing:.5px}
.term-item .term-value{font-size:1.3rem;font-weight:900;color:var(--yellow);margin-bottom:2px}
.term-item .term-desc{font-size:.58rem;color:var(--text-dim);line-height:1.3}

.fun-fact{font-size:.72rem;color:var(--yellow);margin-top:12px;font-style:italic;padding:8px 12px;background:rgba(255,212,59,.08);border-radius:8px;border-left:3px solid var(--yellow)}

/* Quiz de t√©rminos */
.terms-quiz{margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,.1)}
.terms-quiz-question{font-size:.9rem;font-weight:700;color:var(--text);margin-bottom:12px;line-height:1.4}
.terms-quiz-question .quiz-highlight{color:var(--yellow);font-weight:900;font-size:1.05rem}
.terms-options{display:grid;grid-template-columns:repeat(2, 1fr);gap:8px}
.term-option{padding:11px 10px;border-radius:10px;border:2px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:var(--text);font-weight:700;font-size:.82rem;cursor:pointer;transition:all .2s;text-align:center}
.term-option:hover{border-color:rgba(255,255,255,.3);transform:scale(1.02)}
.term-option.correct{border-color:var(--green)!important;background:rgba(0,214,143,.2)!important;animation:correctPulse .4s ease}
.term-option.wrong{border-color:var(--red)!important;background:rgba(255,71,87,.15)!important;animation:wrongShake .4s ease}
.term-option.disabled{opacity:.6;pointer-events:none}
.terms-quiz-feedback{margin-top:10px;padding:10px 12px;border-radius:10px;font-size:.8rem;display:none}
.terms-quiz-feedback.show{display:block;animation:fadeIn .3s ease}
.terms-quiz-feedback.success{background:rgba(0,214,143,.15);border:1px solid var(--green);color:var(--green)}
.terms-quiz-feedback.error{background:rgba(255,71,87,.15);border:1px solid var(--red);color:var(--text)}
.terms-quiz-progress{display:flex;gap:6px;justify-content:center;margin-bottom:10px}
.quiz-dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,.15)}
.quiz-dot.done{background:var(--green)}
.quiz-dot.current{background:var(--yellow);animation:pulse 1s ease infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.3)}}

.continue-btn{margin-top:16px;padding:14px 28px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--green),#00b377);color:#fff;font-weight:800;font-size:1rem;cursor:pointer;transition:all .2s;display:none}
.continue-btn.show{display:inline-block;animation:fadeIn .3s ease}
.continue-btn:hover{transform:scale(1.05);box-shadow:0 4px 20px rgba(0,214,143,.4)}

/* Mobile adjustments for math review */
@media(max-width:900px){
  .math-review-modal{padding:12px}
  .math-review-content{padding:16px;max-height:95vh}
  .math-review-header{margin-bottom:12px}
  .math-review-header h2{font-size:1rem}
  .math-review-header p{font-size:.8rem}
  .formal-operation{padding:12px 10px}
  .formal-operation-title{font-size:.65rem;margin-bottom:12px}
  .operation-display{gap:4px}
  .math-element{min-width:50px;gap:4px}
  .math-element .value{font-size:1.4rem;width:42px;height:42px;border-radius:10px}
  .math-element .value.symbol{width:36px;font-size:1.2rem}
  .math-element .value.equals{width:24px;font-size:1.2rem}
  .math-element .label{font-size:.5rem;min-height:18px}
  .terms-table{padding:10px;margin-top:10px}
  .terms-table-title{font-size:.65rem;margin-bottom:8px}
  .terms-grid{grid-template-columns:repeat(3, 1fr);gap:6px}
  .term-item{padding:8px 6px;border-radius:8px}
  .term-item .term-name{font-size:.55rem;margin-bottom:2px}
  .term-item .term-value{font-size:1.1rem}
  .term-item .term-desc{font-size:.52rem}
  .fun-fact{font-size:.65rem;padding:6px 10px;margin-top:10px}
  .terms-quiz{margin-top:12px;padding-top:12px}
  .terms-quiz-question{font-size:.85rem;margin-bottom:10px}
  .terms-quiz-question .quiz-highlight{font-size:1rem}
  .terms-options{gap:6px}
  .term-option{padding:10px 8px;font-size:.78rem;border-radius:8px}
  .terms-quiz-feedback{padding:8px 10px;font-size:.75rem}
  .continue-btn{padding:12px 24px;font-size:.9rem}
  /* Fracci√≥n de divisi√≥n mobile */
  .fraction-top .value,.fraction-bottom .value{font-size:1.4rem;width:42px;height:42px;border-radius:10px}
  .fraction-top .label,.fraction-bottom .label{font-size:.48rem}
  .fraction-line{width:55px;height:3px}
  .fraction-symbol-label{font-size:.45rem}
}

/* Trivia Modal - Juego de Premio */
.trivia-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);display:flex;align-items:center;justify-content:center;z-index:998;padding:20px;overflow:auto}
.trivia-content{background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:24px;padding:28px;text-align:center;max-width:500px;width:100%;border:3px solid var(--yellow);box-shadow:0 0 60px rgba(255,212,59,.4);animation:modalAppear .5s ease}
.trivia-header{margin-bottom:20px}
.trivia-category{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.1);padding:8px 16px;border-radius:20px;font-size:.85rem;font-weight:700;color:var(--yellow);margin-bottom:12px}
.trivia-category-icon{font-size:1.5rem}
.trivia-title{font-size:1.4rem;font-weight:900;color:#fff;margin-bottom:4px}
.trivia-subtitle{font-size:.85rem;color:var(--text-dim)}
.trivia-question-box{background:rgba(0,0,0,.4);border-radius:16px;padding:20px;margin-bottom:20px;border:2px solid rgba(255,255,255,.1)}
.trivia-question{font-size:1.1rem;font-weight:700;color:#fff;line-height:1.4}
.trivia-image{font-size:4rem;margin-bottom:12px;filter:drop-shadow(0 4px 8px rgba(0,0,0,.3))}
.trivia-options{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.trivia-option{background:rgba(255,255,255,.08);border:2px solid rgba(255,255,255,.2);border-radius:12px;padding:14px 12px;font-size:.95rem;font-weight:700;color:#fff;cursor:pointer;transition:all .2s ease}
.trivia-option:hover{background:rgba(255,255,255,.15);border-color:var(--cyan);transform:scale(1.02)}
.trivia-option.correct{background:rgba(0,214,143,.3);border-color:var(--green);color:var(--green);animation:pulse .3s ease}
.trivia-option.wrong{background:rgba(255,107,107,.3);border-color:var(--red);color:var(--red)}
.trivia-option.disabled{pointer-events:none;opacity:.6}
.trivia-option.reading{background:rgba(255,212,59,.2);border-color:var(--yellow);color:var(--yellow);transform:scale(1.05);box-shadow:0 0 20px rgba(255,212,59,.4);animation:optionReading .8s ease infinite}
@keyframes optionReading{0%,100%{box-shadow:0 0 10px rgba(255,212,59,.3)}50%{box-shadow:0 0 25px rgba(255,212,59,.6)}}
.trivia-feedback{margin-top:16px;padding:12px;border-radius:12px;font-weight:700;display:none}
.trivia-feedback.show{display:block;animation:fadeIn .3s ease}
.trivia-feedback.success{background:rgba(0,214,143,.2);border:2px solid var(--green);color:var(--green)}
.trivia-feedback.error{background:rgba(255,107,107,.2);border:2px solid var(--red);color:var(--red)}
.trivia-continue-btn{margin-top:16px;background:linear-gradient(135deg,var(--yellow),var(--orange));color:#000;border:none;border-radius:12px;padding:14px 32px;font-size:1rem;font-weight:800;cursor:pointer;display:none}
.trivia-continue-btn.show{display:inline-block;animation:bounceIn .4s ease}
@keyframes bounceIn{0%{transform:scale(0)}50%{transform:scale(1.1)}100%{transform:scale(1)}}

/* Trivia Progress Dots */
.trivia-progress{display:flex;justify-content:center;gap:12px;margin-bottom:16px}
.trivia-dot{font-size:1.2rem;color:var(--text-dim);transition:all .3s ease}
.trivia-dot.done{color:var(--green);transform:scale(1.1)}
.trivia-dot.current{color:var(--yellow);animation:currentDotPulse 1s ease infinite;transform:scale(1.2)}
@keyframes currentDotPulse{0%,100%{opacity:1;transform:scale(1.2)}50%{opacity:.7;transform:scale(1.4)}}

/* Trivia Summary */
.trivia-summary{text-align:center;padding:20px}
.trivia-summary h3{font-size:1.4rem;font-weight:900;color:var(--yellow);margin-bottom:8px}
.trivia-summary .summary-score{font-size:1.1rem;color:var(--text);margin-bottom:16px}
.trivia-summary .summary-score b{color:var(--cyan)}
.trivia-summary .summary-stars{font-size:2.5rem;margin-bottom:16px;filter:drop-shadow(0 4px 12px rgba(255,212,59,.4))}
.trivia-summary .summary-message{font-size:.95rem;color:var(--text-dim);margin-bottom:20px;line-height:1.5}

/* Desaf√≠o Rel√°mpago Modal */
.desafio-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);display:flex;align-items:center;justify-content:center;z-index:998;padding:20px;overflow:auto}
.desafio-content{background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:24px;padding:28px;text-align:center;max-width:500px;width:100%;border:3px solid var(--cyan);box-shadow:0 0 60px rgba(34,211,238,.4);animation:modalAppear .5s ease;overflow:hidden}
.desafio-header{margin-bottom:16px}
.desafio-title{font-size:1.4rem;font-weight:900;color:#fff;margin-bottom:4px}
.desafio-subtitle{font-size:.85rem;color:var(--text-dim)}
.desafio-progress{display:flex;justify-content:center;gap:12px;margin-bottom:12px}
.desafio-dot{font-size:1.2rem;color:var(--text-dim);transition:all .3s ease}
.desafio-dot.done{color:var(--green);transform:scale(1.1)}
.desafio-dot.wrong-dot{color:var(--red);transform:scale(1.1)}
.desafio-dot.current{color:var(--cyan);animation:desafioDotPulse 1s ease infinite;transform:scale(1.2)}
@keyframes desafioDotPulse{0%,100%{opacity:1;transform:scale(1.2)}50%{opacity:.7;transform:scale(1.4)}}
.desafio-track{position:relative;width:50px;height:200px;background:linear-gradient(to top,var(--panel),rgba(34,211,238,.08),rgba(255,212,59,.15));border-radius:25px;border:2px solid rgba(255,255,255,.15);margin:0 auto 16px;overflow:visible}
.desafio-rocket{position:absolute;bottom:5%;left:50%;transform:translateX(-50%);font-size:2rem;transition:bottom .6s cubic-bezier(.34,1.56,.64,1);filter:drop-shadow(0 0 8px var(--yellow))}
.desafio-checkpoint{position:absolute;left:50%;transform:translateX(-50%);font-size:1rem;opacity:.3;transition:all .4s ease}
.desafio-checkpoint.reached{opacity:1;filter:drop-shadow(0 0 6px var(--yellow))}
.desafio-equation-box{background:rgba(0,0,0,.4);border-radius:16px;padding:20px;margin-bottom:20px;border:2px solid rgba(255,255,255,.1)}
.desafio-equation{font-size:2rem;font-weight:900;color:#fff;letter-spacing:4px}
.desafio-equation .desafio-op{color:var(--cyan)}
.desafio-equation .desafio-q{color:var(--yellow);text-shadow:0 0 12px rgba(255,212,59,.5)}
.desafio-options{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.desafio-option{background:rgba(255,255,255,.08);border:2px solid rgba(255,255,255,.2);border-radius:12px;padding:16px 12px;font-size:1.3rem;font-weight:900;color:#fff;cursor:pointer;transition:all .2s ease}
.desafio-option:hover{background:rgba(255,255,255,.15);border-color:var(--cyan);transform:scale(1.02)}
.desafio-option.correct{background:rgba(0,214,143,.3);border-color:var(--green);color:var(--green);animation:pulse .3s ease}
.desafio-option.wrong{background:rgba(255,107,107,.3);border-color:var(--red);color:var(--red)}
.desafio-option.disabled{pointer-events:none;opacity:.6}
.desafio-combo{margin-top:12px;font-size:1rem;font-weight:800;color:var(--orange);min-height:28px;transition:all .3s ease}
.desafio-combo.active{animation:comboPulse .5s ease;color:var(--orange);text-shadow:0 0 12px rgba(255,159,67,.5)}
@keyframes comboPulse{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
.desafio-timer{font-size:.8rem;color:var(--text-dim);margin-top:4px}
.desafio-summary{text-align:center;padding:20px}
.desafio-summary h3{font-size:1.4rem;font-weight:900;color:var(--cyan);margin-bottom:8px}
.desafio-summary .summary-score{font-size:1.1rem;color:var(--text);margin-bottom:16px}
.desafio-summary .summary-score b{color:var(--cyan)}
.desafio-summary .summary-stars{font-size:2rem;margin-bottom:16px;filter:drop-shadow(0 4px 12px rgba(34,211,238,.4));word-break:break-word;line-height:1.4}
.desafio-summary .summary-message{font-size:.95rem;color:var(--text-dim);margin-bottom:20px;line-height:1.5}
.desafio-continue-btn{margin-top:16px;background:linear-gradient(135deg,var(--cyan),var(--blue));color:#000;border:none;border-radius:12px;padding:14px 32px;font-size:1rem;font-weight:800;cursor:pointer;display:inline-block;animation:bounceIn .4s ease}
@keyframes rocketShake{0%,100%{transform:translateX(-50%) rotate(0deg)}25%{transform:translateX(-50%) rotate(-5deg)}75%{transform:translateX(-50%) rotate(5deg)}}

.confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000;overflow:hidden}
.confetti-piece{position:absolute;width:8px;height:8px;top:-20px;animation:confettiFall linear forwards}
@keyframes confettiFall{0%{transform:translateY(0) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}

@media(max-width:1100px){.app{grid-template-columns:220px 1fr 200px}}

/* M√ìVIL - Layout vertical, TODO M√ÅS GRANDE */
@media(max-width:900px){
  html,body{overflow:auto;height:auto;min-height:100%;overscroll-behavior:none}
  .app{
    display:flex;
    flex-direction:column;
    grid-template-columns:none;
    min-height:auto;
    overflow:visible;
    padding:10px;
    gap:12px;
  }
  .left-panel{display:flex;flex-direction:column;gap:10px;overflow:visible}
  .story-panel{padding:14px}
  .story-header{margin-bottom:8px}
  .story-avatar{width:50px;height:50px;font-size:1.6rem}
  .story-title{font-size:1rem}
  .story-chapter{font-size:.7rem}
  .story-text{padding:12px;font-size:.9rem;line-height:1.5}
  .story-text .number{min-width:28px;height:28px;font-size:1rem}
  .progress-step{height:8px}
  .challenge-card{padding:14px}
  .challenge-equation{padding:12px;gap:8px}
  .challenge-equation .num{min-width:40px;height:40px;font-size:1.3rem}
  .challenge-equation .result-box{min-width:40px;height:40px;font-size:1.3rem}
  .challenge-equation .op-sym{font-size:1.5rem}
  .challenge-equation .eq{font-size:1.4rem}
  .hint-panel{display:none}
  .center-panel{min-height:auto;padding:10px 0}
  .right-panel{flex-direction:column;gap:10px;overflow:visible}
  .actions{flex-direction:row}
  .result-card{padding:14px}
  .btn{padding:16px 28px;font-size:1.1rem;border-radius:14px}
  .source-area{padding:16px}
  .source-title{font-size:.9rem;margin-bottom:12px}
  .source-group{padding:12px;min-width:100px}
  .source-group-label{font-size:.75rem;margin-bottom:8px}
  .source-items{gap:8px;min-height:50px}
  .source-emoji{font-size:2.5rem}
  .tap-hint{font-size:.75rem;margin-top:10px}
  .workspace-title{font-size:1rem;padding:12px 20px}
  .drop-zones{gap:12px}
  .drop-zone{min-width:100px;min-height:100px;padding:14px;border-radius:16px;border-width:3px}
  .drop-zone-label{font-size:.8rem}
  .drop-zone-label .zone-emoji{font-size:1.5rem}
  .drop-zone-items{gap:8px;min-height:60px}
  .placed-emoji{font-size:2.2rem}
  .single-zone{min-width:220px;min-height:140px}
  .multi-zones .drop-zone{min-width:90px;max-width:140px;min-height:100px}
  .divi-zones .drop-zone{min-width:90px;max-width:140px;min-height:100px}
  .resta-zones .drop-zone{min-width:130px;max-width:180px}
  .trash-row{margin-top:12px}
  .trash-bin{width:60px;height:60px;font-size:1.8rem}
  .board-counters{margin-top:10px}
  .counter-chip{padding:6px 10px;font-size:.75rem}
  .feedback{padding:14px;font-size:1rem}
  .feedback .big-emoji{font-size:2rem;margin-bottom:8px}
  .feedback .detail{font-size:.8rem}
  .result-card h3{font-size:.85rem}
  /* Desaf√≠o Rel√°mpago mobile */
  .desafio-track{height:150px;width:44px}
  .desafio-rocket{font-size:1.6rem}
  .desafio-equation{font-size:1.6rem}
  .desafio-option{padding:14px 10px;font-size:1.2rem}
  .desafio-content{padding:20px}
  /* Header y score bar mobile */
  .header{padding:4px 8px;gap:8px}
  .header h1{font-size:1rem}
  .score-bar{gap:8px}
  .score-item{padding:3px 8px;border-radius:6px}
  .score-item .val{font-size:.85rem}
  .score-item .lbl{font-size:.5rem}
  /* Trivia mobile */
  .trivia-content{padding:16px;border-radius:16px;max-width:100%}
  .trivia-title{font-size:1.1rem}
  .trivia-image{font-size:2.8rem;margin-bottom:8px}
  .trivia-question-box{padding:14px;margin-bottom:14px}
  .trivia-question{font-size:.95rem}
  .trivia-options{grid-template-columns:1fr;gap:8px}
  .trivia-option{padding:12px 10px;font-size:.9rem;border-radius:10px}
  .trivia-continue-btn{padding:12px 24px;font-size:.9rem}
  .trivia-category{padding:6px 12px;font-size:.8rem}
  .trivia-category-icon{font-size:1.2rem}
  .trivia-summary .summary-stars{font-size:2rem}
  /* Module report mobile */
  .module-content{padding:14px;border-radius:16px;max-width:100%;max-height:85vh}
  .module-title{font-size:1.1rem}
  .module-op-card{padding:8px 10px}
  .module-op-name{font-size:.8rem}
  .module-op-detail{font-size:.7rem}
  .module-global-stats{padding:10px}
  .module-global-stats-text{font-size:.8rem}
  .module-overall{font-size:.85rem}
  .module-btn{padding:12px 24px;font-size:.9rem}
  .module-stat-label{font-size:.65rem}
  .module-stat-value{font-size:.65rem;min-width:30px}
  .module-big-stat-icon{font-size:1.2rem}
  .module-big-stat-title{font-size:.75rem}
  .module-big-stat-detail{font-size:.65rem}
  .module-big-stat-pct{font-size:1rem}
  /* Celebration mobile */
  .celebration-content{max-width:90%;padding:20px}
  .celebration h2{font-size:1.2rem}
  .celebration p{font-size:.82rem}
  .celebration .stars{font-size:1.6rem}
}

/* ========== MODULE RESULTS MODAL ========== */
.module-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;z-index:999;padding:20px;overflow:auto}
.module-content{background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:24px;padding:28px;text-align:center;max-width:520px;width:100%;border:3px solid var(--purple);box-shadow:0 0 60px rgba(167,139,250,.4);animation:modalAppear .5s ease;max-height:90vh;overflow-y:auto}
.module-title{font-size:1.4rem;font-weight:900;color:var(--yellow);margin-bottom:4px}
.module-subtitle{font-size:.85rem;color:var(--text-dim);margin-bottom:20px}
.module-section{margin-bottom:16px;text-align:left}
.module-section-title{font-size:.85rem;font-weight:800;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.module-section-title.strong{color:var(--green)}
.module-section-title.practice{color:var(--yellow)}
.module-section-title.weak{color:var(--red)}
.module-op-card{background:rgba(0,0,0,.2);border-radius:10px;padding:10px 14px;margin-bottom:8px;border-left:3px solid rgba(255,255,255,.1)}
.module-op-card.strong{border-left-color:var(--green)}
.module-op-card.practice{border-left-color:var(--yellow)}
.module-op-card.weak{border-left-color:var(--red)}
.module-op-name{font-weight:800;font-size:.9rem;margin-bottom:4px}
.module-op-detail{font-size:.75rem;color:var(--text-dim);line-height:1.4}
.module-global-stats{background:rgba(167,139,250,.1);border-radius:12px;padding:14px;margin-top:16px;border:1px solid rgba(167,139,250,.2)}
.module-global-stats-text{font-size:.85rem;color:var(--text);line-height:1.5}
.module-overall{margin-top:16px;font-size:1rem;font-weight:700;color:var(--purple);line-height:1.5}
.module-btn{margin-top:20px;padding:14px 32px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--purple),var(--pink));color:white;font-weight:800;font-size:1rem;cursor:pointer;transition:all .2s;display:inline-block}
.module-btn:hover{transform:scale(1.05);box-shadow:0 4px 20px rgba(167,139,250,.4)}
/* Reporte detallado */
.module-stat-row{display:flex;justify-content:space-between;align-items:center;font-size:.75rem;margin-bottom:6px}
.module-stat-label{color:var(--text-dim);font-weight:600;flex:0 0 auto;margin-right:8px}
.module-stat-bar-bg{flex:1;height:8px;background:rgba(255,255,255,.1);border-radius:4px;margin:0 8px;overflow:hidden}
.module-stat-bar{height:100%;border-radius:4px;transition:width .6s ease}
.module-stat-bar.green{background:var(--green)}
.module-stat-bar.yellow{background:var(--yellow)}
.module-stat-bar.red{background:var(--red)}
.module-stat-bar.cyan{background:var(--cyan)}
.module-stat-bar.purple{background:var(--purple)}
.module-stat-value{color:#fff;font-weight:800;font-size:.75rem;min-width:36px;text-align:right}
.module-op-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.module-op-score{font-size:.7rem;font-weight:800;padding:3px 8px;border-radius:8px;min-width:42px;text-align:center}
.module-op-score.high{background:rgba(0,214,143,.2);color:var(--green)}
.module-op-score.mid{background:rgba(255,212,59,.2);color:var(--yellow)}
.module-op-score.low{background:rgba(255,71,87,.2);color:var(--red)}
.module-big-stat{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.06)}
.module-big-stat:last-child{border-bottom:none}
.module-big-stat-icon{font-size:1.5rem}
.module-big-stat-info{flex:1}
.module-big-stat-title{font-size:.8rem;font-weight:700;color:var(--text)}
.module-big-stat-detail{font-size:.7rem;color:var(--text-dim)}
.module-big-stat-pct{font-size:1.2rem;font-weight:900;min-width:50px;text-align:right}
</style>
</head>
<body>

<button class="sound-toggle" id="soundToggle" title="Sonido On/Off">üîä</button>

<div class="header">
  <h1>üß© MateBlocks</h1>
  <div class="score-bar" id="scoreBar"></div>
</div>

<div class="app">
  <div class="left-panel">
    <div class="story-panel" id="storyPanel"></div>
    <div class="challenge-card" id="challengeCard"></div>
    <div class="hint-panel" id="hintPanel"></div>
  </div>

  <div class="center-panel">
    <div class="workspace" id="workspace"></div>
    <div class="board-counters" id="counters"></div>
  </div>

  <div class="right-panel">
    <div class="actions" id="actions"></div>
    <div class="result-card" id="resultCard"></div>
  </div>
</div>

<div class="celebration" id="celebration" style="display:none"></div>
<div class="story-modal" id="storyModal" style="display:none"></div>
<div class="math-review-modal" id="mathReviewModal" style="display:none"></div>
<div class="trivia-modal" id="triviaModal" style="display:none"></div>
<div class="desafio-modal" id="desafioModal" style="display:none"></div>
<div class="module-modal" id="moduleModal" style="display:none"></div>

<script>
// ========== CONFIGURACI√ìN DEL JUGADOR ==========
const PLAYER = {
  name: 'Emilio',           // Nombre real - para llamar la atenci√≥n cuando se equivoca
  nickname: 'Esmi',         // Apodo cari√±oso - para felicitar
  fullName: 'Emilio Quintero Ocampo',  // Apodo de juego - para celebraciones especiales
  // Mensajes de √°nimo personalizados - usar Esmi
  encouragements: [
    '¬°T√∫ puedes, {nickname}!',
    '¬°Vamos {nickname}, yo creo en ti!',
    '¬°Eso es {nickname}! ¬°Sigue as√≠!',
    '¬°{nickname}, eres muy inteligente!',
    '¬°Excelente trabajo, {nickname}!',
    '¬°√Ånimo {nickname}, lo est√°s haciendo genial!',
    '¬°{nickname} puede con todo!'
  ],
  // Mensajes cuando se equivoca (cari√±osos pero firmes) - usar Emilio
  wrongAttemptMessages: [
    '{name}, pon atenci√≥n al problema.',
    '{name}, no adivines. Lee bien el problema.',
    'A ver {name}, vuelve a leer con calma.',
    '{name}, pi√©nsalo bien. ¬øQu√© te pide el problema?',
    '{name}, conc√©ntrate. T√∫ sabes esto.',
    'Oye {name}, no tan r√°pido. Lee la pista.',
    '{name}, escucha bien la explicaci√≥n.',
    '{name}, presta atenci√≥n. Yo s√© que puedes.'
  ],
  // Mensajes cuando se equivoca varias veces - tambi√©n usar Emilio (m√°s firme)
  multipleWrongMessages: [
    '{name}, necesito que pongas m√°s atenci√≥n.',
    '{name}, ya van varios intentos. Lee despacio.',
    '{name}, respira y vuelve a intentar con calma.',
    '{name}, s√© que puedes pero necesitas concentrarte.',
    '{name}, esc√∫chame bien. T√∫ eres inteligente, solo necesitas enfocarte.',
    '{name}, para un momento y piensa.'
  ],
  // Mensajes de felicitaci√≥n - usar Esmi
  correctMessages: [
    '¬°Muy bien {nickname}! ¬°Eso es!',
    '¬°Excelente {nickname}! ¬°Lo lograste!',
    '¬°As√≠ se hace, {nickname}!',
    '¬°Bravo {nickname}! ¬°Sab√≠a que pod√≠as!',
    '¬°{nickname}, eres un crack!',
    '¬°Eso {nickname}! ¬°Eres incre√≠ble!',
    '¬°Genial {nickname}! ¬°Sigue as√≠!',
    '¬°{nickname} lo logr√≥! ¬°Muy bien!',
    '¬°Perfecto {nickname}!'
  ],
  // Mensajes especiales de celebraci√≥n grande - usar Emilio Quintero Ocampo (apodo de juego)
  specialMessages: [
    '¬°{fullName} es el mejor matem√°tico!',
    '¬°{fullName} es s√∫per inteligente!',
    '¬°{fullName} puede con todo!',
    '¬°{fullName} es un campe√≥n de las matem√°ticas!',
    '¬°Nadie le gana a {fullName}!',
    '¬°{fullName} lo hizo de nuevo!',
    '¬°Arriba {fullName}!',
    '¬°Ese es mi {fullName}!'
  ]
};

// Funci√≥n para obtener mensaje personalizado
function getPlayerMessage(type, attemptCount = 0){
  let messages;
  switch(type){
    case 'encourage': messages = PLAYER.encouragements; break;
    case 'wrong': messages = attemptCount >= 3 ? PLAYER.multipleWrongMessages : PLAYER.wrongAttemptMessages; break;
    case 'correct': messages = PLAYER.correctMessages; break;
    case 'special': messages = PLAYER.specialMessages; break;
    default: messages = PLAYER.encouragements;
  }
  const msg = messages[Math.floor(Math.random() * messages.length)];
  return msg
    .replace('{name}', PLAYER.name)
    .replace('{nickname}', PLAYER.nickname)
    .replace('{fullName}', PLAYER.fullName);
}

// ========== AUDIO ==========
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let actx = null;
let soundOn = true;

function ensureAudio(){if(!actx) actx = new AudioCtx()}
function playTone(freq, dur, type='sine', vol=.12){
  if(!soundOn) return;
  ensureAudio();
  const o = actx.createOscillator();
  const g = actx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.setValueAtTime(vol, actx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001, actx.currentTime + dur);
  o.connect(g).connect(actx.destination);
  o.start();
  o.stop(actx.currentTime + dur);
}

// Funci√≥n helper para variaci√≥n aleatoria
function vary(base, range){ return base + (Math.random() - 0.5) * range * 2; }
function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

// ===== SISTEMA DE SONIDOS MUSICALES PROGRESIVOS =====

// Escalas para los sonidos de interacci√≥n (pentat√≥nica para que siempre suene bien)
const interactionScales = [
  [262, 294, 330, 392, 440, 523, 587, 659, 784, 880, 1047], // Do Mayor Pentat√≥nica extendida
  [294, 330, 370, 440, 494, 587, 659, 740, 880, 988, 1175], // Re Mayor
  [330, 370, 415, 494, 554, 659, 740, 830, 988, 1108, 1318], // Mi Mayor
  [349, 392, 440, 523, 587, 698, 784, 880, 1047, 1175, 1397], // Fa Mayor
  [392, 440, 494, 587, 659, 784, 880, 988, 1175, 1318, 1568], // Sol Mayor
];

let currentInteractionScale = null;
let pickNoteIndex = 0;
let dropNoteIndex = 0;
let lastInteractionTime = 0;
const INTERACTION_RESET_TIME = 3000; // Resetear despu√©s de 3 segundos sin interacci√≥n

function getInteractionScale(){
  const now = Date.now();
  // Si pas√≥ mucho tiempo, elegir nueva escala y resetear √≠ndices
  if(now - lastInteractionTime > INTERACTION_RESET_TIME || !currentInteractionScale){
    currentInteractionScale = pick(interactionScales);
    pickNoteIndex = 0;
    dropNoteIndex = currentInteractionScale.length - 1;
  }
  lastInteractionTime = now;
  return currentInteractionScale;
}

// Click/Agarrar - ASCENDENTE (sube la escala cada vez que agarras)
function sndClick(){
  const scale = getInteractionScale();
  const note = scale[pickNoteIndex % scale.length];
  const nextNote = scale[(pickNoteIndex + 2) % scale.length]; // Tercera arriba

  // Sonido de "pick up" ascendente
  playTone(note, 0.06, 'sine', 0.1);
  setTimeout(() => playTone(nextNote, 0.05, 'sine', 0.08), 25);

  // Peque√±o brillo
  setTimeout(() => playTone(note * 2, 0.03, 'triangle', 0.04), 40);

  pickNoteIndex++;
  // Mantener dropNoteIndex sincronizado para que el drop sea descendente desde arriba
  dropNoteIndex = Math.max(dropNoteIndex, pickNoteIndex);
}

// Soltar/Drop - DESCENDENTE (baja la escala, sonido satisfactorio de "plop")
function sndDrop(){
  const scale = getInteractionScale();

  // Usar nota alta y bajar
  const highNote = scale[Math.min(dropNoteIndex, scale.length - 1)];
  const midNote = scale[Math.max(0, Math.min(dropNoteIndex - 2, scale.length - 1))];
  const lowNote = scale[Math.max(0, Math.min(dropNoteIndex - 4, scale.length - 1))];

  // Sonido descendente satisfactorio "plop"
  playTone(highNote, 0.07, 'sine', 0.11);
  setTimeout(() => playTone(midNote, 0.09, 'sine', 0.1), 35);
  setTimeout(() => playTone(lowNote, 0.12, 'triangle', 0.08), 75);

  // Resonancia grave satisfactoria
  setTimeout(() => playTone(lowNote * 0.5, 0.15, 'sine', 0.05), 90);

  dropNoteIndex = Math.max(0, dropNoteIndex - 1);
}

// Mover/colocar entre zonas - nota media estable
function sndPlace(){
  const scale = getInteractionScale();
  const midIndex = Math.floor(scale.length / 2);
  const note = scale[midIndex];
  const harmonic = scale[midIndex + 2] || scale[midIndex];

  playTone(note, 0.06, 'sine', 0.09);
  setTimeout(() => playTone(harmonic, 0.05, 'triangle', 0.07), 30);
}

// Basura - sonido descendente dram√°tico (whoosh hacia abajo)
function sndTrash(){
  const scale = getInteractionScale();
  // Descenso r√°pido desde nota alta a muy baja
  const startNote = scale[scale.length - 1];
  const midNote = scale[Math.floor(scale.length / 2)];
  const endNote = scale[0] * 0.5; // Octava abajo del inicio

  playTone(startNote, 0.06, 'triangle', 0.06);
  setTimeout(() => playTone(midNote, 0.08, 'sawtooth', 0.04), 40);
  setTimeout(() => playTone(endNote, 0.15, 'triangle', 0.03), 85);
  setTimeout(() => playTone(endNote * 0.5, 0.2, 'sine', 0.02), 120);

  // Resetear los √≠ndices un poco para dar sensaci√≥n de "quitar"
  dropNoteIndex = Math.min(scale.length - 1, dropNoteIndex + 2);
}

// Correcto - acordes alegres variados
const correctStyles = [
  () => { [523,659,784,1047].forEach((f,i)=>setTimeout(()=>playTone(vary(f,20),.18,'sine',.14),i*75)); setTimeout(()=>playTone(vary(1318,50),.25,'sine',.1),330); },
  () => { [494,622,740,988].forEach((f,i)=>setTimeout(()=>playTone(vary(f,20),.16,'sine',.13),i*70)); setTimeout(()=>playTone(vary(1244,50),.22,'triangle',.09),300); },
  () => { [440,554,659,880].forEach((f,i)=>setTimeout(()=>playTone(vary(f,15),.17,'sine',.14),i*65)); setTimeout(()=>playTone(vary(1108,40),.24,'sine',.1),280); },
  () => { [392,494,587,784].forEach((f,i)=>setTimeout(()=>playTone(vary(f,18),.19,'triangle',.12),i*80)); setTimeout(()=>playTone(vary(988,45),.26,'sine',.09),350); },
  () => { [349,440,523,698].forEach((f,i)=>setTimeout(()=>playTone(vary(f,15),.18,'sine',.13),i*72)); setTimeout(()=>playTone(vary(880,40),.24,'sine',.1),310); }
];
function sndCorrect(){ pick(correctStyles)(); }

// Incorrecto - sonidos suaves de error
const wrongStyles = [
  () => { playTone(vary(200,30),.14,'sawtooth',.05); setTimeout(()=>playTone(vary(170,25),.16,'sawtooth',.04),90); },
  () => { playTone(vary(180,25),.15,'triangle',.06); playTone(vary(150,20),.18,'sawtooth',.04); },
  () => { [vary(220,30),vary(180,25)].forEach((f,i)=>setTimeout(()=>playTone(f,.13,'sawtooth',.05),i*80)); },
  () => { playTone(vary(250,35),.12,'sawtooth',.05); setTimeout(()=>playTone(vary(190,25),.15,'triangle',.04),70); setTimeout(()=>playTone(vary(150,20),.18,'sawtooth',.03),130); }
];
function sndWrong(){ pick(wrongStyles)(); }

// Nuevo paso - fanfarrias variadas
const newStepStyles = [
  () => { [392,523,659].forEach((f,i)=>setTimeout(()=>playTone(vary(f,15),.12,'triangle',.1),i*55)); },
  () => { [440,554,698].forEach((f,i)=>setTimeout(()=>playTone(vary(f,15),.11,'sine',.1),i*50)); },
  () => { [349,466,587].forEach((f,i)=>setTimeout(()=>playTone(vary(f,12),.13,'triangle',.09),i*60)); },
  () => { [330,440,554].forEach((f,i)=>setTimeout(()=>playTone(vary(f,10),.12,'sine',.1),i*52)); },
  () => { [294,392,494].forEach((f,i)=>setTimeout(()=>playTone(vary(f,12),.14,'triangle',.09),i*58)); }
];
function sndNewStep(){ pick(newStepStyles)(); }

// Victoria - celebraci√≥n √©pica con variaciones
const victoryStyles = [
  () => { [523,659,784,880,1047,1318].forEach((f,i)=>setTimeout(()=>playTone(vary(f,15),.22,'sine',.12),i*95)); setTimeout(()=>{[1047,1318,1568].forEach((f,i)=>setTimeout(()=>playTone(vary(f,20),.3,'sine',.08),i*75));},680); },
  () => { [494,622,740,880,988,1244].forEach((f,i)=>setTimeout(()=>playTone(vary(f,15),.2,'sine',.11),i*90)); setTimeout(()=>{[988,1244,1480].forEach((f,i)=>setTimeout(()=>playTone(vary(f,18),.28,'triangle',.07),i*70));},650); },
  () => { [440,554,659,784,880,1108].forEach((f,i)=>setTimeout(()=>playTone(vary(f,12),.21,'sine',.12),i*88)); setTimeout(()=>{[880,1108,1318].forEach((f,i)=>setTimeout(()=>playTone(vary(f,15),.32,'sine',.08),i*78));},630); }
];
function sndVictory(){ pick(victoryStyles)(); }

// Pista/hint - sonidos curiosos
const hintStyles = [
  () => { playTone(vary(500,60),.1,'triangle',.08); setTimeout(()=>playTone(vary(700,80),.12,'triangle',.07),75); },
  () => { playTone(vary(450,50),.11,'sine',.08); setTimeout(()=>playTone(vary(650,70),.1,'triangle',.07),70); },
  () => { [vary(480,50),vary(680,70)].forEach((f,i)=>setTimeout(()=>playTone(f,.1,'triangle',.08),i*65)); }
];
function sndHint(){ pick(hintStyles)(); }

// Estrella - brillos m√°gicos
const starStyles = [
  () => { [800,1000,1200].forEach((f,i)=>setTimeout(()=>playTone(vary(f,50),.1,'sine',.08),i*45)); },
  () => { [900,1100,1350].forEach((f,i)=>setTimeout(()=>playTone(vary(f,60),.09,'triangle',.07),i*42)); },
  () => { [750,950,1150,1400].forEach((f,i)=>setTimeout(()=>playTone(vary(f,55),.08,'sine',.07),i*38)); },
  () => { [850,1050,1300].forEach((f,i)=>setTimeout(()=>playTone(vary(f,45),.11,'sine',.08),i*48)); }
];
function sndStar(){ pick(starStyles)(); }

// Pop - burbujas variadas
const popStyles = [
  () => { playTone(vary(1200,150),.05,'sine',.1); setTimeout(()=>playTone(vary(800,100),.07,'triangle',.08),20); },
  () => { playTone(vary(1100,120),.055,'triangle',.09); playTone(vary(750,90),.075,'sine',.08); },
  () => { playTone(vary(1300,140),.045,'sine',.1); setTimeout(()=>playTone(vary(900,110),.065,'sine',.07),18); },
  () => { playTone(vary(1000,100),.06,'sine',.1); playTone(vary(700,80),.08,'triangle',.08); },
  () => { [vary(1150,130),vary(850,100)].forEach((f,i)=>setTimeout(()=>playTone(f,.055,'sine',.09),i*22)); }
];
function sndPop(){ pick(popStyles)(); }

// Borrar - whoosh suave
function sndErase(){ playTone(vary(400,50),.08,'triangle',.07); playTone(vary(300,40),.1,'triangle',.06); }

// ========== CONFETTI & EFFECTS ==========
function spawnConfetti(count=30){
  const c = document.createElement('div');
  c.className = 'confetti-container';
  document.body.appendChild(c);
  const colors = ['#00d68f','#38bdf8','#ff9f43','#ff6b9d','#ffd43b','#a78bfa'];
  const shapes = ['50%', '2px', '0'];
  for(let i=0;i<count;i++){
    const p = document.createElement('div');
    p.className = 'confetti-piece';
    p.style.left = Math.random()*100+'%';
    p.style.background = colors[i%colors.length];
    p.style.borderRadius = shapes[Math.floor(Math.random()*shapes.length)];
    p.style.width = (6 + Math.random()*6)+'px';
    p.style.height = (6 + Math.random()*6)+'px';
    p.style.animationDuration = (1.5+Math.random()*2)+'s';
    p.style.animationDelay = Math.random()*.5+'s';
    c.appendChild(p);
  }
  setTimeout(()=>c.remove(), 4000);
}

function spawnStars(count=5){
  const c = document.createElement('div');
  c.className = 'confetti-container';
  document.body.appendChild(c);
  for(let i=0;i<count;i++){
    const s = document.createElement('div');
    s.textContent = '‚≠ê';
    s.style.position = 'absolute';
    s.style.left = (20 + Math.random()*60)+'%';
    s.style.fontSize = (1.5 + Math.random())+'rem';
    s.style.animation = `confettiFall ${1.5+Math.random()}s linear forwards`;
    s.style.animationDelay = Math.random()*.3+'s';
    c.appendChild(s);
    sndStar();
  }
  setTimeout(()=>c.remove(), 3000);
}

function pulseElement(el){
  el.style.animation = 'none';
  el.offsetHeight; // Trigger reflow
  el.style.animation = 'successBurst .4s ease';
}

// ========== ENCOURAGEMENTS ==========
const ENCOURAGEMENTS = [
  "¬°T√∫ puedes! üí™",
  "¬°Sigue intentando! üåü",
  "¬°Casi lo tienes! ‚ú®",
  "¬°No te rindas! üöÄ",
  "¬°Piensa un poco m√°s! ü§î",
  "¬°Vas muy bien! üëè"
];

// ========== STORIES ==========
const STORIES = [
  {
    title: "La Granja de Lucas", avatar: "üßë‚Äçüåæ", character: "Lucas",
    steps: [
      { op: 'suma', template: 'Imagina que est√°s en una granja con mucho sol y olor a pasto. {char} est√° en su corral con {a} gallinas picoteando el suelo. De pronto, por el camino de tierra, llegan caminando {b} gallinas que se hab√≠an escapado al campo. Las gallinas se meten al corral con las otras.', question: '¬øCu√°ntas gallinas hay ahora en el corral?', successMsg: '¬°{ans} gallinas!', emoji: 'üêî', emojiB: 'üêî' },
      { op: 'multi', template: 'Ahora {char} entra al gallinero a recoger huevos. Tiene {a} gallinas, y cada una puso {b} huevos en su nido esta ma√±ana. Va a necesitar una canasta grande para llevar todos los huevos a la cocina.', question: '¬øCu√°ntos huevos tiene que recoger {char} en total?', successMsg: '¬°{ans} huevos!', emoji: 'ü•ö', groupEmoji: 'üêî' },
      { op: 'resta', template: '{char} guarda los huevos en la cocina. Ten√≠a {a} huevos en la canasta, pero llega un vecino y le compra {b} huevos. Se los entrega y se despide con una sonrisa.', question: '¬øCu√°ntos huevos le quedan a {char} en la canasta?', successMsg: '¬°{ans} huevos!', emoji: 'ü•ö', emojiB: 'ü•ö' },
      { op: 'divi', template: 'Al final del d√≠a, {char} recoge {a} manzanas del huerto. Quiere repartirlas en partes iguales entre sus {b} caballos para que cada uno coma lo mismo.', question: '¬øCu√°ntas manzanas le tocan a cada caballo?', successMsg: '¬°{ans} manzanas!', emoji: 'üçé', groupEmoji: 'üê¥' }
    ]
  },
  {
    title: "La Pasteler√≠a M√°gica", avatar: "üë®‚Äçüç≥", character: "Mar√≠a",
    steps: [
      { op: 'suma', template: 'Imagina una pasteler√≠a que huele a chocolate caliente. {char}, la chef pastelera, se levant√≥ temprano y horne√≥ {a} cupcakes de chocolate. Le quedaron tan bonitos que decidi√≥ hacer {b} cupcakes de fresa tambi√©n. Ahora la mesa est√° llena de cupcakes de los dos sabores.', question: '¬øCu√°ntos cupcakes hay en la mesa?', successMsg: '¬°{ans} cupcakes!', emoji: 'üßÅ', emojiB: 'üßÅ' },
      { op: 'resta', template: 'La vitrina de {char} brilla con {a} donas glaseadas. Llegan los primeros clientes del d√≠a y compran {b} donas. Ella las empaca con cuidado y se las entrega con una sonrisa.', question: '¬øCu√°ntas donas quedan en la vitrina?', successMsg: '¬°{ans} donas!', emoji: 'üç©', emojiB: 'üç©' },
      { op: 'multi', template: '{char} prepara {a} bandejas de brownies para un pedido especial. En cada bandeja acomoda {b} brownies perfectamente cortados. Todas las bandejas llevan la misma cantidad.', question: '¬øCu√°ntos brownies prepar√≥ {char} en total?', successMsg: '¬°{ans} brownies!', emoji: 'üç´', groupEmoji: 'üçΩÔ∏è' },
      { op: 'divi', template: '{char} horne√≥ {a} galletas de vainilla y quiere armar cajas de regalo. Tiene {b} cajas vac√≠as y quiere que cada caja lleve exactamente la misma cantidad de galletas, sin que sobre ninguna.', question: '¬øCu√°ntas galletas va a poner en cada caja?', successMsg: '¬°{ans} por caja!', emoji: 'üç™', groupEmoji: 'üì¶' }
    ]
  },
  {
    title: "El Tesoro Pirata", avatar: "üè¥‚Äç‚ò†Ô∏è", character: "el Capit√°n Pedro",
    steps: [
      { op: 'suma', template: 'Imagina que est√°s en una isla misteriosa con palmeras y arena dorada. {char} entra a una cueva oscura y encuentra {a} monedas de oro escondidas detr√°s de una roca. Emocionado, corre a otra cueva cercana y encuentra {b} monedas m√°s entre las piedras. Ahora quiere juntar todo su bot√≠n.', question: '¬øCu√°ntas monedas de oro encontr√≥ en total?', successMsg: '¬°{ans} monedas!', emoji: 'ü™ô', emojiB: 'ü™ô' },
      { op: 'multi', template: '{char} sube al barco y abre la bodega. Ah√≠ tiene {a} cofres viejos con candado. Los abre uno por uno y descubre que cada cofre tiene {b} diamantes adentro. Todos los cofres guardan la misma cantidad.', question: '¬øCu√°ntos diamantes tiene contando los de todos los cofres?', successMsg: '¬°{ans} diamantes!', emoji: 'üíé', groupEmoji: 'üì¶' },
      { op: 'resta', template: '{char} re√∫ne a su tripulaci√≥n en la cubierta del barco. Tiene {a} joyas brillantes y decide regalarle {b} joyas a sus marineros como premio por el viaje. Los marineros las reciben content√≠simos.', question: '¬øCu√°ntas joyas le quedan al Capit√°n?', successMsg: '¬°{ans} joyas!', emoji: 'üíé', emojiB: 'üíé' },
      { op: 'divi', template: '{char} encuentra {a} perlas en una ostra gigante. Quiere repartirlas entre sus {b} marineros m√°s valientes para que cada uno reciba la misma cantidad.', question: '¬øCu√°ntas perlas le tocan a cada marinero?', successMsg: '¬°{ans} perlas!', emoji: 'ü´ß', groupEmoji: 'üßë‚Äç‚úàÔ∏è' }
    ]
  },
  {
    title: "La Fiesta de Cumplea√±os", avatar: "üéÇ", character: "Carlos",
    steps: [
      { op: 'suma', template: 'Imagina una casa decorada con serpentinas y m√∫sica. {char} est√° preparando su fiesta de cumplea√±os. Infl√≥ {a} globos rojos y los amarr√≥ en la sala. Su mam√° lo ayud√≥ e infl√≥ {b} globos azules que puso en el comedor. La casa se llen√≥ de color.', question: '¬øCu√°ntos globos hay en la casa entre los dos?', successMsg: '¬°{ans} globos!', emoji: 'üéà', emojiB: 'üéà' },
      { op: 'multi', template: '{char} prepar√≥ {a} bolsas de sorpresas para sus invitados. En cada bolsa meti√≥ {b} juguetitos peque√±os. Todas las bolsas tienen lo mismo.', question: '¬øCu√°ntos juguetitos necesit√≥ {char} en total?', successMsg: '¬°{ans} juguetitos!', emoji: 'üéÅ', groupEmoji: 'üõçÔ∏è' },
      { op: 'divi', template: 'Llegan los invitados y {char} saca una bolsa con {a} dulces. Mira a sus {b} amigos y quiere ser justo: todos deben recibir exactamente lo mismo, ni uno m√°s ni uno menos.', question: '¬øCu√°ntos dulces le tocan a cada amigo?', successMsg: '¬°{ans} dulces cada uno!', emoji: 'üç¨', groupEmoji: 'üë¶' },
      { op: 'resta', template: 'El pastel se ve delicioso. Lo cortaron en {a} rebanadas perfectas. Los invitados hambrientos se comieron {b} rebanadas. {char} mira el plato para ver cu√°ntas sobrevivieron.', question: '¬øCu√°ntas rebanadas de pastel quedaron?', successMsg: '¬°{ans} rebanadas!', emoji: 'üç∞', emojiB: 'üç∞' }
    ]
  },
  {
    title: "El Espacio Sideral", avatar: "üöÄ", character: "la Astronauta Ana",
    steps: [
      { op: 'multi', template: 'Imagina que flotas en el espacio dentro de un cohete plateado. {char} viaj√≥ a {a} planetas diferentes en su misi√≥n espacial. En la superficie de cada planeta recogi√≥ muestras y encontr√≥ {b} meteoritos brillantes. Lo curioso es que en todos los planetas encontr√≥ la misma cantidad.', question: '¬øCu√°ntos meteoritos recogi√≥ en toda su misi√≥n?', successMsg: '¬°{ans} meteoritos!', emoji: '‚òÑÔ∏è', groupEmoji: 'ü™ê' },
      { op: 'suma', template: 'Desde su nave, {char} mira por el telescopio. En una galaxia lejana descubre {a} estrellas que nadie hab√≠a visto. Apunta el telescopio hacia otra galaxia y descubre {b} estrellas nuevas tambi√©n. Quiere anotar todas sus estrellas en el reporte.', question: '¬øCu√°ntas estrellas descubri√≥ en total?', successMsg: '¬°{ans} estrellas!', emoji: '‚≠ê', emojiB: '‚≠ê' },
      { op: 'resta', template: 'De regreso a la Tierra, {char} revisa su colecci√≥n de {a} cristales espaciales. Pero durante una turbulencia, {b} cristales se cayeron por una compuerta y se perdieron en el espacio.', question: '¬øCu√°ntos cristales le quedan a Ana?', successMsg: '¬°{ans} cristales!', emoji: 'üíé', emojiB: 'üíé' },
      { op: 'divi', template: '{char} trae {a} muestras de roca lunar y debe enviarlas a {b} laboratorios de la Tierra. Cada laboratorio debe recibir exactamente la misma cantidad para analizarlas.', question: '¬øCu√°ntas muestras le tocan a cada laboratorio?', successMsg: '¬°{ans} muestras!', emoji: 'ü™®', groupEmoji: 'üî¨' }
    ]
  },
  {
    title: "El Gran Reparto de Pizza", avatar: "üçï", character: "Tony",
    steps: [
      { op: 'suma', template: 'Imagina una pizzer√≠a con un horno gigante de ladrillos. {char}, el mejor pizzero del barrio, trabaj√≥ toda la ma√±ana y sac√≥ del horno {a} pizzas humeantes. Por la tarde sigui√≥ cocinando y sac√≥ {b} pizzas m√°s. La cocina huele incre√≠ble.', question: '¬øCu√°ntas pizzas hizo en todo el d√≠a?', successMsg: '¬°{ans} pizzas!', emoji: 'üçï', emojiB: 'üçï' },
      { op: 'resta', template: '{char} ten√≠a {a} ingredientes frescos en la cocina. Durante el d√≠a us√≥ {b} ingredientes para preparar las √≥rdenes de los clientes.', question: '¬øCu√°ntos ingredientes le quedan a {char}?', successMsg: '¬°{ans} ingredientes!', emoji: 'üßÖ', emojiB: 'üßÖ' },
      { op: 'multi', template: 'Es hora de la cena y el restaurante est√° lleno. {char} mira el sal√≥n: hay {a} mesas ocupadas y en cada mesa est√°n sentados {b} clientes esperando su orden. Todas las mesas tienen la misma cantidad de personas.', question: '¬øCu√°ntos clientes hay en el restaurante?', successMsg: '¬°{ans} clientes!', emoji: 'üòä', groupEmoji: 'ü™ë' },
      { op: 'divi', template: 'Un grupo de {b} ni√±os entra corriendo al restaurante. {char} tiene {a} refrescos fr√≠os y quiere darle la misma cantidad a cada ni√±o para que nadie se queje.', question: '¬øCu√°ntos refrescos le tocan a cada ni√±o?', successMsg: '¬°{ans} refrescos!', emoji: 'ü•§', groupEmoji: 'üë¶' }
    ]
  },
  {
    title: "El Zool√≥gico Feliz", avatar: "ü¶Å", character: "Max",
    steps: [
      { op: 'divi', template: 'Imagina un zool√≥gico enorme con animales por todos lados. Es la hora de la comida y {char}, el cuidador, llega con un balde de {a} pescados frescos. Las {b} focas lo ven y empiezan a aplaudir con sus aletas. {char} sabe que debe darle a cada foca exactamente lo mismo o se ponen celosas.', question: '¬øCu√°ntos pescados le tocan a cada foca?', successMsg: '¬°{ans} pescados!', emoji: 'üêü', groupEmoji: 'ü¶≠' },
      { op: 'suma', template: 'Un cami√≥n llega al zool√≥gico con {a} conejos nuevos que rescataron de un parque. {char} los lleva a la jaula donde ya hab√≠a {b} conejos viviendo tranquilos. Los conejos nuevos entran y se juntan con los otros.', question: '¬øCu√°ntos conejos hay ahora en la jaula?', successMsg: '¬°{ans} conejos!', emoji: 'üê∞', emojiB: 'üê∞' },
      { op: 'resta', template: '{char} ten√≠a {a} bolsas de alimento en la bodega. Durante la semana us√≥ {b} bolsas para darle de comer a todos los animales.', question: '¬øCu√°ntas bolsas de alimento le quedan?', successMsg: '¬°{ans} bolsas!', emoji: 'üõçÔ∏è', emojiB: 'üõçÔ∏è' },
      { op: 'multi', template: 'Despu√©s, {char} camina hacia el aviario. Ah√≠ tiene {a} jaulas grandes, y cuando se asoma, ve que en cada jaula hay {b} p√°jaros cantando. Todas las jaulas tienen la misma cantidad de p√°jaros.', question: '¬øCu√°ntos p√°jaros hay en todo el aviario?', successMsg: '¬°{ans} p√°jaros!', emoji: 'üê¶', groupEmoji: 'üè†' }
    ]
  },
  {
    title: "La Escuelita de Arte", avatar: "üé®", character: "la Maestra Luna",
    steps: [
      { op: 'suma', template: 'Imagina un sal√≥n de arte lleno de pinturas y colores. {char} ten√≠a {a} hojas de papel en el estante. Lleg√≥ el director y le trajo {b} hojas m√°s para la clase de hoy.', question: '¬øCu√°ntas hojas tiene ahora {char}?', successMsg: '¬°{ans} hojas!', emoji: 'üìÑ', emojiB: 'üìÑ' },
      { op: 'multi', template: '{char} est√° preparando la clase. Tiene {a} mesas y en cada mesa coloca {b} crayones para que los ni√±os puedan dibujar. En todas las mesas pone exactamente lo mismo.', question: '¬øCu√°ntos crayones necesita en total?', successMsg: '¬°{ans} crayones!', emoji: 'üñçÔ∏è', groupEmoji: 'ü™ë' },
      { op: 'resta', template: 'Durante la clase, los ni√±os pintaron con mucha energ√≠a. {char} ten√≠a {a} pinceles al inicio, pero {b} se da√±aron porque los ni√±os apretaron muy fuerte. Ya no sirven.', question: '¬øCu√°ntos pinceles buenos le quedan?', successMsg: '¬°{ans} pinceles!', emoji: 'üñåÔ∏è', emojiB: 'üñåÔ∏è' },
      { op: 'divi', template: 'Al final de la clase, {char} saca una bolsa con {a} stickers de estrella como premio. Los {b} estudiantes la miran con ojos brillantes. Quiere que todos reciban exactamente lo mismo.', question: '¬øCu√°ntos stickers le tocan a cada estudiante?', successMsg: '¬°{ans} stickers!', emoji: '‚≠ê', groupEmoji: 'üëß' }
    ]
  },
  {
    title: "El Huerto M√°gico", avatar: "üåª", character: "Lily",
    steps: [
      { op: 'suma', template: 'Imagina un huerto con tierra h√∫meda y mariposas volando. {char}, la jardinera, camina entre las plantas y cosecha {a} tomates rojos de un lado. Luego cruza al otro lado del huerto y cosecha {b} tomates m√°s que estaban maduros. Los pone todos en la misma canasta.', question: '¬øCu√°ntos tomates tiene en su canasta?', successMsg: '¬°{ans} tomates!', emoji: 'üçÖ', emojiB: 'üçÖ' },
      { op: 'resta', template: '{char} tiene una canasta con {a} zanahorias naranjas y bonitas. Llega un vecino y le compra {b} zanahorias. Se las da y guarda el dinero en su bolsillo.', question: '¬øCu√°ntas zanahorias le quedan en la canasta?', successMsg: '¬°{ans} zanahorias!', emoji: 'ü•ï', emojiB: 'ü•ï' },
      { op: 'multi', template: '{char} mira su huerto con orgullo. Tiene {a} surcos largos de tierra, y en cada surco plant√≥ {b} lechugas verdes en fila. Cada surco tiene exactamente la misma cantidad.', question: '¬øCu√°ntas lechugas hay en todo el huerto?', successMsg: '¬°{ans} lechugas!', emoji: 'ü•¨', groupEmoji: 'üå±' },
      { op: 'divi', template: '{char} cosech√≥ {a} fresas maduras y quiere llenar {b} canastitas para vender en el mercado. Cada canastita debe llevar la misma cantidad.', question: '¬øCu√°ntas fresas van en cada canastita?', successMsg: '¬°{ans} fresas!', emoji: 'üçì', groupEmoji: 'üß∫' }
    ]
  },
  {
    title: "La Tienda de Mascotas", avatar: "üêæ", character: "Ana",
    steps: [
      { op: 'divi', template: 'Imagina una tienda de mascotas con ladridos y maullidos. {char}, la veterinaria, abre una caja con {a} premios de hueso. Los {b} perritos de la tienda mueven la cola emocionados. Sabe que debe darle a cada perrito exactamente lo mismo o empiezan a pelear.', question: '¬øCu√°ntos premios le tocan a cada perrito?', successMsg: '¬°{ans} premios!', emoji: 'ü¶¥', groupEmoji: 'üêï' },
      { op: 'suma', template: 'Una camioneta se estaciona frente a la tienda. Traen {a} gatitos que encontraron en la calle. {char} los lleva adentro donde ya hab√≠a {b} gatitos esperando ser adoptados. Todos los gatitos se juntan en el mismo espacio.', question: '¬øCu√°ntos gatitos hay ahora en la tienda?', successMsg: '¬°{ans} gatitos!', emoji: 'üê±', emojiB: 'üê±' },
      { op: 'multi', template: '{char} acomoda las peceras de la tienda. Tiene {a} peceras y en cada pecera nadan {b} peces de colores. Todas tienen la misma cantidad.', question: '¬øCu√°ntos peces hay en la tienda?', successMsg: '¬°{ans} peces!', emoji: 'üê†', groupEmoji: 'üè†' },
      { op: 'resta', template: 'Es un buen d√≠a de ventas. {char} ten√≠a {a} h√°msters en las jaulas. Llegaron varias familias durante el d√≠a y compraron {b} h√°msters para llevar a casa.', question: '¬øCu√°ntos h√°msters quedan en la tienda?', successMsg: '¬°{ans} h√°msters!', emoji: 'üêπ', emojiB: 'üêπ' }
    ]
  },
  {
    title: "El Mercado de Frutas", avatar: "üçä", character: "Don Pancho",
    steps: [
      { op: 'suma', template: 'Imagina un mercado ruidoso con colores por todos lados. {char}, el frutero del barrio, abre su puesto y acomoda sus {a} naranjas en la mesa. Pero no son suficientes, as√≠ que va corriendo al mayorista y compra {b} naranjas m√°s. Regresa y las pone junto a las que ya ten√≠a.', question: '¬øCu√°ntas naranjas tiene ahora en su puesto?', successMsg: '¬°{ans} naranjas!', emoji: 'üçä', emojiB: 'üçä' },
      { op: 'multi', template: '{char} recibe una entrega grande. Le trajeron {a} cajas de mangos y cada caja trae {b} mangos adentro. Todas las cajas traen lo mismo.', question: '¬øCu√°ntos mangos recibi√≥ {char} en total?', successMsg: '¬°{ans} mangos!', emoji: 'ü•≠', groupEmoji: 'üì¶' },
      { op: 'resta', template: '{char} tiene {a} manzanas rojas y brillantes en su canasta. A lo largo de la ma√±ana, los clientes se acercan y le compran {b} manzanas.', question: '¬øCu√°ntas manzanas le quedan?', successMsg: '¬°{ans} manzanas!', emoji: 'üçé', emojiB: 'üçé' },
      { op: 'divi', template: 'Al final del d√≠a, a {char} le quedan {a} pl√°tanos maduros. Llegan {b} clientes al mismo tiempo y todos quieren pl√°tanos. Decide darle a cada uno exactamente la misma cantidad para que sea justo.', question: '¬øCu√°ntos pl√°tanos le tocan a cada cliente?', successMsg: '¬°{ans} pl√°tanos!', emoji: 'üçå', groupEmoji: 'üßë' }
    ]
  },
  {
    title: "La F√°brica de Juguetes", avatar: "üè≠", character: "el Jefe de los Elfos",
    steps: [
      { op: 'suma', template: 'Imagina una f√°brica m√°gica donde los elfos trabajan sin parar. {char} cuenta los robots que armaron: ya hab√≠a {a} robots en la l√≠nea de producci√≥n. Los elfos del turno de la tarde armaron {b} robots m√°s.', question: '¬øCu√°ntos robots hay ahora en total?', successMsg: '¬°{ans} robots!', emoji: 'ü§ñ', emojiB: 'ü§ñ' },
      { op: 'multi', template: '{char} revisa la producci√≥n del d√≠a: los elfos armaron {a} cajas grandes. Abre una para verificar y cuenta {b} mu√±ecos de peluche adentro. Revisa las dem√°s y todas tienen exactamente lo mismo.', question: '¬øCu√°ntos mu√±ecos fabricaron en total?', successMsg: '¬°{ans} mu√±ecos!', emoji: 'üß∏', groupEmoji: 'üì¶' },
      { op: 'resta', template: 'En la bodega hay {a} pelotas de f√∫tbol listas para enviar. Llega un cami√≥n de una jugueter√≠a y se lleva {b} pelotas. Los elfos las cargan al cami√≥n y el cami√≥n se va.', question: '¬øCu√°ntas pelotas quedan en la bodega?', successMsg: '¬°{ans} pelotas!', emoji: '‚öΩ', emojiB: '‚öΩ' },
      { op: 'divi', template: '{char} tiene {a} rompecabezas empacados y listos. Necesita enviarlos a {b} tiendas distintas, y cada tienda debe recibir exactamente la misma cantidad.', question: '¬øCu√°ntos rompecabezas va a enviar a cada tienda?', successMsg: '¬°{ans} rompecabezas!', emoji: 'üß©', groupEmoji: 'üè™' }
    ]
  },
  {
    title: "El Campamento Aventura", avatar: "‚õ∫", character: "Tom√°s",
    steps: [
      { op: 'suma', template: 'Imagina un bosque con √°rboles enormes y el sonido de un r√≠o. {char}, el gu√≠a del campamento, est√° preparando todo para la noche. Revisa la bodega y encuentra {a} linternas. Luego busca en el almac√©n del fondo y aparecen {b} linternas m√°s que hab√≠an guardado el a√±o pasado.', question: '¬øCu√°ntas linternas tiene para el campamento?', successMsg: '¬°{ans} linternas!', emoji: 'üî¶', emojiB: 'üî¶' },
      { op: 'resta', template: '{char} llev√≥ {a} botellas de agua para la excursi√≥n. Los exploradores se fueron tomando el agua durante la caminata y se acabaron {b} botellas.', question: '¬øCu√°ntas botellas de agua quedan?', successMsg: '¬°{ans} botellas!', emoji: 'üíß', emojiB: 'üíß' },
      { op: 'multi', template: 'Ya est√° oscureciendo y {char} termina de armar {a} carpas en el claro del bosque. Los exploradores se organizan y en cada carpa entran {b} personas con sus sleeping bags. Todas las carpas tienen la misma cantidad de exploradores.', question: '¬øCu√°ntos exploradores hay en el campamento?', successMsg: '¬°{ans} exploradores!', emoji: 'üßë‚Äçü§ù‚Äçüßë', groupEmoji: '‚õ∫' },
      { op: 'divi', template: 'Antes de dormir, {char} enciende la fogata. Saca una bolsa con {a} malvaviscos y mira a los {b} ni√±os sentados alrededor del fuego. Quiere que cada ni√±o ase exactamente la misma cantidad.', question: '¬øCu√°ntos malvaviscos le tocan a cada ni√±o?', successMsg: '¬°{ans} malvaviscos!', emoji: 'üç°', groupEmoji: 'üë¶' }
    ]
  },
  {
    title: "La Panader√≠a del Pueblo", avatar: "ü•ñ", character: "Don Juan",
    steps: [
      { op: 'suma', template: 'Por la ma√±ana, {char} prepar√≥ {a} croissants con mantequilla. Se vendieron tan r√°pido que por la tarde decidi√≥ hornear {b} croissants m√°s para los clientes que vendr√°n despu√©s.', question: '¬øCu√°ntos croissants hizo en total entre ma√±ana y tarde?', successMsg: '¬°{ans} croissants!', emoji: 'ü•ê', emojiB: 'ü•ê' },
      { op: 'multi', template: 'Imagina una panader√≠a calientita con olor a pan reci√©n hecho. {char}, el panadero del pueblo, estuvo toda la ma√±ana frente al horno. Meti√≥ {a} tandas de pan, y cada tanda tra√≠a {b} panes doraditos. Todas las tandas eran del mismo tama√±o.', question: '¬øCu√°ntos panes horne√≥ en total?', successMsg: '¬°{ans} panes!', emoji: 'üçû', groupEmoji: 'üî•' },
      { op: 'resta', template: '{char} acomoda {a} donas con glaseado en la vitrina del mostrador. Los clientes empiezan a llegar y durante la ma√±ana se venden {b} donas. La vitrina se va vaciando poco a poco.', question: '¬øCu√°ntas donas quedan en la vitrina?', successMsg: '¬°{ans} donas!', emoji: 'üç©', emojiB: 'üç©' },
      { op: 'divi', template: '{char} horne√≥ {a} conchas y quiere armar charolas para {b} cafeter√≠as del pueblo. Cada charola debe llevar la misma cantidad de conchas.', question: '¬øCu√°ntas conchas van en cada charola?', successMsg: '¬°{ans} conchas!', emoji: 'ü•ê', groupEmoji: '‚òï' }
    ]
  },
  {
    title: "El D√≠a de Campo", avatar: "üß∫", character: "la Familia Garc√≠a",
    steps: [
      { op: 'suma', template: 'Imagina un parque verde con √°rboles y un lago. {char} se fue de d√≠a de campo. Mam√° prepar√≥ {a} s√°ndwiches de jam√≥n y pap√° hizo {b} s√°ndwiches de queso. Los guardaron todos juntos en la misma canasta grande.', question: '¬øCu√°ntos s√°ndwiches llevan en la canasta?', successMsg: '¬°{ans} s√°ndwiches!', emoji: 'ü•™', emojiB: 'ü•™' },
      { op: 'multi', template: 'Los ni√±os juegan a atrapar mariposas. Encontraron {a} arbustos con flores y en cada arbusto hab√≠a {b} mariposas revoloteando. Todos los arbustos ten√≠an la misma cantidad.', question: '¬øCu√°ntas mariposas vieron en total?', successMsg: '¬°{ans} mariposas!', emoji: 'ü¶ã', groupEmoji: 'üå∫' },
      { op: 'resta', template: 'Hace calor y la hielera tiene {a} jugos bien fr√≠os. Durante el paseo por el parque, la familia se va tomando los jugos poco a poco y se acaban {b}.', question: '¬øCu√°ntos jugos quedan en la hielera?', successMsg: '¬°{ans} jugos!', emoji: 'üßÉ', emojiB: 'üßÉ' },
      { op: 'divi', template: 'Despu√©s de jugar, sacan {a} galletas de postre. Los {b} ni√±os de la familia se sientan en c√≠rculo y quieren que cada quien reciba exactamente lo mismo, sin pelear.', question: '¬øCu√°ntas galletas le tocan a cada ni√±o?', successMsg: '¬°{ans} galletas!', emoji: 'üç™', groupEmoji: 'üëß' }
    ]
  },
  {
    title: "La Biblioteca M√°gica", avatar: "üìö", character: "Sara",
    steps: [
      { op: 'suma', template: 'Imagina una biblioteca enorme con estantes hasta el techo. {char}, la bibliotecaria, recibe un paquete con {a} libros nuevos que compraron para la colecci√≥n. Al rato, llega una se√±ora de la comunidad que dona {b} libros m√°s. {char} los pone todos juntos en la mesa para catalogarlos.', question: '¬øCu√°ntos libros nuevos tiene que catalogar?', successMsg: '¬°{ans} libros!', emoji: 'üìï', emojiB: 'üìï' },
      { op: 'multi', template: '{char} camina entre los pasillos acomodando libros. Tiene {a} estantes y en cada estante coloc√≥ {b} libros, bien organizados por color. Todos los estantes tienen exactamente la misma cantidad.', question: '¬øCu√°ntos libros hay en esos estantes?', successMsg: '¬°{ans} libros!', emoji: 'üìï', groupEmoji: 'üìö' },
      { op: 'resta', template: 'En el escritorio de {char} hay {a} l√°pices de colores. Unos estudiantes le piden prestado material y ella les da {b} l√°pices. Los estudiantes se van a estudiar con sus l√°pices.', question: '¬øCu√°ntos l√°pices le quedan en el escritorio?', successMsg: '¬°{ans} l√°pices!', emoji: '‚úèÔ∏è', emojiB: '‚úèÔ∏è' },
      { op: 'divi', template: '{char} organiz√≥ una lectura grupal y tiene {a} marcap√°ginas para repartir entre {b} ni√±os que vinieron. Quiere que cada ni√±o reciba la misma cantidad.', question: '¬øCu√°ntos marcap√°ginas le tocan a cada ni√±o?', successMsg: '¬°{ans} marcap√°ginas!', emoji: 'üîñ', groupEmoji: 'üëß' }
    ]
  }
];

// ========== STATE ==========
let GRID_SIZE = 6;
let CELL_SIZE = 52;
let grid = [];
let currentStory = null;
let currentStep = 0;
let numA = 0, numB = 0, answer = 0;
let currentOp = 'suma';
let score = { adventures: 0, streak: 0, stars: 0 };

// ========== MODULE TRACKING ==========
let moduleTracker = {
  opsCompleted: new Set(),
  performance: {
    suma:  { quizErrors:0, quizCorrect:0, dragAttempts:0, hintsUsed:0, starsEarned:0, termsErrors:0, termsCorrect:0, stepCount:0, practiceErrors:0 },
    resta: { quizErrors:0, quizCorrect:0, dragAttempts:0, hintsUsed:0, starsEarned:0, termsErrors:0, termsCorrect:0, stepCount:0, practiceErrors:0 },
    multi: { quizErrors:0, quizCorrect:0, dragAttempts:0, hintsUsed:0, starsEarned:0, termsErrors:0, termsCorrect:0, stepCount:0, practiceErrors:0 },
    divi:  { quizErrors:0, quizCorrect:0, dragAttempts:0, hintsUsed:0, starsEarned:0, termsErrors:0, termsCorrect:0, stepCount:0, practiceErrors:0 }
  },
  totalDesafioCorrect: 0,
  totalDesafioTotal: 0,
  totalTriviaCorrect: 0,
  totalTriviaTotal: 0,
  adventuresInModule: 0
};

function resetModuleTracker(){
  moduleTracker = {
    opsCompleted: new Set(),
    performance: {
      suma:  { quizErrors:0, quizCorrect:0, dragAttempts:0, hintsUsed:0, starsEarned:0, termsErrors:0, termsCorrect:0, stepCount:0, practiceErrors:0 },
      resta: { quizErrors:0, quizCorrect:0, dragAttempts:0, hintsUsed:0, starsEarned:0, termsErrors:0, termsCorrect:0, stepCount:0, practiceErrors:0 },
      multi: { quizErrors:0, quizCorrect:0, dragAttempts:0, hintsUsed:0, starsEarned:0, termsErrors:0, termsCorrect:0, stepCount:0, practiceErrors:0 },
      divi:  { quizErrors:0, quizCorrect:0, dragAttempts:0, hintsUsed:0, starsEarned:0, termsErrors:0, termsCorrect:0, stepCount:0, practiceErrors:0 }
    },
    totalDesafioCorrect: 0,
    totalDesafioTotal: 0,
    totalTriviaCorrect: 0,
    totalTriviaTotal: 0,
    adventuresInModule: 0
  };
}

let hasChecked = false;
let attempts = 0;
let hintLevel = 0;
let maxHints = 3;

// Para el nuevo sistema de emojis
let currentEmoji = '';
let currentEmojiB = '';
let currentGroupEmoji = '';
let sourceItems = []; // Items disponibles para arrastrar {id, emoji, group}
let placedItems = []; // Items colocados en zonas {id, emoji, zone}
let previousAnswer = 0; // Para encadenar respuestas entre pasos
let itemIdCounter = 0;

const COLORS = [
  {name:'Verde', hex:'#00d68f'},
  {name:'Azul', hex:'#38bdf8'},
  {name:'Naranja', hex:'#ff9f43'},
  {name:'Rosa', hex:'#ff6b9d'},
];

const ZONE_COLORS = ['#00d68f', '#38bdf8', '#ff9f43', '#ff6b9d', '#a78bfa'];

const OPS = {
  suma: {label:'Suma', sym:'+'},
  resta: {label:'Resta', sym:'‚àí'},
  multi: {label:'Multi', sym:'√ó'},
  divi: {label:'Div', sym:'√∑'},
};

// ========== INIT ==========
function init(){
  try {
    calculateGridSize();
    window.addEventListener('resize', calculateGridSize);
    initGrid();
    renderScoreBar();

    // Personalizar t√≠tulo con el nombre del jugador
    document.querySelector('.header h1').innerHTML = `üß© MateBlocks <span style="font-size:0.7em;color:var(--cyan)">‚Äî ${PLAYER.name}</span>`;

    // Detectar si es m√≥vil/iOS que requiere interacci√≥n para audio
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if(isMobile){
      // En m√≥vil: mostrar bot√≥n de inicio para activar audio
      showStartButton();
    } else {
      // En PC: iniciar directamente
      startWithGreeting();
    }

    document.getElementById('soundToggle').addEventListener('click', ()=>{
      soundOn = !soundOn;
      document.getElementById('soundToggle').textContent = soundOn ? 'üîä' : 'üîá';
      if(soundOn) sndClick();
    });
  } catch(e) {
    console.error('Init error:', e);
    startNewAdventure();
  }
}

function showStartButton(){
  // Crear overlay de inicio para m√≥viles
  const overlay = document.createElement('div');
  overlay.id = 'startOverlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;';
  overlay.innerHTML = `
    <div style="text-align:center;padding:20px;">
      <div style="font-size:4rem;margin-bottom:20px;">üß©</div>
      <h1 style="color:var(--cyan);font-size:1.8rem;margin-bottom:10px;">MateBlocks</h1>
      <p style="color:var(--text);font-size:1rem;margin-bottom:30px;">¬°Aventuras matem√°ticas para ${PLAYER.name}!</p>
      <button id="startGameBtn" style="background:linear-gradient(135deg,var(--green),var(--cyan));color:#000;border:none;border-radius:16px;padding:20px 50px;font-size:1.3rem;font-weight:800;cursor:pointer;animation:pulse 1.5s ease infinite;">
        üéÆ ¬°EMPEZAR!
      </button>
    </div>
  `;
  document.body.appendChild(overlay);

  document.getElementById('startGameBtn').addEventListener('click', () => {
    // Inicializar audio con interacci√≥n del usuario (requerido en iOS)
    try {
      ensureAudio();
      if(actx && actx.state === 'suspended') actx.resume();
    } catch(e) { console.log('Audio init:', e); }

    // Remover overlay
    overlay.remove();

    // Iniciar con saludo
    startWithGreeting();
  });
}

function startWithGreeting(){
  const greetings = [
    `¬°Hola ${PLAYER.fullName}! ¬°Bienvenido a MateBlocks!`,
    `¬°${PLAYER.name}! ¬°Qu√© bueno verte! ¬°Vamos a aprender matem√°ticas!`,
    `¬°Hola ${PLAYER.nickname}! ¬°Prep√°rate para una aventura matem√°tica!`
  ];

  setTimeout(() => {
    speakText(greetings[Math.floor(Math.random() * greetings.length)], () => {
      startNewAdventure();
    }, { rate: 0.88, pitch: 1.0 });
  }, 300);
}

function calculateGridSize(){
  const availableHeight = window.innerHeight - 140;
  const availableWidth = window.innerWidth - 600;
  const maxSize = Math.min(availableHeight, availableWidth) - 40;
  CELL_SIZE = Math.floor(Math.max(36, Math.min(56, maxSize / GRID_SIZE)));
  document.documentElement.style.setProperty('--cell-size', CELL_SIZE + 'px');
}

function initGrid(){
  grid = Array.from({length:GRID_SIZE}, ()=> Array(GRID_SIZE).fill(null));
}

function clearWorkspace(){
  sourceItems = [];
  placedItems = [];
  itemIdCounter = 0;

  // Crear los items en el √°rea fuente seg√∫n la operaci√≥n
  if(currentOp === 'suma'){
    // Suma: dos grupos de objetos que hay que juntar
    for(let i = 0; i < numA; i++){
      sourceItems.push({id: itemIdCounter++, emoji: currentEmoji, group: 'A'});
    }
    for(let i = 0; i < numB; i++){
      sourceItems.push({id: itemIdCounter++, emoji: currentEmojiB, group: 'B'});
    }
  } else if(currentOp === 'resta'){
    // Resta: todos los objetos que tienes (numA), algunos deben irse
    for(let i = 0; i < numA; i++){
      sourceItems.push({id: itemIdCounter++, emoji: currentEmoji, group: 'main'});
    }
  } else if(currentOp === 'multi'){
    // Multiplicaci√≥n: numA * numB objetos para organizar en grupos
    for(let i = 0; i < answer; i++){
      sourceItems.push({id: itemIdCounter++, emoji: currentEmoji, group: 'main'});
    }
  } else if(currentOp === 'divi'){
    // Divisi√≥n: numA objetos para repartir
    for(let i = 0; i < numA; i++){
      sourceItems.push({id: itemIdCounter++, emoji: currentEmoji, group: 'main'});
    }
  }
}

function clearGrid(){
  initGrid();
  renderCounters();
  sndErase();
}

// ========== STORY ==========
function startNewAdventure(){
  const original = STORIES[Math.floor(Math.random() * STORIES.length)];
  // Mezclar el orden de los pasos para que no siempre empiece con la misma operaci√≥n
  currentStory = {
    ...original,
    steps: shuffleArray([...original.steps])
  };
  currentStep = 0;
  previousAnswer = 0;

  // Cargar el paso PRIMERO para que los datos est√©n listos
  loadCurrentStep();
}

// ========== STORY MODAL & QUIZ ==========
let quizCooldown = 0;
let quizCooldownInterval = null;
let quizWrongAttempts = 0;

// Guardar cuento original cuando se equivoca y debe practicar con otro
let originalStory = null;
let originalStep = 0;
let originalNumA = 0, originalNumB = 0, originalAnswer = 0;
let isPracticeRound = false;

// Cuentos cortos de pr√°ctica para cuando se equivoca (uno por operaci√≥n, variados)
const PRACTICE_STORIES = {
  suma: [
    { character: 'Pedro', avatar: 'üë¶', template: '{char} estaba jugando en el patio con {a} canicas azules. Su mejor amigo lleg√≥ corriendo y le regal√≥ {b} canicas rojas. Las junt√≥ todas en su bolsa.', question: '¬øCu√°ntas canicas tiene ahora en su bolsa?', emoji: 'üîµ', emojiB: 'üî¥' },
    { character: 'Sof√≠a', avatar: 'üëß', template: '{char} tiene un florero con {a} flores de colores. Sali√≥ al jard√≠n, cort√≥ {b} flores m√°s y las meti√≥ en el florero con las otras.', question: '¬øCu√°ntas flores hay ahora en el florero?', emoji: 'üå∏', emojiB: 'üå∫' },
    { character: 'Diego', avatar: 'üßí', template: '{char} colecciona estampas de animales. Ya ten√≠a {a} estampas en su √°lbum. Su amigo lleg√≥ y le regal√≥ {b} estampas nuevas que le sobraban.', question: '¬øCu√°ntas estampas tiene ahora en su √°lbum?', emoji: 'üìá', emojiB: 'üìá' },
    { character: 'Camila', avatar: 'üëß', template: '{char} estuvo toda la tarde haciendo figuras de plastilina. Primero arm√≥ {a} figuras de animales. Le gust√≥ tanto que sigui√≥ y arm√≥ {b} figuras m√°s de comida.', question: '¬øCu√°ntas figuras hizo en total?', emoji: 'üé®', emojiB: 'üé®' },
  ],
  resta: [
    { character: 'Miguel', avatar: 'üë¶', template: '{char} ten√≠a {a} chocolates guardados en su caj√≥n. Pero le dieron ganas de comer y se fue comiendo {b} chocolates mientras ve√≠a la tele.', question: '¬øCu√°ntos chocolates le quedan en el caj√≥n?', emoji: 'üç´', emojiB: 'üç´' },
    { character: 'Valentina', avatar: 'üëß', template: '{char} estaba caminando con {a} globos amarrados en su mano. De pronto, el viento sopl√≥ fuerte y se le reventaron {b} globos.', question: '¬øCu√°ntos globos le quedan en la mano?', emoji: 'üéà', emojiB: 'üéà' },
    { character: 'Mateo', avatar: 'üßí', template: '{char} ten√≠a {a} carritos de juguete en su cuarto. Su hermanito peque√±o entr√≥ y {char} le regal√≥ {b} carritos para que jugara.', question: '¬øCu√°ntos carritos le quedan a {char}?', emoji: 'üöó', emojiB: 'üöó' },
    { character: 'Isabella', avatar: 'üëß', template: '{char} llev√≥ {a} colores a la escuela en su estuche. Durante el recreo se le cayeron {b} colores y no los encontr√≥.', question: '¬øCu√°ntos colores le quedan en su estuche?', emoji: 'üñçÔ∏è', emojiB: 'üñçÔ∏è' },
  ],
  multi: [
    { character: 'Andr√©s', avatar: 'üë¶', template: '{char} fue a la dulcer√≠a y compr√≥ {a} bolsas de dulces. Cuando las abri√≥, vio que cada bolsa tra√≠a {b} dulces adentro. Todas tra√≠an lo mismo.', question: '¬øCu√°ntos dulces tiene en total?', emoji: 'üç¨', groupEmoji: 'üõçÔ∏è' },
    { character: 'Luc√≠a', avatar: 'üëß', template: '{char} recibi√≥ {a} cajas de colores para su cumplea√±os. Abri√≥ cada caja y encontr√≥ {b} colores dentro. Todas las cajas tra√≠an la misma cantidad.', question: '¬øCu√°ntos colores tiene en total?', emoji: 'üñçÔ∏è', groupEmoji: 'üì¶' },
    { character: 'Samuel', avatar: 'üßí', template: '{char} prepar√≥ la merienda. Sac√≥ {a} platos y en cada plato puso {b} galletas. Todos los platos quedaron iguales.', question: '¬øCu√°ntas galletas puso en total?', emoji: 'üç™', groupEmoji: 'üçΩÔ∏è' },
    { character: 'Mariana', avatar: 'üëß', template: 'En el sal√≥n de {char} hay {a} filas de sillas para un evento. Ella cuenta y cada fila tiene {b} sillas. Todas las filas son iguales.', question: '¬øCu√°ntas sillas hay en el sal√≥n?', emoji: 'ü™ë', groupEmoji: '‚û°Ô∏è' },
  ],
  divi: [
    { character: 'Tom√°s', avatar: 'üë¶', template: '{char} gan√≥ {a} stickers de estrella en un concurso. Quiere compartirlos con sus {b} amigos para que todos tengan lo mismo, sin que sobre ninguno.', question: '¬øCu√°ntos stickers le tocan a cada amigo?', emoji: '‚≠ê', groupEmoji: 'üë¶' },
    { character: 'Emma', avatar: 'üëß', template: '{char} compr√≥ {a} bombones para hacer bolsitas de regalo. Tiene {b} bolsitas vac√≠as y quiere que cada una lleve exactamente la misma cantidad.', question: '¬øCu√°ntos bombones van en cada bolsita?', emoji: 'üç¨', groupEmoji: 'üõçÔ∏è' },
    { character: 'Nicol√°s', avatar: 'üßí', template: 'La maestra le dio a {char} {a} crayones para que los reparta entre los {b} ni√±os de su mesa. Cada ni√±o debe recibir lo mismo.', question: '¬øCu√°ntos crayones le tocan a cada ni√±o?', emoji: 'üñçÔ∏è', groupEmoji: 'üëß' },
    { character: 'Paula', avatar: 'üëß', template: '{char} hizo {a} galletas para la cena. Saca {b} platos y quiere poner la misma cantidad en cada plato para que se vea bonito.', question: '¬øCu√°ntas galletas van en cada plato?', emoji: 'üç™', groupEmoji: 'üçΩÔ∏è' },
  ]
};

// Explicaciones habladas para cada operaci√≥n - VARIADAS para que no repita lo mismo
function getOperationExplanation(op){
  const explanations = {
    suma: [
      'juntar cosas, cuando llegan m√°s o agregas algo',
      'unir dos cantidades, cuando algo se suma a lo que ya ten√≠as',
      'cuando tienes algo y te dan m√°s, y ahora tienes m√°s que antes',
      'poner todo junto para saber el total'
    ],
    resta: [
      'quitar cosas, cuando algo se va, se vende o se pierde',
      'cuando ten√≠as algo y ahora tienes menos porque algo se fue',
      'separar una parte de lo que ten√≠as, te quedan menos',
      'cuando pierdes, regalas, vendes o se rompe algo y te quedan menos'
    ],
    multi: [
      'cuando tienes grupos iguales, como varias cajas con lo mismo adentro',
      'repetir una cantidad varias veces, como sumar lo mismo muchas veces',
      'cuando tienes varios grupos y todos tienen la misma cantidad',
      'contar cu√°nto hay en total cuando tienes varios grupos del mismo tama√±o'
    ],
    divi: [
      'repartir en partes iguales, como dividir entre varias personas',
      'cuando tienes algo y lo quieres separar en grupos iguales',
      'dar la misma cantidad a cada uno, que sea parejo para todos',
      'separar algo en partes del mismo tama√±o para que sea justo'
    ]
  };
  const arr = explanations[op] || [''];
  return arr[Math.floor(Math.random() * arr.length)];
}

// Explicaciones detalladas de POR QU√â NO es cierta operaci√≥n (variadas)
function getWrongExplanationDetail(wrongOp, correctOp, problemText){
  const wrongExplanations = {
    suma: [
      `La suma es cuando juntas cosas y tienes M√ÅS. Pero f√≠jate bien en el cuento, aqu√≠ no se est√° juntando nada.`,
      `Sumar es agregar, poner m√°s. Pero en este problema no est√°n llegando cosas nuevas ni se est√°n juntando.`,
      `Para que sea suma, el cuento deber√≠a decir que "llegan m√°s" o que "juntan". Lee bien, no dice eso.`
    ],
    resta: [
      `La resta es cuando quitas cosas y te quedan MENOS. Pero f√≠jate, aqu√≠ no se est√° quitando nada.`,
      `Restar es perder, vender, regalar o quitar algo. Pero en este cuento no se va nada.`,
      `Para que sea resta, alguien deber√≠a perder algo o quedarse con menos. Lee el cuento otra vez.`
    ],
    multi: [
      `La multiplicaci√≥n es cuando tienes GRUPOS IGUALES, como cajas con lo mismo. Pero aqu√≠ no hay grupos con la misma cantidad.`,
      `Multiplicar es repetir una cantidad varias veces. Pero en este problema no se repite nada.`,
      `Para que sea multiplicaci√≥n, el cuento deber√≠a decir "cada uno tiene" o "en cada" algo. No es el caso aqu√≠.`
    ],
    divi: [
      `La divisi√≥n es REPARTIR en partes iguales. Pero f√≠jate, aqu√≠ no se est√° repartiendo nada entre personas o grupos.`,
      `Dividir es dar la misma cantidad a cada uno. Pero en este cuento nadie est√° repartiendo.`,
      `Para que sea divisi√≥n, deber√≠an estar separando algo "entre" varios. Lee el cuento, no dice eso.`
    ]
  };
  const arr = wrongExplanations[wrongOp] || [''];
  return arr[Math.floor(Math.random() * arr.length)];
}

// Explicaciones de POR QU√â S√ç es la operaci√≥n correcta (variadas)
function getCorrectExplanationDetail(correctOp){
  const correctExplanations = {
    suma: [
      `La pista es que dice "juntar", "llegan m√°s" o "en total". Cuando se agregan cosas, ¬°es una suma!`,
      `F√≠jate que en el cuento hay dos cantidades que se unen. Cuando pones todo junto, siempre es suma.`,
      `Mira las palabras: "y", "m√°s", "juntar", "en total". Esas palabras te dicen que es suma.`
    ],
    resta: [
      `La pista es que dice "vendi√≥", "se fueron", "perdi√≥" o "le quedan". Cuando algo se va, ¬°es resta!`,
      `F√≠jate que en el cuento alguien pierde algo o se queda con menos. Eso siempre es resta.`,
      `Mira las palabras: "quedan", "vendi√≥", "perdi√≥", "se van". Esas palabras te dicen que es resta.`
    ],
    multi: [
      `La pista es que dice "cada uno tiene" o "en cada" hay la misma cantidad. Grupos iguales siempre es multiplicaci√≥n.`,
      `F√≠jate que hay varios grupos y todos tienen lo mismo adentro. Eso es multiplicar.`,
      `Mira las palabras: "cada", "grupos de", "por cada uno". Cuando se repite la misma cantidad, es multiplicaci√≥n.`
    ],
    divi: [
      `La pista es que dice "repartir", "entre" o "a cada uno". Cuando separas algo en partes iguales, ¬°es divisi√≥n!`,
      `F√≠jate que est√°n dando la misma cantidad a cada persona o grupo. Repartir parejo siempre es dividir.`,
      `Mira las palabras: "repartir", "entre", "partes iguales", "a cada uno". Esas palabras te dicen que es divisi√≥n.`
    ]
  };
  const arr = correctExplanations[correctOp] || [''];
  return arr[Math.floor(Math.random() * arr.length)];
}

const OPERATION_TIPS = {
  suma: {
    name: 'Suma',
    sym: '+',
    keywords: ['juntar', 'm√°s', 'llegan', 'agregar', 'total', 'en total', 'a√±adir', 'y', 'junto con'],
    tip: '<b>üü¢ SUMA (+)</b> = Juntar cosas<br>Palabras clave: "llegan m√°s", "en total", "juntar", "agregar", "y"<br>Ejemplo: Tengo 3 üçé y llegan 2 m√°s ‚Üí 3 + 2'
  },
  resta: {
    name: 'Resta',
    sym: '‚àí',
    keywords: ['quedan', 'quitar', 'menos', 'vendi√≥', 'perdi√≥', 'se fueron', 'se van', 'comi√≥', 'gast√≥', 'regal√≥'],
    tip: '<b>üü† RESTA (‚àí)</b> = Quitar cosas<br>Palabras clave: "quedan", "vendi√≥", "se van", "perdi√≥", "quitar"<br>Ejemplo: Tengo 5 üçé y vendo 2 ‚Üí 5 - 2'
  },
  multi: {
    name: 'Multiplicaci√≥n',
    sym: '√ó',
    keywords: ['cada uno tiene', 'grupos', 'veces', 'cada', 'por', 'repetir'],
    tip: '<b>üîµ MULTIPLICACI√ìN (√ó)</b> = Grupos iguales<br>Palabras clave: "cada uno tiene", "grupos de", "veces"<br>Ejemplo: 3 cajas con 4 üçé cada una ‚Üí 3 √ó 4'
  },
  divi: {
    name: 'Divisi√≥n',
    sym: '√∑',
    keywords: ['repartir', 'dividir', 'entre', 'partes iguales', 'a cada uno', 'por igual'],
    tip: '<b>üî¥ DIVISI√ìN (√∑)</b> = Repartir igual<br>Palabras clave: "repartir entre", "a cada uno", "partes iguales"<br>Ejemplo: 12 üçé para 3 ni√±os ‚Üí 12 √∑ 3'
  }
};

function showStoryModal(){
  const step = currentStory.steps[currentStep];
  quizWrongAttempts = 0;

  // Texto con HTML para mostrar
  const storyTextHTML = step.template
    .replaceAll('{char}', `<span class="highlight">${currentStory.character}</span>`)
    .replaceAll('{a}', `<span class="number">${numA}</span>`)
    .replaceAll('{b}', `<span class="number">${numB}</span>`);

  // Texto limpio para lectura en voz alta
  const storyTextClean = step.template
    .replaceAll('{char}', currentStory.character)
    .replaceAll('{a}', numA)
    .replaceAll('{b}', numB);

  document.getElementById('storyModal').innerHTML = `
    <div class="story-modal-content">
      <div class="story-modal-avatar">${currentStory.avatar}</div>
      <div class="story-modal-title">${currentStory.title}</div>
      <div class="story-modal-chapter">üìñ Paso ${currentStep + 1} de ${currentStory.steps.length}</div>

      <button class="listen-btn" id="listenBtn" onclick="startStoryReading()">
        <span class="listen-icon">üîä</span>
        <span class="listen-text">Escuchar el problema</span>
      </button>

      <div class="voice-reading-indicator" id="voiceIndicator" style="display:none">
        <span class="voice-icon">üîä</span>
        <span class="voice-text">Leyendo...</span>
        <div class="voice-dots"><span></span><span></span><span></span></div>
      </div>

      <div class="story-modal-text" id="storyText">${storyTextHTML}</div>
      <div class="story-modal-question" id="storyQuestion">‚ùì ${step.question.replaceAll('{char}', currentStory.character)}</div>

      <div class="quiz-section hidden" id="quizSection">
        <div class="quiz-label">üß† ¬øQu√© operaci√≥n necesitas para resolver esto?</div>
        <div class="operation-btns" id="opBtns">
          <button class="op-btn suma" onclick="checkOperationQuiz('suma')">
            <span class="op-sym">+</span>
            <span class="op-name">Suma</span>
          </button>
          <button class="op-btn resta" onclick="checkOperationQuiz('resta')">
            <span class="op-sym">‚àí</span>
            <span class="op-name">Resta</span>
          </button>
          <button class="op-btn multi" onclick="checkOperationQuiz('multi')">
            <span class="op-sym">√ó</span>
            <span class="op-name">Multi</span>
          </button>
          <button class="op-btn divi" onclick="checkOperationQuiz('divi')">
            <span class="op-sym">√∑</span>
            <span class="op-name">Dividir</span>
          </button>
        </div>
        <div class="quiz-feedback" id="quizFeedback"></div>
        <div class="quiz-cooldown" id="quizCooldown" style="display:none">
          ‚è±Ô∏è Lee la ayuda... Podr√°s intentar en <span class="timer" id="cooldownTimer">3</span>s
        </div>
      </div>
    </div>
  `;
  document.getElementById('storyModal').style.display = 'flex';

  // Guardar texto limpio para lectura
  window.currentStoryTextClean = storyTextClean;
  window.currentStoryQuestion = step.question.replaceAll('{char}', currentStory.character);
}

// Iniciar lectura del cuento (llamado por bot√≥n)
function startStoryReading(){
  const listenBtn = document.getElementById('listenBtn');
  const indicator = document.getElementById('voiceIndicator');

  // Ocultar bot√≥n, mostrar indicador
  if(listenBtn) listenBtn.style.display = 'none';
  if(indicator) indicator.style.display = 'flex';

  // Saludos personalizados para iniciar
  const greetings = [
    `¬°Escucha bien, ${PLAYER.name}!`,
    `¬°Atenci√≥n ${PLAYER.nickname}!`,
    `¬°${PLAYER.name}, aqu√≠ viene tu problema!`,
    `¬°Listo ${PLAYER.nickname}? ¬°Escucha!`,
    `¬°Oye ${PLAYER.name}, pon atenci√≥n!`
  ];
  const greeting = greetings[Math.floor(Math.random() * greetings.length)];

  // Texto completo: saludo + problema + pregunta + instrucci√≥n del quiz
  const fullText = greeting + ' ' +
                   window.currentStoryTextClean + '. ' +
                   window.currentStoryQuestion + '. ' +
                   `¬øQu√© operaci√≥n necesitas para resolver este problema, ${PLAYER.name}? ¬øEs suma, resta, multiplicaci√≥n o divisi√≥n?`;

  // Iniciar lectura completa
  speakText(fullText, () => {
    // Ocultar indicador y habilitar quiz
    if(indicator) indicator.style.display = 'none';
    enableQuizSection();
  }, { rate: 0.88, pitch: 1.0 });
}

function checkOperationQuiz(selectedOp){
  if(quizCooldown > 0) return;

  const correctOp = currentOp;
  const btns = document.querySelectorAll('.op-btn');
  const selectedBtn = document.querySelector(`.op-btn.${selectedOp}`);

  if(selectedOp === correctOp){
    // ¬°Correcto!
    sndCorrect();
    selectedBtn.classList.add('correct');
    btns.forEach(b => b.classList.add('disabled'));

    // Mensaje personalizado de felicitaci√≥n
    const correctMessage = getPlayerMessage('correct');

    const feedback = document.getElementById('quizFeedback');
    feedback.className = 'quiz-feedback show';
    feedback.style.background = 'rgba(0,214,143,.15)';
    feedback.style.border = '2px solid var(--green)';

    if(isPracticeRound){
      // Acert√≥ en ronda de pr√°ctica ‚Äî volver al cuento original
      feedback.innerHTML = `<span style="color:var(--green);font-weight:800">üéâ ${correctMessage}</span><br>¬°Es ${OPERATION_TIPS[correctOp].name}! Ahora volvamos al cuento anterior.`;

      speakText(`${correctMessage} ¬°Muy bien! Es una ${OPERATION_TIPS[correctOp].name}. ¬°Ahora s√≠, volvamos al cuento que est√°bamos haciendo, ${PLAYER.name}!`, () => {
        setTimeout(() => {
          // Restaurar cuento original
          currentStory = originalStory;
          currentStep = originalStep;
          numA = originalNumA;
          numB = originalNumB;
          answer = originalAnswer;
          currentOp = currentStory.steps[currentStep].op;
          currentEmoji = currentStory.steps[currentStep].emoji;
          currentEmojiB = currentStory.steps[currentStep].emojiB || currentStory.steps[currentStep].emoji;
          currentGroupEmoji = currentStory.steps[currentStep].groupEmoji || '';
          isPracticeRound = false;
          originalStory = null;

          // Mostrar de nuevo el cuento original
          document.getElementById('storyModal').style.display = 'none';
          showStoryModal();
        }, 800);
      }, { rate: 0.88, pitch: 1.0 });
    } else {
      // Acert√≥ en el cuento real ‚Äî continuar al gameplay
      moduleTracker.performance[correctOp].quizCorrect++;
      feedback.innerHTML = `<span style="color:var(--green);font-weight:800">üéâ ${correctMessage}</span><br>Es una <b>${OPERATION_TIPS[correctOp].name}</b> (${OPERATION_TIPS[correctOp].sym})`;

      speakText(`${correctMessage} Es una ${OPERATION_TIPS[correctOp].name}. ¬°Ahora vamos a resolverlo!`, () => {
        setTimeout(() => {
          closeStoryModal();
          startGameplay();
        }, 500);
      }, { rate: 0.88, pitch: 1.0 });
    }

  } else {
    // Incorrecto
    sndWrong();
    quizWrongAttempts++;
    moduleTracker.performance[correctOp].quizErrors++;
    moduleTracker.performance[correctOp].practiceErrors++;
    selectedBtn.classList.add('wrong');
    setTimeout(() => selectedBtn.classList.remove('wrong'), 500);

    const feedback = document.getElementById('quizFeedback');
    feedback.className = 'quiz-feedback wrong show';

    // Mostrar pista espec√≠fica del error y de la operaci√≥n correcta
    const wrongTip = OPERATION_TIPS[selectedOp];
    const correctTip = OPERATION_TIPS[correctOp];

    // Mensaje personalizado para Emilio
    const personalMessage = getPlayerMessage('wrong', quizWrongAttempts);

    const wrongDetail = getWrongExplanationDetail(selectedOp, correctOp);
    const correctDetail = getCorrectExplanationDetail(correctOp);

    feedback.innerHTML = `
      <span class="feedback-title">‚ùå ${personalMessage}</span>
      <div class="tip-box">
        <b>No es ${wrongTip.name}.</b> ${wrongDetail}
      </div>
      <div class="tip-box" style="margin-top:8px;border-left:3px solid var(--green)">
        <b style="color:var(--green)">üí° La respuesta era ${correctTip.name} (${correctTip.sym})</b><br>
        ${correctDetail}
      </div>
      <div class="tip-box" style="margin-top:8px;border-left:3px solid var(--red)">
        <b style="color:var(--red)">üö´ No puedes avanzar hasta que identifiques bien la operaci√≥n.</b><br>
        Vamos a practicar con otro cuento...
      </div>
    `;

    // Deshabilitar TODOS los botones permanentemente (no hay segundo intento)
    btns.forEach(b => b.classList.add('disabled'));

    // Frases variadas para avisar que no puede avanzar
    const cantAdvanceMsgs = [
      `No puedes avanzar hasta que aprendas a identificar la operaci√≥n, ${PLAYER.name}. Vamos a practicar con otro cuento.`,
      `${PLAYER.name}, no te voy a dejar pasar hasta que aciertes. Vamos a leer otro cuento para que practiques.`,
      `Todav√≠a no puedes seguir, ${PLAYER.nickname}. Primero tienes que demostrar que puedes identificar la operaci√≥n. Vamos con otro cuento.`,
      `${PLAYER.name}, aqu√≠ no se adivina. Tienes que pensar bien. Vamos a practicar con otro problema hasta que lo logres.`,
    ];
    const cantAdvanceMsg = cantAdvanceMsgs[Math.floor(Math.random() * cantAdvanceMsgs.length)];

    // Explicar por qu√© estaba mal y cu√°l era la correcta
    const explanationText = `${personalMessage}. ` +
      `No es ${wrongTip.name}. ${wrongDetail} . . ` +
      `La respuesta correcta era ${correctTip.name}. ${correctDetail} . . ` +
      `${cantAdvanceMsg} ¬°Pon mucha atenci√≥n!`;

    speakText(explanationText, () => {
      // Guardar cuento original si no estamos ya en pr√°ctica
      if(!isPracticeRound){
        originalStory = currentStory;
        originalStep = currentStep;
        originalNumA = numA;
        originalNumB = numB;
        originalAnswer = answer;
      }
      // Despu√©s de explicar, generar cuento de pr√°ctica con operaci√≥n ALEATORIA
      setTimeout(() => {
        launchPracticeRound();
      }, 800);
    }, { rate: 0.88, pitch: 1.0 });
  }
}

function launchPracticeRound(){
  isPracticeRound = true;

  // Elegir operaci√≥n ALEATORIA (puede ser cualquiera)
  const ops = ['suma', 'resta', 'multi', 'divi'];
  const practiceOp = ops[Math.floor(Math.random() * ops.length)];

  // Elegir cuento de pr√°ctica aleatorio para esa operaci√≥n
  const practiceStories = PRACTICE_STORIES[practiceOp];
  const practice = practiceStories[Math.floor(Math.random() * practiceStories.length)];

  // Generar n√∫meros nuevos
  currentOp = practiceOp;
  currentEmoji = practice.emoji;
  currentEmojiB = practice.emojiB || practice.emoji;
  currentGroupEmoji = practice.groupEmoji || '';
  generateProblem();

  // Armar cuento temporal para el modal
  const tempStory = {
    title: 'üìñ Cuento de Pr√°ctica',
    avatar: practice.avatar,
    character: practice.character,
    steps: [{
      op: practiceOp,
      template: practice.template,
      question: practice.question,
      successMsg: '¬°Correcto!',
      emoji: practice.emoji,
      emojiB: practice.emojiB || practice.emoji,
      groupEmoji: practice.groupEmoji || ''
    }]
  };

  currentStory = tempStory;
  currentStep = 0;

  // Cerrar modal actual y mostrar nuevo
  document.getElementById('storyModal').style.display = 'none';
  showStoryModal();
}

function closeStoryModal(){
  stopSpeaking(); // Detener lectura en voz alta
  document.getElementById('storyModal').style.display = 'none';
  if(quizCooldownInterval) clearInterval(quizCooldownInterval);
  quizCooldown = 0;
}

function startGameplay(){
  // Continuar con el flujo normal del juego
  clearWorkspace();
  hasChecked = false;
  attempts = 0;
  hintLevel = 0;
  renderStoryPanel();
  renderChallengeCard();
  renderHintPanel();
  renderWorkspace();
  renderActions();
  renderCounters();

  // Mensajes de instrucci√≥n seg√∫n la operaci√≥n
  const thinkingMessages = {
    suma: `¬øCu√°nto es ${numA} + ${numB}? ¬°Coloca los ${currentEmoji} que necesitas!`,
    resta: `Si tienes ${numA} y quitas ${numB}... ¬øcu√°ntos quedan?`,
    multi: `${numA} grupos √ó ${numB} cada uno = ¬ø? ¬°Forma los grupos!`,
    divi: `${numA} ${currentEmoji} √∑ ${numB} ${currentGroupEmoji} = ¬ø? ¬°Reparte!`
  };
  renderResult({type:'thinking', emoji:'ü§î', text:'¬°Piensa y resuelve!', detail:thinkingMessages[currentOp]});

  // Explicaci√≥n hablada de qu√© debe hacer seg√∫n la operaci√≥n
  const gameplayInstructions = {
    suma: [
      `Muy bien ${PLAYER.name}, ahora tienes que sumar. Arrastra ${numA} m√°s ${numB} objetos al tablero. ¬øCu√°ntos son en total?`,
      `${PLAYER.nickname}, es hora de sumar. Pon ${numA} objetos y luego ${numB} m√°s. Cuenta cu√°ntos quedan.`,
      `Vamos ${PLAYER.name}, junta ${numA} con ${numB}. Arrastra los objetos al tablero y cuenta el total.`
    ],
    resta: [
      `Ahora ${PLAYER.name}, tienes que restar. Empiezas con ${numA} y debes quitar ${numB}. ¬øCu√°ntos quedan?`,
      `${PLAYER.nickname}, aqu√≠ hay que restar. De ${numA} objetos, quita ${numB}. Arrastra al tablero los que quedan.`,
      `Vamos ${PLAYER.name}, si tienes ${numA} y te quitan ${numB}, ¬øcu√°ntos te quedan? Pon esa cantidad en el tablero.`
    ],
    multi: [
      `${PLAYER.name}, ahora multiplicamos. Tienes ${numA} grupos y cada grupo tiene ${numB}. ¬øCu√°ntos hay en total?`,
      `${PLAYER.nickname}, forma ${numA} grupos de ${numB} objetos cada uno. Arrastra al tablero el total.`,
      `Vamos ${PLAYER.name}, ${numA} veces ${numB} es... ¬°pon la cantidad correcta en el tablero!`
    ],
    divi: [
      `${PLAYER.name}, ahora dividimos. Tienes ${numA} objetos para repartir entre ${numB}. ¬øCu√°ntos le tocan a cada uno?`,
      `${PLAYER.nickname}, reparte ${numA} objetos en ${numB} grupos iguales. ¬øCu√°ntos van en cada grupo?`,
      `Vamos ${PLAYER.name}, si divides ${numA} entre ${numB}, ¬øcu√°ntos quedan en cada parte? Pon esa cantidad.`
    ]
  };

  const instructions = gameplayInstructions[currentOp];
  const instruction = instructions[Math.floor(Math.random() * instructions.length)];

  // Esperar un momento antes de hablar para que se renderice todo
  setTimeout(() => {
    speakText(instruction, null, { rate: 0.88, pitch: 1.0 });
  }, 300);
}

// ========== MATH REVIEW MODAL (Repaso de t√©rminos matem√°ticos) ==========
const MATH_TERMS = {
  suma: {
    opName: 'Suma',
    symbol: '+',
    symbolName: 'Signo m√°s',
    terms: [
      { name: 'Sumando', desc: 'N√∫mero que se suma', key: 'a' },
      { name: 'Sumando', desc: 'Otro n√∫mero que se suma', key: 'b' },
      { name: 'Suma o Total', desc: 'El resultado de sumar', key: 'result' }
    ],
    funFact: 'En la suma, el orden no importa: 3+5 = 5+3'
  },
  resta: {
    opName: 'Resta',
    symbol: '‚àí',
    symbolName: 'Signo menos',
    terms: [
      { name: 'Minuendo', desc: 'Lo que tienes al inicio', key: 'a' },
      { name: 'Sustraendo', desc: 'Lo que quitas', key: 'b' },
      { name: 'Diferencia', desc: 'Lo que queda (resultado)', key: 'result' }
    ],
    funFact: 'El minuendo siempre debe ser mayor o igual al sustraendo para obtener un resultado positivo'
  },
  multi: {
    opName: 'Multiplicaci√≥n',
    symbol: '√ó',
    symbolName: 'Signo por',
    terms: [
      { name: 'Multiplicando', desc: 'El n√∫mero que se repite', key: 'a' },
      { name: 'Multiplicador', desc: 'Cu√°ntas veces se repite', key: 'b' },
      { name: 'Producto', desc: 'El resultado de multiplicar', key: 'result' }
    ],
    funFact: 'Multiplicar es sumar el mismo n√∫mero varias veces: 4√ó3 = 4+4+4'
  },
  divi: {
    opName: 'Divisi√≥n',
    symbol: '√∑',
    symbolName: 'Signo dividido',
    terms: [
      { name: 'Numerador', desc: 'Lo que vas a repartir (arriba)', key: 'a' },
      { name: 'Denominador', desc: 'Entre cu√°ntos repartes (abajo)', key: 'b' },
      { name: 'Cociente', desc: 'Lo que le toca a cada uno', key: 'result' }
    ],
    funFact: 'Dividir es repartir en partes iguales. ¬°El denominador nunca puede ser cero!'
  }
};

let mathQuizQuestions = [];
let mathQuizCurrent = 0;

function showMathReviewModal(){
  const terms = MATH_TERMS[currentOp];
  const values = { a: numA, b: numB, result: answer };

  // Generar preguntas de quiz
  generateMathQuizQuestions();

  // Crear HTML de la operaci√≥n formal CON etiquetas visibles
  // Para divisi√≥n, mostrar como fracci√≥n (numerador arriba, denominador abajo)
  let operationHTML;

  if(currentOp === 'divi'){
    operationHTML = `
      <div class="operation-display division-display" id="operationDisplay">
        <div class="fraction-container">
          <div class="fraction-top">
            <div class="value num-a">${numA}</div>
            <div class="label highlight term-label" data-term="a">${terms.terms[0].name}</div>
          </div>
          <div class="fraction-line-container">
            <div class="fraction-line"></div>
            <div class="fraction-symbol-label term-label" data-term="sym">${terms.symbolName}</div>
          </div>
          <div class="fraction-bottom">
            <div class="value num-b">${numB}</div>
            <div class="label highlight term-label" data-term="b">${terms.terms[1].name}</div>
          </div>
        </div>
        <div class="math-element">
          <div class="value equals">=</div>
          <div class="label">igual a</div>
        </div>
        <div class="math-element">
          <div class="value result">${answer}</div>
          <div class="label highlight term-label" data-term="result">${terms.terms[2].name}</div>
        </div>
      </div>
    `;
  } else {
    operationHTML = `
      <div class="operation-display" id="operationDisplay">
        <div class="math-element">
          <div class="value num-a">${numA}</div>
          <div class="label highlight term-label" data-term="a">${terms.terms[0].name}</div>
        </div>
        <div class="math-element">
          <div class="value symbol">${terms.symbol}</div>
          <div class="label term-label" data-term="sym">${terms.symbolName}</div>
        </div>
        <div class="math-element">
          <div class="value num-b">${numB}</div>
          <div class="label highlight term-label" data-term="b">${terms.terms[1].name}</div>
        </div>
        <div class="math-element">
          <div class="value equals">=</div>
          <div class="label">igual a</div>
        </div>
        <div class="math-element">
          <div class="value result">${answer}</div>
          <div class="label highlight term-label" data-term="result">${terms.terms[2].name}</div>
        </div>
      </div>
    `;
  }

  // Tabla de t√©rminos
  let termsHTML = terms.terms.map(t => `
    <div class="term-item">
      <div class="term-name">${t.name}</div>
      <div class="term-value">${values[t.key]}</div>
      <div class="term-desc">${t.desc}</div>
    </div>
  `).join('');

  document.getElementById('mathReviewModal').innerHTML = `
    <div class="math-review-content">
      <div class="math-review-header">
        <h2>üìê ¬°Aprendamos los t√©rminos, ${PLAYER.name}!</h2>
        <p>Esta fue una <b>${terms.opName}</b></p>
      </div>

      <div class="formal-operation" id="formalOperation">
        <div class="formal-operation-title">La operaci√≥n completa</div>
        ${operationHTML}
        <div class="terms-table" id="termsTable">
          <div class="terms-table-title">üìö Vocabulario matem√°tico</div>
          <div class="terms-grid">${termsHTML}</div>
        </div>
        <div class="fun-fact">üí° ${terms.funFact}</div>
      </div>

      <div class="terms-quiz" id="termsQuiz">
        <div id="termsStartSection">
          <p style="font-size:.85rem;color:var(--text-dim);margin-bottom:12px">üìñ Escucha y memoriza los nombres...</p>
          <button class="btn btn-check" id="startQuizBtn" onclick="startTermsQuiz()" style="width:100%;opacity:0.5;pointer-events:none">üß† ¬°Empezar Quiz!</button>
        </div>
        <div id="termsQuizSection" style="display:none">
          <div class="terms-quiz-progress" id="quizProgress"></div>
          <div id="mathQuizContainer"></div>
          <div class="terms-quiz-feedback" id="mathQuizFeedback"></div>
        </div>
        <button class="continue-btn" id="continueBtn" onclick="closeMathReviewAndContinue()">‚ú® ¬°Continuar!</button>
      </div>
    </div>
  `;

  document.getElementById('mathReviewModal').style.display = 'flex';

  // Leer explicaci√≥n del modal - habilitar bot√≥n cuando termine
  // Para suma, decir "primer sumando" y "segundo sumando" para que no suene repetitivo
  let termExplanation;
  if(currentOp === 'suma'){
    termExplanation = `El primer sumando es ${numA}. El segundo sumando es ${numB}. ` +
      `Y el resultado, que se llama ${terms.terms[2].name}, es ${answer}.`;
  } else {
    termExplanation = `El ${terms.terms[0].name} es ${numA}. El ${terms.terms[1].name} es ${numB}. ` +
      `Y el resultado, que se llama ${terms.terms[2].name}, es ${answer}.`;
  }

  const mathReviewIntro = `¬°Muy bien ${PLAYER.name}! Ahora aprendamos los nombres de los n√∫meros. ` +
    `Esto fue una ${terms.opName}. ` +
    termExplanation + ` ` +
    `Memoriza estos nombres, ${PLAYER.nickname}, porque luego te voy a preguntar.`;

  setTimeout(() => {
    speakText(mathReviewIntro, () => {
      // Habilitar bot√≥n de quiz cuando termine de hablar
      const btn = document.getElementById('startQuizBtn');
      if(btn){
        btn.style.opacity = '1';
        btn.style.pointerEvents = 'auto';
      }
    }, { rate: 0.88, pitch: 1.0 });
  }, 500);
}

function startTermsQuiz(){
  sndClick();
  console.log('startTermsQuiz llamado, preguntas:', mathQuizQuestions.length);

  // Ocultar los nombres de los t√©rminos
  document.querySelectorAll('.term-label').forEach(label => {
    label.textContent = '???';
    label.style.color = 'var(--yellow)';
  });

  // Ocultar la tabla de vocabulario
  const termsTable = document.getElementById('termsTable');
  if(termsTable) termsTable.style.display = 'none';

  // Mostrar secci√≥n del quiz de t√©rminos
  const startSection = document.getElementById('termsStartSection');
  const quizSection = document.getElementById('termsQuizSection');
  console.log('startSection:', startSection, 'quizSection:', quizSection);

  if(startSection) startSection.style.display = 'none';
  if(quizSection) quizSection.style.display = 'block';

  // Generar dots del progreso
  const dotsHTML = mathQuizQuestions.map((_, i) => `
    <div class="quiz-dot ${i === 0 ? 'current' : ''}"></div>
  `).join('');
  document.getElementById('quizProgress').innerHTML = dotsHTML;

  // Renderizar primera pregunta (sin hablar todav√≠a)
  renderMathQuizQuestion(false);

  // Deshabilitar botones mientras habla
  document.querySelectorAll('.term-option').forEach(b => b.classList.add('disabled'));

  // Intro corto + primera pregunta
  const introMsg = `¬°A ver! ¬øC√≥mo se llama el s√≠mbolo de esta operaci√≥n?`;

  speakText(introMsg, () => {
    // Habilitar botones cuando termine de hablar
    document.querySelectorAll('.term-option').forEach(b => b.classList.remove('disabled'));
  }, { rate: 0.88, pitch: 1.0 });
}

function generateMathQuizQuestions(){
  mathQuizQuestions = [];
  mathQuizCurrent = 0;

  const terms = MATH_TERMS[currentOp];
  const values = { a: numA, b: numB, result: answer };

  // Pregunta 1: ¬øC√≥mo se llama el s√≠mbolo?
  mathQuizQuestions.push({
    question: `¬øC√≥mo se llama el s√≠mbolo <span class="quiz-highlight">${terms.symbol}</span>?`,
    correct: terms.symbolName,
    alsoCorrect: [], // Sin alternativas
    options: shuffleArray([terms.symbolName, 'Signo igual', getRandomWrongSymbol(currentOp), 'Par√©ntesis'])
  });

  // Pregunta 2: ¬øC√≥mo se llama el primer n√∫mero?
  // Para suma: ambos son "Sumando", as√≠ que aceptamos ambos
  const alsoCorrectForA = (currentOp === 'suma') ? [terms.terms[1].name] : [];
  mathQuizQuestions.push({
    question: `En ${numA} ${terms.symbol} ${numB} = ${answer}, ¬øc√≥mo se llama el <span class="quiz-highlight">${numA}</span>?`,
    correct: terms.terms[0].name,
    alsoCorrect: alsoCorrectForA,
    options: currentOp === 'suma'
      ? shuffleArray([terms.terms[0].name, terms.terms[2].name, getRandomWrongTerm(currentOp, 0), getRandomWrongTerm(currentOp, 1)])
      : shuffleArray([terms.terms[0].name, terms.terms[1].name, terms.terms[2].name, getRandomWrongTerm(currentOp, 0)])
  });

  // Pregunta 3: ¬øC√≥mo se llama el resultado?
  mathQuizQuestions.push({
    question: `El resultado <span class="quiz-highlight">${answer}</span> se llama...`,
    correct: terms.terms[2].name,
    alsoCorrect: [],
    options: shuffleArray([terms.terms[2].name, terms.terms[0].name, getRandomWrongTerm(currentOp, 2), getRandomWrongTerm(currentOp, 1)])
  });

  // Pregunta 4: ¬øCu√°l es el [t√©rmino espec√≠fico]?
  // Para suma, preguntamos por el resultado para evitar confusi√≥n
  let randomTerm;
  if(currentOp === 'suma'){
    randomTerm = terms.terms[2]; // Siempre preguntar por el resultado en suma
  } else {
    randomTerm = terms.terms[Math.floor(Math.random() * 3)];
  }

  // Para suma con Sumando, ambos valores son v√°lidos
  const alsoCorrectValues = (currentOp === 'suma' && randomTerm.name === 'Sumando')
    ? [String(numA), String(numB)]
    : [];

  mathQuizQuestions.push({
    question: `¬øCu√°l es el <span class="quiz-highlight">${randomTerm.name}</span> en esta operaci√≥n?`,
    correct: String(values[randomTerm.key]),
    alsoCorrect: alsoCorrectValues,
    options: shuffleArray([String(numA), String(numB), String(answer), String(numA + numB)])
  });
}

function getRandomWrongSymbol(op){
  const symbols = {suma: 'Signo por', resta: 'Signo m√°s', multi: 'Signo menos', divi: 'Signo m√°s'};
  return symbols[op];
}

function getRandomWrongTerm(op, excludeIndex){
  const wrongTerms = {
    suma: ['Minuendo', 'Numerador', 'Cociente', 'Producto'],
    resta: ['Sumando', 'Multiplicador', 'Numerador', 'Producto'],
    multi: ['Minuendo', 'Sumando', 'Numerador', 'Diferencia'],
    divi: ['Sumando', 'Minuendo', 'Producto', 'Diferencia']
  };
  return wrongTerms[op][excludeIndex] || wrongTerms[op][0];
}

function shuffleArray(arr){
  const shuffled = [...arr];
  for(let i = shuffled.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled.slice(0, 4); // Asegurar 4 opciones
}

function renderMathQuizQuestion(shouldSpeak = true){
  console.log('renderMathQuizQuestion, current:', mathQuizCurrent, 'total:', mathQuizQuestions.length);

  if(mathQuizCurrent >= mathQuizQuestions.length){
    showMathQuizComplete();
    return;
  }

  const q = mathQuizQuestions[mathQuizCurrent];
  console.log('Pregunta actual:', q);

  const optionsHTML = q.options.map(opt => `
    <button class="term-option" onclick="checkMathQuizAnswer('${opt.replace(/'/g, "\\'")}', '${q.correct.replace(/'/g, "\\'")}')">${opt}</button>
  `).join('');

  document.getElementById('mathQuizContainer').innerHTML = `
    <div class="terms-quiz-question">${q.question}</div>
    <div class="terms-options">${optionsHTML}</div>
  `;

  // Update progress dots
  document.querySelectorAll('.quiz-dot').forEach((dot, i) => {
    dot.className = 'quiz-dot';
    if(i < mathQuizCurrent) dot.classList.add('done');
    if(i === mathQuizCurrent) dot.classList.add('current');
  });

  document.getElementById('mathQuizFeedback').className = 'terms-quiz-feedback';
  document.getElementById('mathQuizFeedback').innerHTML = '';

  // Leer la pregunta si corresponde (no la primera que ya se ley√≥ en el intro)
  if(shouldSpeak && mathQuizCurrent > 0){
    // Deshabilitar botones mientras habla
    document.querySelectorAll('.term-option').forEach(b => b.classList.add('disabled'));

    // Limpiar HTML de la pregunta para hablarla
    const questionClean = q.question.replace(/<[^>]*>/g, '');
    const questionNum = mathQuizCurrent + 1;
    const spokenQuestion = `Pregunta ${questionNum}: ${questionClean}`;

    speakText(spokenQuestion, () => {
      // Habilitar botones cuando termine
      document.querySelectorAll('.term-option').forEach(b => b.classList.remove('disabled'));
    }, { rate: 0.88, pitch: 1.0 });
  }
}

let mathQuizCooldown = 0;
let mathQuizCooldownInterval = null;

function checkMathQuizAnswer(selected, correct){
  if(mathQuizCooldown > 0) return;

  const btns = document.querySelectorAll('.term-option');
  const feedback = document.getElementById('mathQuizFeedback');
  const selectedBtn = Array.from(btns).find(b => b.textContent === selected);

  // Obtener la pregunta actual para verificar respuestas alternativas
  const currentQuestion = mathQuizQuestions[mathQuizCurrent];
  const alsoCorrect = currentQuestion.alsoCorrect || [];

  // Verificar si es correcto o una alternativa v√°lida
  const isCorrect = (selected === correct) || alsoCorrect.includes(selected);

  if(isCorrect){
    // ¬°Correcto! Avanza a la siguiente pregunta
    sndCorrect();
    moduleTracker.performance[currentOp].termsCorrect++;

    btns.forEach(btn => btn.classList.add('disabled'));
    if(selectedBtn) selectedBtn.classList.add('correct');

    feedback.className = 'terms-quiz-feedback success show';
    feedback.innerHTML = `‚úÖ ¬°Correcto, ${PLAYER.nickname}!`;

    // Felicitaci√≥n hablada corta - esperar a que termine antes de pasar a la siguiente
    const termCorrectMsgs = [
      `¬°Bien ${PLAYER.nickname}!`,
      `¬°Eso es ${PLAYER.nickname}!`,
      `¬°Correcto ${PLAYER.nickname}!`,
      `¬°Muy bien ${PLAYER.nickname}!`,
      `¬°Excelente ${PLAYER.nickname}!`,
      `¬°As√≠ se hace ${PLAYER.nickname}!`,
      `¬°Genial ${PLAYER.nickname}!`,
      `¬°${PLAYER.nickname} lo sabe!`,
      `¬°Eso ${PLAYER.fullName}!`
    ];
    speakText(termCorrectMsgs[Math.floor(Math.random() * termCorrectMsgs.length)], () => {
      // Revelar el nombre en la operaci√≥n si es relevante
      revealTermLabel(currentQuestion, selected);

      // Siguiente pregunta despu√©s de terminar de hablar
      setTimeout(() => {
        mathQuizCurrent++;
        renderMathQuizQuestion();
      }, 400);
    }, { rate: 0.85, pitch: 1.0 });

  } else {
    // Incorrecto - debe esperar y leer la explicaci√≥n
    sndWrong();
    moduleTracker.performance[currentOp].termsErrors++;
    if(selectedBtn) selectedBtn.classList.add('wrong');
    setTimeout(() => { if(selectedBtn) selectedBtn.classList.remove('wrong'); }, 500);

    // Generar explicaci√≥n seg√∫n el tipo de pregunta
    const terms = MATH_TERMS[currentOp];
    let explanation = '';

    if(correct === terms.symbolName){
      explanation = `<b>${terms.symbol}</b> se llama <b>${terms.symbolName}</b> y se usa para la ${terms.opName}.`;
    } else {
      const termInfo = terms.terms.find(t => t.name === correct);
      if(termInfo){
        explanation = `<b>${correct}</b>: ${termInfo.desc}.<br>En ${numA} ${terms.symbol} ${numB} = ${answer}, el ${correct} es <b>${termInfo.key === 'a' ? numA : termInfo.key === 'b' ? numB : answer}</b>.`;
      } else {
        // Es una pregunta de valor num√©rico
        explanation = `Recuerda los t√©rminos:<br>‚Ä¢ ${terms.terms[0].name} = ${numA}<br>‚Ä¢ ${terms.terms[1].name} = ${numB}<br>‚Ä¢ ${terms.terms[2].name} = ${answer}`;
      }
    }

    feedback.className = 'terms-quiz-feedback error show';
    feedback.innerHTML = `
      <span style="color:var(--red);font-weight:800;display:block;margin-bottom:8px">‚ùå ${PLAYER.name}, ese no es.</span>
      <div style="background:rgba(0,0,0,.2);border-radius:8px;padding:10px;font-size:.82rem;text-align:left;margin-bottom:8px">
        ${explanation}
      </div>
      <div id="mathQuizCooldownText" style="color:var(--yellow);font-weight:700">
        ‚è±Ô∏è Lee bien... podr√°s intentar en <span id="mathCooldownTimer">3</span>s
      </div>
    `;

    // Deshabilitar botones mientras habla
    const termBtns = document.querySelectorAll('.term-option');
    termBtns.forEach(b => b.classList.add('disabled'));

    // Mensaje hablado guiador seg√∫n el tipo de pregunta
    let spokenGuide = '';

    if(correct === terms.symbolName){
      // Pregunta sobre el s√≠mbolo - usar Emilio
      spokenGuide = `No ${PLAYER.name}, ese no es el nombre del s√≠mbolo. . Mira, el s√≠mbolo ${terms.symbol} se llama ${terms.symbolName}. . Se usa para hacer ${terms.opName.toLowerCase()}s. . ¬øCu√°l es entonces ${PLAYER.name}?`;
    } else {
      const termInfo = terms.terms.find(t => t.name === correct);
      if(termInfo){
        // Pregunta sobre un t√©rmino espec√≠fico (Sumando, Minuendo, etc.) - usar Emilio
        if(correct === terms.terms[0].name){
          // Primer t√©rmino (el de arriba/izquierda)
          if(currentOp === 'suma'){
            spokenGuide = `No ${PLAYER.name}, pi√©nsalo bien. . En la suma, los n√∫meros que sumamos se llaman Sumandos. . El ${numA} es un Sumando porque es uno de los n√∫meros que vamos a juntar.`;
          } else if(currentOp === 'resta'){
            spokenGuide = `No ${PLAYER.name}. . En la resta, el n√∫mero grande del que quitamos se llama Minuendo. . El ${numA} es el Minuendo porque es lo que tenemos al inicio.`;
          } else if(currentOp === 'multi'){
            spokenGuide = `No ${PLAYER.name}. . El n√∫mero que se repite varias veces se llama Multiplicando. . El ${numA} es el Multiplicando.`;
          } else {
            spokenGuide = `No ${PLAYER.name}. . El n√∫mero de arriba, lo que vamos a repartir, se llama Numerador. . El ${numA} es el Numerador.`;
          }
        } else if(correct === terms.terms[1].name){
          // Segundo t√©rmino (el de abajo/derecha)
          if(currentOp === 'suma'){
            spokenGuide = `No ${PLAYER.name}. . El ${numB} tambi√©n es un Sumando, porque es otro n√∫mero que sumamos. . En la suma, todos los n√∫meros se llaman Sumandos.`;
          } else if(currentOp === 'resta'){
            spokenGuide = `No ${PLAYER.name}. . El n√∫mero que quitamos se llama Sustraendo. . El ${numB} es el Sustraendo porque es lo que restamos.`;
          } else if(currentOp === 'multi'){
            spokenGuide = `No ${PLAYER.name}. . El n√∫mero que dice cu√°ntas veces repetimos se llama Multiplicador. . El ${numB} es el Multiplicador.`;
          } else {
            spokenGuide = `No ${PLAYER.name}. . El n√∫mero de abajo, entre cu√°ntos repartimos, se llama Denominador. . El ${numB} es el Denominador.`;
          }
        } else if(correct === terms.terms[2].name){
          // Resultado
          if(currentOp === 'suma'){
            spokenGuide = `No ${PLAYER.name}. . El resultado de sumar se llama Suma o Total. . Cuando sumamos ${numA} m√°s ${numB}, el ${answer} es la Suma.`;
          } else if(currentOp === 'resta'){
            spokenGuide = `No ${PLAYER.name}. . El resultado de restar se llama Diferencia. . Cuando restamos ${numA} menos ${numB}, el ${answer} es la Diferencia.`;
          } else if(currentOp === 'multi'){
            spokenGuide = `No ${PLAYER.name}. . El resultado de multiplicar se llama Producto. . Cuando multiplicamos ${numA} por ${numB}, el ${answer} es el Producto.`;
          } else {
            spokenGuide = `No ${PLAYER.name}. . El resultado de dividir se llama Cociente. . Cuando dividimos ${numA} entre ${numB}, el ${answer} es el Cociente.`;
          }
        }
      } else {
        // Pregunta de valor num√©rico - usar Emilio
        spokenGuide = `No ${PLAYER.name}, ese n√∫mero no es correcto. . Recuerda: el ${terms.terms[0].name} es ${numA}, el ${terms.terms[1].name} es ${numB}, y el ${terms.terms[2].name} es ${answer}. . Pi√©nsalo de nuevo ${PLAYER.name}.`;
      }
    }

    speakText(spokenGuide, () => {
      // Iniciar cooldown DESPU√âS de que termine de hablar
      startMathQuizCooldown(3);
    }, { rate: 0.88, pitch: 1.0 });
  }
}

// Revelar el nombre del t√©rmino cuando contesta correctamente
function revealTermLabel(question, selectedAnswer){
  const terms = MATH_TERMS[currentOp];

  // Determinar qu√© etiqueta revelar bas√°ndose en la pregunta
  if(selectedAnswer === terms.symbolName){
    // Revelar el s√≠mbolo
    const label = document.querySelector('.term-label[data-term="sym"]');
    if(label){
      label.textContent = terms.symbolName;
      label.style.color = 'var(--green)';
      label.style.animation = 'fadeIn 0.3s ease';
    }
  } else if(selectedAnswer === terms.terms[0].name || selectedAnswer === terms.terms[1].name){
    // Para suma ambos son Sumando, revelar ambos
    if(currentOp === 'suma'){
      document.querySelectorAll('.term-label[data-term="a"], .term-label[data-term="b"]').forEach(label => {
        label.textContent = 'Sumando';
        label.style.color = 'var(--green)';
        label.style.animation = 'fadeIn 0.3s ease';
      });
    } else {
      // Revelar solo el espec√≠fico
      const key = selectedAnswer === terms.terms[0].name ? 'a' : 'b';
      const label = document.querySelector(`.term-label[data-term="${key}"]`);
      if(label){
        label.textContent = selectedAnswer;
        label.style.color = 'var(--green)';
        label.style.animation = 'fadeIn 0.3s ease';
      }
    }
  } else if(selectedAnswer === terms.terms[2].name){
    // Revelar el resultado
    const label = document.querySelector('.term-label[data-term="result"]');
    if(label){
      label.textContent = terms.terms[2].name;
      label.style.color = 'var(--green)';
      label.style.animation = 'fadeIn 0.3s ease';
    }
  }
}

function startMathQuizCooldown(seconds){
  mathQuizCooldown = seconds;
  const btns = document.querySelectorAll('.term-option');
  btns.forEach(b => b.classList.add('disabled'));

  const timerEl = document.getElementById('mathCooldownTimer');
  if(timerEl) timerEl.textContent = mathQuizCooldown;

  mathQuizCooldownInterval = setInterval(()=>{
    mathQuizCooldown--;
    const timerEl = document.getElementById('mathCooldownTimer');
    if(timerEl) timerEl.textContent = mathQuizCooldown;

    if(mathQuizCooldown <= 0){
      clearInterval(mathQuizCooldownInterval);
      btns.forEach(b => b.classList.remove('disabled'));
      const cooldownText = document.getElementById('mathQuizCooldownText');
      if(cooldownText) cooldownText.innerHTML = 'üëÜ <span style="color:var(--green)">¬°Intenta de nuevo!</span>';
    }
  }, 1000);
}

function showMathQuizComplete(){
  sndCorrect();
  spawnConfetti(15);

  // Mensajes de felicitaci√≥n por completar el quiz - usar Esmi y Emilio Quintero Ocampo (apodo de juego)
  const quizCompleteMsgs = [
    `¬°${PLAYER.fullName} complet√≥ el quiz! ¬°Eres incre√≠ble!`,
    `¬°${PLAYER.fullName} es un campe√≥n de las matem√°ticas!`,
    `¬°${PLAYER.fullName} sabe todos los t√©rminos! ¬°Felicitaciones!`,
    `¬°Ese es ${PLAYER.fullName}! ¬°Lo lograste!`,
    `¬°Nadie le gana a ${PLAYER.fullName}!`,
    `¬°${PLAYER.fullName} domina la ${MATH_TERMS[currentOp].opName}!`,
    `¬°Arriba ${PLAYER.fullName}! ¬°Eres el mejor!`,
    `¬°Bravo ${PLAYER.nickname}! ¬°Aprendiste todos los t√©rminos!`,
    `¬°Genial ${PLAYER.nickname}! ¬°Lo lograste!`
  ];
  const completeMsg = quizCompleteMsgs[Math.floor(Math.random() * quizCompleteMsgs.length)];

  document.getElementById('mathQuizContainer').innerHTML = `
    <div style="text-align:center;padding:16px">
      <div style="font-size:3rem;margin-bottom:10px">üèÜ</div>
      <div style="font-size:1.2rem;font-weight:800;color:var(--yellow);margin-bottom:8px">¬°Excelente, ${PLAYER.nickname}!</div>
      <div style="font-size:.9rem;color:var(--text)">Ya conoces los t√©rminos de la ${MATH_TERMS[currentOp].opName}</div>
    </div>
  `;

  document.getElementById('mathQuizFeedback').style.display = 'none';

  // Mostrar bot√≥n pero deshabilitado hasta que termine de hablar
  const continueBtn = document.getElementById('continueBtn');
  continueBtn.classList.add('show');
  continueBtn.disabled = true;
  continueBtn.style.opacity = '0.5';
  continueBtn.style.pointerEvents = 'none';

  // Leer felicitaci√≥n y habilitar bot√≥n cuando termine
  speakText(completeMsg, () => {
    continueBtn.disabled = false;
    continueBtn.style.opacity = '1';
    continueBtn.style.pointerEvents = 'auto';
  }, { rate: 0.88, pitch: 1.0 });

  // Update all dots as done
  document.querySelectorAll('.quiz-dot').forEach(dot => {
    dot.className = 'quiz-dot done';
  });
}

function closeMathReviewAndContinue(){
  // Detener voz para evitar que se trabe
  stopSpeaking();

  document.getElementById('mathReviewModal').style.display = 'none';

  // Desaf√≠o Rel√°mpago despu√©s del vocabulario, luego trivia
  showDesafioRelampago(() => {
    showTriviaGame(() => {
      // Despu√©s del trivia, continuar al siguiente paso o mostrar victoria
      if(currentStep < currentStory.steps.length - 1){
        currentStep++;
        loadCurrentStep();
      } else {
        showVictory();
      }
    });
  });
}

function loadCurrentStep(){
  const step = currentStory.steps[currentStep];
  currentOp = step.op;
  currentEmoji = step.emoji;
  currentEmojiB = step.emojiB || step.emoji;
  currentGroupEmoji = step.groupEmoji || '';
  generateProblem();
  sndNewStep();

  // Mostrar modal con quiz de operaci√≥n ANTES del gameplay
  showStoryModal();
}

function generateProblem(){
  const step = currentStory.steps[currentStep];

  // Si este paso usa el resultado anterior
  if(step.usePrevAnswer && previousAnswer > 0){
    numA = previousAnswer;
    // Para divisi√≥n, encontrar un divisor v√°lido
    if(currentOp === 'divi'){
      const divisores = [];
      for(let d = 2; d <= 4; d++){
        if(numA % d === 0 && numA / d >= 2 && numA / d <= 6) divisores.push(d);
      }
      if(divisores.length > 0){
        numB = divisores[rand(0, divisores.length-1)];
        answer = numA / numB;
      } else {
        // Fallback si no hay divisor v√°lido
        numB = 2;
        answer = Math.ceil(numA / 2);
        numA = numB * answer;
      }
    } else {
      numB = rand(2, 4);
      answer = numA + numB; // Para suma
    }
  } else {
    // Generaci√≥n normal
    if(currentOp === 'suma'){
      numA = rand(2,8); numB = rand(2,8);
      answer = numA + numB;
    } else if(currentOp === 'resta'){
      numA = rand(6,12); numB = rand(2, Math.min(numA-2, 6));
      answer = numA - numB;
    } else if(currentOp === 'multi'){
      numA = rand(2,5); numB = rand(2,4);
      answer = numA * numB;
    } else {
      // Divisi√≥n: numA cosas √∑ numB grupos = answer por grupo
      // M√°s variedad en los n√∫meros
      const divisiones = [
        {grupos: 2, porGrupo: [2,3,4,5]},
        {grupos: 3, porGrupo: [2,3,4]},
        {grupos: 4, porGrupo: [2,3]},
      ];
      const div = divisiones[rand(0, divisiones.length-1)];
      numB = div.grupos;
      answer = div.porGrupo[rand(0, div.porGrupo.length-1)];
      numA = numB * answer;
    }
  }
}

function rand(a,b){ return a + Math.floor(Math.random()*(b-a+1)); }

function getStoryText(){
  const step = currentStory.steps[currentStep];
  return step.template
    .replaceAll('{char}', `<span class="highlight">${currentStory.character}</span>`)
    .replaceAll('{a}', `<span class="number">${numA}</span>`)
    .replaceAll('{b}', `<span class="number">${numB}</span>`);
}

// ========== HINTS SYSTEM ==========
function getHints(){
  // Generate emoji examples
  const makeEmojiRow = (count, emoji) => {
    return `<span style="font-size:1.3rem;letter-spacing:2px">${emoji.repeat(count)}</span>`;
  };

  // Pistas pedag√≥gicas progresivas - ense√±an el concepto con emojis de la historia
  // Ejemplos con n√∫meros DIFERENTES a los del problema para no revelar la respuesta
  const exSuma = { a: numA <= 3 ? 4 : 2, b: numA <= 3 ? 3 : 3 };
  exSuma.r = exSuma.a + exSuma.b;
  const exResta = { a: numA <= 4 ? 7 : 5, b: numA <= 4 ? 3 : 2 };
  exResta.r = exResta.a - exResta.b;
  const exMulti = { a: numA <= 2 ? 3 : 2, b: numB <= 3 ? 4 : 3 };
  exMulti.r = exMulti.a * exMulti.b;
  const exDivi = { a: numA <= 6 ? 8 : 6, b: numB <= 2 ? 4 : 2 };
  exDivi.r = exDivi.a / exDivi.b;

  const hints = {
    suma: [
      `<b>üí≠ ¬øQu√© es sumar?</b><br>Sumar es <em>juntar</em> cosas. Si tienes ${numA} ${currentEmoji} y llegan ${numB} m√°s, ¬øcu√°ntos hay en total?`,
      `<b>üéØ ¬øC√≥mo lo hago?</b><br>Haz clic en la zona para agregar ${currentEmoji}. ¬°Cuenta mientras agregas!
       <div style="margin-top:6px">Ejemplo: ${makeEmojiRow(exSuma.a, currentEmoji)} + ${makeEmojiRow(exSuma.b, currentEmoji)} = ${exSuma.r}</div>`,
      `<b>‚ú® Cuenta conmigo:</b><br>Empieza en ${numA} y cuenta ${numB} m√°s con los dedos:<br>${numA}... y sumas uno por uno. ¬øA qu√© n√∫mero llegas?`
    ],
    resta: [
      `<b>üí≠ ¬øQu√© es restar?</b><br>Restar es <em>quitar</em>. Si tienes ${numA} ${currentEmoji} y se van ${numB}, ¬øcu√°ntos quedan?`,
      `<b>üéØ ¬øC√≥mo lo hago?</b><br>Pon los que <b>QUEDAN</b> en ‚úÖ y los que <b>SE VAN</b> en üì§
       <div style="margin-top:6px">Ejemplo: de ${exResta.a} quitas ${exResta.b} ‚Üí quedan ${exResta.r}</div>`,
      `<b>‚ú® Cuenta hacia atr√°s:</b><br>Empieza en ${numA} y cuenta hacia atr√°s ${numB} veces.<br>${numA}... y quitas uno por uno. ¬øA qu√© n√∫mero llegas?`
    ],
    multi: [
      `<b>üí≠ ¬øQu√© es multiplicar?</b><br>Multiplicar es sumar lo mismo varias veces.<br>${numA} √ó ${numB} = ${numB} + ${numB} ${numA > 2 ? '+ ' + numB : ''}...`,
      `<b>üéØ ¬øC√≥mo lo hago?</b><br>Imagina ${numA} ${currentGroupEmoji}, cada uno con ${numB} ${currentEmoji}.
       <div style="margin-top:6px">Ejemplo: ${exMulti.a} √ó ${exMulti.b} = ${exMulti.a} grupos de ${exMulti.b} = ${exMulti.r}</div>`,
      `<b>‚ú® Cuenta de ${numB} en ${numB}:</b><br>Cuenta ${numA} veces de ${numB} en ${numB}:<br>${numB}, ${numB*2}... ¬°Sigue contando hasta completar ${numA} grupos!`
    ],
    divi: [
      `<b>üí≠ ¬øQu√© es dividir?</b><br>Dividir es <em>repartir igual</em>. Si tienes ${numA} ${currentEmoji} para ${numB} ${currentGroupEmoji}, ¬øcu√°ntos le tocan a cada uno?`,
      `<b>üéØ ¬øC√≥mo lo hago?</b><br>Reparte los ${currentEmoji} entre los ${numB} ${currentGroupEmoji}. ¬°Todos deben tener lo mismo!
       <div style="margin-top:6px">Ejemplo: ${exDivi.a} entre ${exDivi.b} ‚Üí pon 1 en cada grupo, luego otro, hasta acabar</div>`,
      `<b>‚ú® Reparte paso a paso:</b><br>Pon 1 ${currentEmoji} en cada ${currentGroupEmoji}, luego otro en cada uno, y as√≠.<br>¬øCu√°ntas rondas puedes hacer con ${numA} ${currentEmoji} y ${numB} ${currentGroupEmoji}?`
    ]
  };
  return hints[currentOp];
}

// Las pistas se revelan autom√°ticamente al fallar

// ========== RENDER ==========
function renderScoreBar(){
  document.getElementById('scoreBar').innerHTML = `
    <div class="score-item adventures"><div class="val">${score.adventures}</div><div class="lbl">Aventuras</div></div>
    <div class="score-item streak"><div class="val">üî•${score.streak}</div><div class="lbl">Racha</div></div>
    <div class="score-item stars"><div class="val">‚≠ê${score.stars}</div><div class="lbl">Estrellas</div></div>
  `;
}

function renderStoryPanel(){
  const step = currentStory.steps[currentStep];
  let progressHTML = '';
  for(let i = 0; i < currentStory.steps.length; i++){
    let cls = i < currentStep ? 'done' : (i === currentStep ? 'current' : '');
    progressHTML += `<div class="progress-step ${cls}"></div>`;
  }
  document.getElementById('storyPanel').innerHTML = `
    <div class="story-header">
      <div class="story-avatar">${currentStory.avatar}</div>
      <div class="story-meta">
        <div class="story-title">${currentStory.title}</div>
        <div class="story-chapter">Paso ${currentStep + 1}/4</div>
      </div>
    </div>
    <div class="story-text">${getStoryText()}<br><b>${step.question}</b></div>
    <div class="progress-bar">${progressHTML}<span class="progress-label">${currentStep + 1}/4</span></div>
  `;
}

function renderChallengeCard(){
  const o = OPS[currentOp];
  document.getElementById('challengeCard').innerHTML = `
    <div class="challenge-header">
      <span class="challenge-title">üìù Operaci√≥n</span>
      <span class="challenge-op ${currentOp}">${o.label}</span>
    </div>
    <div class="challenge-equation">
      <span class="num a">${numA}</span>
      <span class="op-sym">${o.sym}</span>
      <span class="num b">${numB}</span>
      <span class="eq">=</span>
      <span class="result-box" id="resultBox">?</span>
    </div>
  `;
}

function renderHintPanel(){
  const hints = getHints();
  let hintsHTML = '';

  for(let i = 0; i < hints.length; i++){
    const isActive = i < hintLevel;
    hintsHTML += `<div class="hint-level hint-${i+1} ${isActive ? 'active' : ''}">${hints[i]}</div>`;
  }

  // Mensajes seg√∫n el nivel de ayuda
  let statusMsg = '';
  if(hintLevel === 0) {
    statusMsg = '<p style="font-size:.7rem;color:var(--text-dim)">¬°Int√©ntalo! Las pistas aparecer√°n si las necesitas.</p>';
  } else if(hintLevel === 1) {
    statusMsg = '<p style="font-size:.7rem;color:var(--purple)">üíú Piensa en el concepto...</p>';
  } else if(hintLevel === 2) {
    statusMsg = '<p style="font-size:.7rem;color:var(--yellow)">üíõ Ya casi lo tienes...</p>';
  } else {
    statusMsg = '<p style="font-size:.7rem;color:var(--green)">üíö ¬°Sigue las instrucciones!</p>';
  }

  document.getElementById('hintPanel').innerHTML = `
    <h4>üß† Aprende</h4>
    ${statusMsg}
    ${hintsHTML}
  `;
}

function renderSourceArea(){
  let html = '';
  const tapHint = isMobile ? '<div class="tap-hint">üëÜ Arrastra los objetos a las zonas</div>' : '';

  if(currentOp === 'suma'){
    html = `
      <div class="source-area">
        <div class="source-title"><span class="icon">üì¶</span> Objetos para juntar</div>
        <div class="source-groups">
          <div class="source-group" style="border-color:var(--green)">
            <div class="source-group-label">${numA} ${currentEmoji}</div>
            <div class="source-items" id="source-A"></div>
          </div>
          <div class="source-group" style="border-color:var(--blue)">
            <div class="source-group-label">${numB} ${currentEmojiB}</div>
            <div class="source-items" id="source-B"></div>
          </div>
        </div>
        ${tapHint}
      </div>
    `;
  } else if(currentOp === 'resta'){
    html = `
      <div class="source-area">
        <div class="source-title"><span class="icon">üéí</span> Tienes ${numA} ${currentEmoji}</div>
        <div class="source-groups">
          <div class="source-group" style="border-color:var(--yellow);min-width:200px">
            <div class="source-group-label">Separa los objetos</div>
            <div class="source-items" id="source-main"></div>
          </div>
        </div>
        ${tapHint}
      </div>
    `;
  } else if(currentOp === 'multi'){
    html = `
      <div class="source-area">
        <div class="source-title"><span class="icon">üì¶</span> ${answer} ${currentEmoji} para ${numA} grupos</div>
        <div class="source-groups">
          <div class="source-group" style="border-color:var(--purple);min-width:200px">
            <div class="source-group-label">Organiza en los ${currentGroupEmoji}</div>
            <div class="source-items" id="source-main"></div>
          </div>
        </div>
        ${tapHint}
      </div>
    `;
  } else if(currentOp === 'divi'){
    html = `
      <div class="source-area">
        <div class="source-title"><span class="icon">üéÅ</span> ${numA} ${currentEmoji} para repartir</div>
        <div class="source-groups">
          <div class="source-group" style="border-color:var(--pink);min-width:200px">
            <div class="source-group-label">Reparte entre ${numB} ${currentGroupEmoji}</div>
            <div class="source-items" id="source-main"></div>
          </div>
        </div>
        ${tapHint}
      </div>
    `;
  }

  return html;
}

function renderWorkspace(){
  const ws = document.getElementById('workspace');
  let zonesHtml = '';
  let title = '';

  if(currentOp === 'suma'){
    title = `¬°Junta todos para ver el total!`;
    zonesHtml = `
      <div class="drop-zones">
        <div class="drop-zone single-zone" onclick="tapZone('total')" ondrop="dropToZone(event, 'total')" ondragover="allowDrop(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
          <div class="drop-zone-label">üéØ Total</div>
          <div class="drop-zone-items" id="zone-total"></div>
        </div>
      </div>
    `;
  } else if(currentOp === 'resta'){
    title = `Separa: ¬øcu√°ntos QUEDAN y cu√°ntos SE VAN?`;
    zonesHtml = `
      <div class="drop-zones resta-zones">
        <div class="drop-zone zone-keep" onclick="tapZone('keep')" ondrop="dropToZone(event, 'keep')" ondragover="allowDrop(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
          <div class="drop-zone-label"><span class="zone-emoji">‚úÖ</span> Quedan</div>
          <div class="drop-zone-items" id="zone-keep"></div>
        </div>
        <div class="drop-zone zone-remove" onclick="tapZone('remove')" ondrop="dropToZone(event, 'remove')" ondragover="allowDrop(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
          <div class="drop-zone-label"><span class="zone-emoji">üì§</span> Se van</div>
          <div class="drop-zone-items" id="zone-remove"></div>
        </div>
      </div>
    `;
  } else if(currentOp === 'multi'){
    title = `Pon ${numB} ${currentEmoji} en cada ${currentGroupEmoji}`;
    let groupsHtml = '';
    for(let i = 0; i < numA; i++){
      groupsHtml += `
        <div class="drop-zone multi-group" style="border-color:${ZONE_COLORS[i % ZONE_COLORS.length]};background:${ZONE_COLORS[i % ZONE_COLORS.length]}15"
             onclick="tapZone('g${i}')" ondrop="dropToZone(event, 'g${i}')" ondragover="allowDrop(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
          <div class="drop-zone-label"><span class="zone-emoji">${currentGroupEmoji}</span> ${i+1}</div>
          <div class="drop-zone-items" id="zone-g${i}"></div>
        </div>
      `;
    }
    zonesHtml = `<div class="drop-zones multi-zones">${groupsHtml}</div>`;
  } else if(currentOp === 'divi'){
    title = `Reparte igual entre los ${numB} ${currentGroupEmoji}`;
    let groupsHtml = '';
    for(let i = 0; i < numB; i++){
      groupsHtml += `
        <div class="drop-zone" style="border-color:${ZONE_COLORS[i % ZONE_COLORS.length]};background:${ZONE_COLORS[i % ZONE_COLORS.length]}15"
             onclick="tapZone('g${i}')" ondrop="dropToZone(event, 'g${i}')" ondragover="allowDrop(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
          <div class="drop-zone-label"><span class="zone-emoji">${currentGroupEmoji}</span> ${i+1}</div>
          <div class="drop-zone-items" id="zone-g${i}"></div>
        </div>
      `;
    }
    zonesHtml = `<div class="drop-zones divi-zones">${groupsHtml}</div>`;
  }

  ws.innerHTML = `
    ${renderSourceArea()}
    <div class="workspace-title">${title}</div>
    ${zonesHtml}
    <div class="trash-row">
      <div class="trash-bin" id="trashBin" onclick="tapTrash()" ondragover="trashDragOver(event)" ondragleave="trashDragLeave(event)" ondrop="trashDrop(event)">üóëÔ∏è</div>
      <button class="btn btn-check" id="verifyBtn" onclick="checkAnswer()">‚úÖ Verificar</button>
    </div>
  `;
  updateAllDisplays();
}

function updateAllDisplays(){
  updateSourceDisplay();
  updateZoneDisplays();
  // Mostrar zonas pulsando si hay item seleccionado
  document.querySelectorAll('.drop-zone').forEach(z => {
    z.classList.toggle('waiting', selectedItemId !== null);
  });
  const trash = document.getElementById('trashBin');
  if(trash) trash.classList.toggle('waiting', selectedItemId !== null && !selectedFromSource);
}

function updateSourceDisplay(){
  // Update source area items
  if(currentOp === 'suma'){
    const groupA = sourceItems.filter(i => i.group === 'A');
    const groupB = sourceItems.filter(i => i.group === 'B');

    const elA = document.getElementById('source-A');
    const elB = document.getElementById('source-B');

    if(elA){
      elA.innerHTML = groupA.map(item => `
        <span class="source-emoji ${selectedItemId === item.id && selectedFromSource ? 'selected' : ''}"
              draggable="true" data-id="${item.id}" data-emoji="${item.emoji}"
              onmousedown="handleMouseDown()"
              onclick="tapSourceItem(${item.id},'${item.emoji}')"
              ondragstart="dragSourceItem(event, ${item.id})"
              ontouchstart="handleTouchStart(event, ${item.id}, true, '${item.emoji}')"
              ontouchmove="handleTouchMove(event)"
              ontouchend="handleTouchEnd(event)">${item.emoji}</span>
      `).join('');
      elA.closest('.source-group').classList.toggle('empty', groupA.length === 0);
    }
    if(elB){
      elB.innerHTML = groupB.map(item => `
        <span class="source-emoji ${selectedItemId === item.id && selectedFromSource ? 'selected' : ''}"
              draggable="true" data-id="${item.id}" data-emoji="${item.emoji}"
              onmousedown="handleMouseDown()"
              onclick="tapSourceItem(${item.id},'${item.emoji}')"
              ondragstart="dragSourceItem(event, ${item.id})"
              ontouchstart="handleTouchStart(event, ${item.id}, true, '${item.emoji}')"
              ontouchmove="handleTouchMove(event)"
              ontouchend="handleTouchEnd(event)">${item.emoji}</span>
      `).join('');
      elB.closest('.source-group').classList.toggle('empty', groupB.length === 0);
    }
  } else {
    const items = sourceItems.filter(i => i.group === 'main');
    const el = document.getElementById('source-main');
    if(el){
      el.innerHTML = items.map(item => `
        <span class="source-emoji ${selectedItemId === item.id && selectedFromSource ? 'selected' : ''}"
              draggable="true" data-id="${item.id}" data-emoji="${item.emoji}"
              onmousedown="handleMouseDown()"
              onclick="tapSourceItem(${item.id},'${item.emoji}')"
              ondragstart="dragSourceItem(event, ${item.id})"
              ontouchstart="handleTouchStart(event, ${item.id}, true, '${item.emoji}')"
              ontouchmove="handleTouchMove(event)"
              ontouchend="handleTouchEnd(event)">${item.emoji}</span>
      `).join('');
      el.closest('.source-group').classList.toggle('empty', items.length === 0);
    }
  }
}

function updateZoneDisplays(){
  // Group placed items by zone
  const byZone = {};
  placedItems.forEach(item => {
    if(!byZone[item.zone]) byZone[item.zone] = [];
    byZone[item.zone].push(item);
  });

  // Update each zone
  document.querySelectorAll('.drop-zone-items').forEach(el => {
    const zoneId = el.id.replace('zone-', '');
    const items = byZone[zoneId] || [];
    el.innerHTML = items.map(item => `
      <span class="placed-emoji ${selectedItemId === item.id && !selectedFromSource ? 'selected' : ''}"
            draggable="true" data-id="${item.id}" data-emoji="${item.emoji}"
            onmousedown="handleMouseDown()"
            onclick="tapPlacedItem(${item.id})"
            ondragstart="dragPlacedItem(event, ${item.id})"
            ontouchstart="handleTouchStart(event, ${item.id}, false, '${item.emoji}')"
            ontouchmove="handleTouchMove(event)"
            ontouchend="handleTouchEnd(event)">${item.emoji}</span>
    `).join('');
  });
}


function renderCounters(){
  const totalPlaced = placedItems.length;
  const totalSource = sourceItems.length;

  // Count by zone
  const byZone = {};
  placedItems.forEach(item => {
    if(!byZone[item.zone]) byZone[item.zone] = 0;
    byZone[item.zone]++;
  });

  let html = '';

  if(currentOp === 'suma'){
    const total = byZone['total'] || 0;
    html += `<div class="counter-chip" style="background:rgba(0,214,143,.15);border-color:var(--green)"><span style="color:var(--green)">üéØ</span> Juntados: ${total}</div>`;
    if(totalSource > 0) html += `<div class="counter-chip"><span style="color:var(--text-dim)">üì¶</span> Por juntar: ${totalSource}</div>`;
  } else if(currentOp === 'resta'){
    const keep = byZone['keep'] || 0;
    const remove = byZone['remove'] || 0;
    if(keep > 0) html += `<div class="counter-chip" style="background:rgba(0,214,143,.15);border-color:var(--green)"><span style="color:var(--green)">‚úÖ</span> Quedan: ${keep}</div>`;
    if(remove > 0) html += `<div class="counter-chip" style="background:rgba(255,159,67,.15);border-color:var(--orange)"><span style="color:var(--orange)">üì§</span> Se van: ${remove}</div>`;
    if(totalSource > 0) html += `<div class="counter-chip"><span style="color:var(--text-dim)">üéí</span> Sin separar: ${totalSource}</div>`;
  } else if(currentOp === 'multi'){
    for(let i = 0; i < numA; i++){
      const count = byZone['g' + i] || 0;
      if(count > 0) html += `<div class="counter-chip"><span style="font-size:1rem">${currentGroupEmoji}</span>${i+1}: ${count}/${numB}</div>`;
    }
    if(totalSource > 0) html += `<div class="counter-chip"><span style="color:var(--text-dim)">üì¶</span> Por colocar: ${totalSource}</div>`;
  } else if(currentOp === 'divi'){
    for(let i = 0; i < numB; i++){
      const count = byZone['g' + i] || 0;
      if(count > 0) html += `<div class="counter-chip"><span style="font-size:1rem">${currentGroupEmoji}</span>${i+1}: ${count}</div>`;
    }
    if(totalSource > 0) html += `<div class="counter-chip"><span style="color:var(--text-dim)">üéÅ</span> Por repartir: ${totalSource}</div>`;
  }

  if(totalPlaced > 0) html += `<div class="counter-chip" style="background:rgba(255,212,59,.15);border-color:var(--yellow)"><span style="color:var(--yellow)">‚≠ê</span> Colocados: ${totalPlaced}</div>`;

  document.getElementById('counters').innerHTML = html;
}

function renderActions(){
  document.getElementById('actions').innerHTML = '';
}

function renderResult(data){
  let attemptsHTML = '';
  if(attempts > 0 && !hasChecked){
    attemptsHTML = '<div class="attempts-indicator">';
    for(let i = 0; i < 3; i++){
      attemptsHTML += `<div class="attempt-dot ${i < attempts ? 'used' : ''}"></div>`;
    }
    attemptsHTML += '</div>';
  }

  let encouragementHTML = '';
  if(data.type === 'wrong' && attempts >= 2){
    encouragementHTML = `<div class="encouragement">${ENCOURAGEMENTS[Math.floor(Math.random() * ENCOURAGEMENTS.length)]}</div>`;
  }

  document.getElementById('resultCard').innerHTML = `
    <h3>üìã Resultado</h3>
    <div class="feedback ${data.type}">
      <span class="big-emoji">${data.emoji}</span>
      ${data.text}
      ${data.detail ? `<div class="detail">${data.detail}</div>` : ''}
    </div>
    ${attemptsHTML}
    ${encouragementHTML}
  `;
}

// ========== INTERACTION ==========
let draggedItemId = null;
let draggedFromSource = false;
let selectedItemId = null;
let selectedFromSource = false;

// Touch drag state
let touchDragId = null;
let touchDragFromSource = false;
let touchDragEmoji = '';
let ghostEl = null;

// Detectar si es m√≥vil
const isMobile = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;

// ===== TOUCH DRAG & DROP =====
function handleTouchStart(e, id, fromSource, emoji){
  e.preventDefault();
  const touch = e.touches[0];

  touchDragId = id;
  touchDragFromSource = fromSource;
  touchDragEmoji = emoji;

  // Crear elemento fantasma
  ghostEl = document.createElement('div');
  ghostEl.className = 'drag-ghost';
  ghostEl.textContent = emoji;
  ghostEl.style.left = touch.clientX + 'px';
  ghostEl.style.top = touch.clientY + 'px';
  document.body.appendChild(ghostEl);

  e.target.style.opacity = '0.3';
  sndClick();
}

function handleTouchMove(e){
  if(!ghostEl) return;
  e.preventDefault();
  const touch = e.touches[0];
  ghostEl.style.left = touch.clientX + 'px';
  ghostEl.style.top = touch.clientY + 'px';

  // Highlight zona debajo del dedo
  const el = document.elementFromPoint(touch.clientX, touch.clientY);
  document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('highlight'));
  const trashBin = document.getElementById('trashBin');
  if(trashBin) trashBin.classList.remove('drag-over');

  if(el){
    const zone = el.closest('.drop-zone');
    if(zone) zone.classList.add('highlight');
    if(el.closest('.trash-bin')) trashBin.classList.add('drag-over');
  }
}

function handleTouchEnd(e){
  if(!ghostEl || touchDragId === null) return;

  const touch = e.changedTouches[0];
  const el = document.elementFromPoint(touch.clientX, touch.clientY);

  // Limpiar ghost
  ghostEl.remove();
  ghostEl = null;

  // Restaurar opacidad
  document.querySelectorAll('.source-emoji, .placed-emoji').forEach(x => x.style.opacity = '1');
  document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('highlight'));
  const trashBin = document.getElementById('trashBin');
  if(trashBin) trashBin.classList.remove('drag-over');

  if(el){
    // Verificar si solt√≥ en una zona
    const zone = el.closest('.drop-zone');
    if(zone){
      const zoneId = zone.querySelector('.drop-zone-items')?.id?.replace('zone-','');
      if(zoneId !== undefined){
        dropItemToZone(zoneId);
        return;
      }
    }

    // Verificar si solt√≥ en la basura
    if(el.closest('.trash-bin')){
      dropItemToTrash();
      return;
    }
  }

  // No solt√≥ en ning√∫n lugar v√°lido
  touchDragId = null;
  touchDragFromSource = false;
}

function dropItemToZone(zone){
  if(touchDragId === null) return;

  if(touchDragFromSource){
    const itemIndex = sourceItems.findIndex(i => i.id === touchDragId);
    if(itemIndex >= 0){
      const item = sourceItems.splice(itemIndex, 1)[0];
      placedItems.push({id: item.id, emoji: item.emoji, zone: zone});
      sndDrop();
    }
  } else {
    const item = placedItems.find(i => i.id === touchDragId);
    if(item){
      item.zone = zone;
      sndPlace();
    }
  }

  touchDragId = null;
  touchDragFromSource = false;
  updateAllDisplays();
  renderCounters();
}

function dropItemToTrash(){
  if(touchDragId === null || touchDragFromSource) return;

  const itemIndex = placedItems.findIndex(i => i.id === touchDragId);
  if(itemIndex >= 0){
    const item = placedItems.splice(itemIndex, 1)[0];
    let group = 'main';
    if(currentOp === 'suma'){
      group = item.emoji === currentEmoji ? 'A' : 'B';
    }
    sourceItems.push({id: item.id, emoji: item.emoji, group: group});
    sndTrash();
  }

  touchDragId = null;
  touchDragFromSource = false;
  updateAllDisplays();
  renderCounters();
}

// Prevenir scroll mientras se arrastra
document.addEventListener('touchmove', (e) => {
  if(ghostEl) e.preventDefault();
}, {passive: false});

// ===== DESKTOP DRAG =====
let currentDragImg = null;

function dragSourceItem(e, id){
  e.stopPropagation();
  isDragging = true;
  draggedItemId = id;
  draggedFromSource = true;
  e.target.classList.add('dragging');

  e.dataTransfer.setData('text/plain', 'source-' + id);
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.dropEffect = 'move';

  // Crear imagen de drag personalizada (se limpia en dragend)
  if(currentDragImg) currentDragImg.remove();
  const dragImg = e.target.cloneNode(true);
  dragImg.style.position = 'absolute';
  dragImg.style.top = '-1000px';
  dragImg.style.left = '-1000px';
  dragImg.style.fontSize = '2.5rem';
  document.body.appendChild(dragImg);
  e.dataTransfer.setDragImage(dragImg, 25, 25);
  currentDragImg = dragImg;

  sndClick();
}

function dragPlacedItem(e, id){
  e.stopPropagation();
  isDragging = true;
  draggedItemId = id;
  draggedFromSource = false;
  e.target.classList.add('dragging');

  e.dataTransfer.setData('text/plain', 'placed-' + id);
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.dropEffect = 'move';

  // Crear imagen de drag personalizada (se limpia en dragend)
  if(currentDragImg) currentDragImg.remove();
  const dragImg = e.target.cloneNode(true);
  dragImg.style.position = 'absolute';
  dragImg.style.top = '-1000px';
  dragImg.style.left = '-1000px';
  dragImg.style.fontSize = '2.5rem';
  document.body.appendChild(dragImg);
  e.dataTransfer.setDragImage(dragImg, 25, 25);
  currentDragImg = dragImg;

  sndClick();
}

// TAP como fallback (doble prop√≥sito) - solo si no se inici√≥ drag
let mouseDownTime = 0;
let isDragging = false;

function tapSourceItem(id, emoji){
  // Si el mouse estuvo presionado m√°s de 150ms, fue un drag, no click
  if(isDragging || (Date.now() - mouseDownTime > 150 && mouseDownTime > 0)) {
    isDragging = false;
    return;
  }
  if(selectedItemId === id && selectedFromSource){
    selectedItemId = null;
    selectedFromSource = false;
  } else {
    selectedItemId = id;
    selectedFromSource = true;
    sndClick();
  }
  updateAllDisplays();
}

function tapPlacedItem(id){
  // Si el mouse estuvo presionado m√°s de 150ms, fue un drag, no click
  if(isDragging || (Date.now() - mouseDownTime > 150 && mouseDownTime > 0)) {
    isDragging = false;
    return;
  }
  if(selectedItemId === id && !selectedFromSource){
    selectedItemId = null;
    selectedFromSource = false;
  } else {
    selectedItemId = id;
    selectedFromSource = false;
    sndClick();
  }
  updateAllDisplays();
}

// Detectar inicio de posible drag
function handleMouseDown(){
  mouseDownTime = Date.now();
  isDragging = false;
}

function tapZone(zone){
  if(selectedItemId === null) return;

  if(selectedFromSource){
    const itemIndex = sourceItems.findIndex(i => i.id === selectedItemId);
    if(itemIndex >= 0){
      const item = sourceItems.splice(itemIndex, 1)[0];
      placedItems.push({id: item.id, emoji: item.emoji, zone: zone});
      sndDrop();
    }
  } else {
    const item = placedItems.find(i => i.id === selectedItemId);
    if(item){
      item.zone = zone;
      sndPlace();
    }
  }

  selectedItemId = null;
  selectedFromSource = false;
  updateAllDisplays();
  renderCounters();
}

function tapTrash(){
  if(selectedItemId === null) return;

  if(!selectedFromSource){
    const itemIndex = placedItems.findIndex(i => i.id === selectedItemId);
    if(itemIndex >= 0){
      const item = placedItems.splice(itemIndex, 1)[0];
      let group = 'main';
      if(currentOp === 'suma'){
        group = item.emoji === currentEmoji ? 'A' : 'B';
      }
      sourceItems.push({id: item.id, emoji: item.emoji, group: group});
      sndTrash();
    }
  }

  selectedItemId = null;
  selectedFromSource = false;
  updateAllDisplays();
  renderCounters();
}

function allowDrop(e){
  e.preventDefault();
  e.stopPropagation();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.classList.add('highlight');
}

function handleDragEnter(e){
  e.preventDefault();
  if(e.currentTarget && e.currentTarget.classList){
    e.currentTarget.classList.add('highlight');
  }
}

function handleDragLeave(e){
  e.preventDefault();
  if(!e.currentTarget || !e.currentTarget.classList) return;
  // Solo quitar highlight si realmente sali√≥ del elemento
  const rect = e.currentTarget.getBoundingClientRect();
  const x = e.clientX;
  const y = e.clientY;
  if(x < rect.left || x > rect.right || y < rect.top || y > rect.bottom){
    e.currentTarget.classList.remove('highlight');
  }
}

function dropToZone(e, zone){
  e.preventDefault();
  e.stopPropagation();
  e.currentTarget.classList.remove('highlight');

  if(draggedItemId === null) return;

  if(draggedFromSource){
    const itemIndex = sourceItems.findIndex(i => i.id === draggedItemId);
    if(itemIndex >= 0){
      const item = sourceItems.splice(itemIndex, 1)[0];
      placedItems.push({id: item.id, emoji: item.emoji, zone: zone});
      sndDrop();
    }
  } else {
    const item = placedItems.find(i => i.id === draggedItemId);
    if(item){
      item.zone = zone;
      sndPlace();
    }
  }

  draggedItemId = null;
  draggedFromSource = false;
  updateAllDisplays();
  renderCounters();

  // Guardar referencia al elemento antes del timeout
  const targetEl = e.currentTarget;
  if(targetEl && targetEl.classList){
    targetEl.classList.add('pulse');
    setTimeout(() => {
      if(targetEl && targetEl.classList) targetEl.classList.remove('pulse');
    }, 500);
  }
}

// Trash bin functions
function trashDragOver(e){
  e.preventDefault();
  if(e.currentTarget && e.currentTarget.classList){
    e.currentTarget.classList.add('drag-over');
  }
}

function trashDragLeave(e){
  if(e.currentTarget && e.currentTarget.classList){
    e.currentTarget.classList.remove('drag-over');
  }
}

function trashDrop(e){
  e.preventDefault();
  if(e.currentTarget && e.currentTarget.classList){
    e.currentTarget.classList.remove('drag-over');
  }

  if(draggedItemId === null) return;

  if(!draggedFromSource){
    const itemIndex = placedItems.findIndex(i => i.id === draggedItemId);
    if(itemIndex >= 0){
      const item = placedItems.splice(itemIndex, 1)[0];
      let group = 'main';
      if(currentOp === 'suma'){
        group = item.emoji === currentEmoji ? 'A' : 'B';
      }
      sourceItems.push({id: item.id, emoji: item.emoji, group: group});
      sndTrash();
    }
  }

  draggedItemId = null;
  draggedFromSource = false;
  updateAllDisplays();
  renderCounters();
}

// Remove highlight when drag leaves
document.addEventListener('dragleave', (e) => {
  if(e.target.classList && e.target.classList.contains('drop-zone')){
    e.target.classList.remove('highlight');
  }
});

// Permitir drag en toda la p√°gina para evitar icono de prohibido
document.addEventListener('dragover', (e) => {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
});

document.addEventListener('dragend', () => {
  document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('highlight'));
  document.querySelectorAll('.source-emoji, .placed-emoji').forEach(e => e.classList.remove('dragging'));
  const trash = document.getElementById('trashBin');
  if(trash) trash.classList.remove('drag-over');
  if(currentDragImg){ currentDragImg.remove(); currentDragImg = null; }
  draggedItemId = null;
  draggedFromSource = false;
});

// ========== CHECK ==========
function checkAnswer(){
  if(hasChecked) return;

  const totalPlaced = placedItems.length;
  const totalSource = sourceItems.length;

  // Count by zone
  const byZone = {};
  placedItems.forEach(item => {
    if(!byZone[item.zone]) byZone[item.zone] = 0;
    byZone[item.zone]++;
  });

  let correct = false;
  let explanation = '';

  if(totalPlaced === 0){
    sndWrong();
    renderResult({type:'wrong', emoji:'ü§î', text:'¬°Arrastra los objetos!', detail:`Mueve los ${currentEmoji} desde arriba`});
    return;
  }

  attempts++;

  if(currentOp === 'suma'){
    // Para suma: todos los items deben estar en la zona 'total'
    const total = byZone['total'] || 0;
    if(total === answer && totalSource === 0) {
      correct = true;
    } else {
      if(totalSource > 0) {
        explanation = `¬°A√∫n te faltan objetos por juntar! Arrastra todos al centro.`;
      } else if(total > answer) {
        explanation = `Pusiste demasiados ${currentEmoji}. Recuerda: ${numA} + ${numB}. ¬°Cuenta de nuevo con los dedos!`;
      } else if(total < answer) {
        explanation = `Te faltan ${currentEmoji}. Piensa: ${numA} + ${numB}. ¬°Cuenta de nuevo despacio!`;
      }
    }
  }
  else if(currentOp === 'resta'){
    const keep = byZone['keep'] || 0;
    const remove = byZone['remove'] || 0;

    if(keep === answer && remove === numB && totalSource === 0){
      correct = true;
    } else {
      if(totalSource > 0) {
        explanation = `¬°A√∫n quedan ${totalSource} ${currentEmoji} sin separar! Decide: ¬øse quedan o se van?`;
      } else if(keep === 0 || remove === 0) {
        explanation = `Debes poner ${currentEmoji} en AMBAS zonas: los que quedan Y los que se van.`;
      } else if(remove !== numB) {
        explanation = `Recuerda que se van ${numB} ${currentEmoji}. Pon esa cantidad en "Se van" y lo que sobra en "Quedan". ¬°Pi√©nsalo!`;
      } else if(keep !== answer) {
        explanation = `Si ten√≠as ${numA} y se van ${numB}... ¬øcu√°ntos quedan? Cuenta con los dedos: ${numA} menos ${numB}.`;
      }
    }
  }
  else if(currentOp === 'multi'){
    // Multiplicaci√≥n: numA grupos, cada uno con numB items
    const groupCounts = [];
    for(let i = 0; i < numA; i++){
      groupCounts.push(byZone['g' + i] || 0);
    }
    const allCorrect = groupCounts.every(c => c === numB);
    const usedGroups = groupCounts.filter(c => c > 0).length;

    if(totalPlaced === answer && totalSource === 0 && usedGroups === numA && allCorrect){
      correct = true;
    } else {
      if(totalSource > 0) {
        explanation = `¬°A√∫n quedan ${totalSource} ${currentEmoji} por organizar! Ponlos en los ${currentGroupEmoji}.`;
      } else if(usedGroups < numA) {
        explanation = `Debes llenar TODOS los ${numA} ${currentGroupEmoji}. Hay ${numA - usedGroups} vac√≠os. ¬°Cada uno necesita la misma cantidad!`;
      } else if(!allCorrect) {
        const ejemplo = groupCounts.map((c, i) => `${currentGroupEmoji}${i+1}: ${c}`).join(', ');
        explanation = `Los grupos no est√°n iguales: ${ejemplo}. Recuerda que CADA ${currentGroupEmoji} debe tener la misma cantidad. ¬°Reorganiza!`;
      }
    }
  }
  else if(currentOp === 'divi'){
    // Divisi√≥n: numA cosas √∑ numB grupos = answer por grupo
    const zoneCounts = [];
    for(let i = 0; i < numB; i++){
      zoneCounts.push(byZone['g' + i] || 0);
    }
    const allEqual = zoneCounts.every(c => c === answer);
    const usedZones = zoneCounts.filter(c => c > 0).length;

    if(totalPlaced === numA && totalSource === 0 && usedZones === numB && allEqual){
      correct = true;
    } else {
      // Explicaci√≥n sin dar la respuesta exacta
      const zoneCountsList = zoneCounts.filter(c => c > 0);
      const hasUnequalGroups = zoneCountsList.length > 1 && !zoneCountsList.every(c => c === zoneCountsList[0]);

      if(totalSource > 0) {
        explanation = `<b>¬°Faltan!</b> A√∫n tienes ${totalSource} ${currentEmoji} arriba. <br>Dividir es <em>repartir TODO</em>. Debes repartir los ${numA} ${currentEmoji} entre los ${numB} ${currentGroupEmoji}. ¬°No puede quedar ninguno arriba!`;
      } else if(usedZones !== numB) {
        const emptyZones = numB - usedZones;
        explanation = `<b>¬°Hay ${currentGroupEmoji} vac√≠os!</b> Tienes ${numB} ${currentGroupEmoji} y ${emptyZones} no tienen nada.<br>Dividir es repartir entre TODOS. ¬°Ning√∫n ${currentGroupEmoji} puede quedar vac√≠o!`;
      } else if(hasUnequalGroups) {
        const countsText = zoneCounts.map((c, i) => `${currentGroupEmoji}${i+1}: ${c}`).join(', ');
        explanation = `<b>¬°No est√°n iguales!</b> Tienes: ${countsText}.<br>Dividir es repartir <em>en partes IGUALES</em>. Todos los ${currentGroupEmoji} deben tener la misma cantidad. ¬°Mueve algunos!`;
      } else if(!allEqual) {
        explanation = `<b>¬°Esa cantidad no es correcta!</b> Piensa: si tienes ${numA} ${currentEmoji} y los repartes entre ${numB} ${currentGroupEmoji}... ¬øcu√°ntos le tocan a cada uno? ¬°Cuenta bien!`;
      }
    }
  }

  // Auto-reveal hints progressively after each failed attempt
  if(!correct){
    // Revelar pista autom√°ticamente seg√∫n intentos
    if(attempts === 1 && hintLevel < 1){
      hintLevel = 1; // Primera pista: concepto
    } else if(attempts === 2 && hintLevel < 2){
      hintLevel = 2; // Segunda pista: c√≥mo hacerlo
    } else if(attempts >= 3 && hintLevel < 3){
      hintLevel = 3; // Tercera pista: la respuesta
    }
    renderHintPanel();
  }

  if(correct){
    hasChecked = true;
    // Bloquear bot√≥n verificar
    const verifyBtn = document.getElementById('verifyBtn');
    if(verifyBtn){
      verifyBtn.disabled = true;
      verifyBtn.style.opacity = '0.5';
      verifyBtn.style.pointerEvents = 'none';
    }
    sndCorrect();

    // Guardar respuesta para posible uso en siguiente paso
    previousAnswer = answer;

    // Calculate stars based on attempts and hints used
    let starsEarned = 3;
    if(attempts > 1) starsEarned = 2;
    if(attempts > 2 || hintLevel >= 2) starsEarned = 1;

    score.streak++;
    score.stars += starsEarned;

    // Module tracking
    moduleTracker.performance[currentOp].dragAttempts += attempts;
    moduleTracker.performance[currentOp].hintsUsed += hintLevel;
    moduleTracker.performance[currentOp].starsEarned += starsEarned;
    moduleTracker.performance[currentOp].stepCount++;
    moduleTracker.opsCompleted.add(currentOp);

    const step = currentStory.steps[currentStep];
    const successMsg = step.successMsg.replace('{ans}', answer);
    const starsText = '‚≠ê'.repeat(starsEarned);

    renderResult({type:'correct', emoji:'üéâ', text:`¬°Correcto! <span class="star-earned">${starsText}</span>`, detail:successMsg});

    // Felicitaci√≥n hablada personalizada seg√∫n estrellas ganadas
    let puzzleMsg = '';

    if(starsEarned === 3){
      const msgs = [
        `¬°Incre√≠ble ${PLAYER.name}! ¬°${answer} es correcto! ¬°Tres estrellas! ¬°A la primera!`,
        `¬°Guau ${PLAYER.nickname}! ¬°Perfecto! ¬°${answer}! ¬°Te ganaste tres estrellas!`,
        `¬°${PLAYER.fullName} es un genio! ¬°${answer} correcto a la primera! ¬°Tres estrellas para ti!`,
        `¬°Espectacular ${PLAYER.name}! ¬°Sin errores! ¬°${answer} y tres estrellas!`
      ];
      puzzleMsg = msgs[Math.floor(Math.random() * msgs.length)];
    } else if(starsEarned === 2){
      const msgs = [
        `¬°Muy bien ${PLAYER.name}! ¬°${answer} es correcto! ¬°Dos estrellas!`,
        `¬°Excelente ${PLAYER.nickname}! ¬°Lo lograste! ¬°${answer}! ¬°Dos estrellas!`,
        `¬°Bien hecho ${PLAYER.name}! ¬°${answer}! ¬°Te ganaste dos estrellas!`
      ];
      puzzleMsg = msgs[Math.floor(Math.random() * msgs.length)];
    } else {
      const msgs = [
        `¬°Bien ${PLAYER.name}! ¬°${answer} es correcto! ¬°Una estrella! La pr√≥xima intenta con menos errores.`,
        `¬°Lo lograste ${PLAYER.nickname}! ¬°${answer}! Una estrella. ¬°Sigue practicando!`,
        `¬°${PLAYER.name} lo hizo! ¬°${answer}! Una estrella. ¬°T√∫ puedes mejorar!`
      ];
      puzzleMsg = msgs[Math.floor(Math.random() * msgs.length)];
    }

    // Calcular tiempo de conteo basado en cantidad de objetos
    const totalItems = placedItems.length;
    const countingTime = totalItems * 350 + 800; // 350ms por item + tiempo extra para acorde final

    // Primero hacer la animaci√≥n del conteo
    glowAllFilled(true);

    const rb = document.getElementById('resultBox');
    if(rb){
      rb.textContent = answer;
      rb.style.borderStyle = 'solid';
      rb.style.background = 'rgba(0,214,143,.2)';
      rb.style.color = '#00d68f';
    }

    renderScoreBar();

    // Confetti despu√©s del conteo
    setTimeout(() => {
      spawnConfetti(25);
      if(starsEarned >= 2) spawnStars(starsEarned);
    }, countingTime);

    // Felicitaci√≥n hablada DESPU√âS de que termine el conteo
    setTimeout(() => {
      speakText(puzzleMsg, () => {
        // Despu√©s de hablar, mostrar el modal de t√©rminos
        setTimeout(() => {
          showMathReviewModal();
        }, 500);
      }, { rate: 0.88, pitch: 1.0 });
    }, countingTime + 300); // Esperar a que termine el conteo + peque√±a pausa

  } else {
    sndWrong();
    score.streak = 0;

    // Calcular diferencia para dar pistas m√°s espec√≠ficas
    const placed = placedItems.length;
    const difference = placed - answer;
    const needsMore = difference < 0;
    const howMany = Math.abs(difference);

    // Mensajes de √°nimo seg√∫n intentos - personalizados para Emilio
    let emoji = 'ü§î';
    let title = 'Mmm, no es eso...';
    let spokenMsg = '';

    if(attempts === 1) {
      emoji = 'ü§î';
      title = `¬°Piensa un poco m√°s, ${PLAYER.name}!`;

      // Mensajes espec√≠ficos seg√∫n la operaci√≥n y si puso de m√°s o de menos
      if(currentOp === 'divi'){
        // Para divisi√≥n, explicar claramente qu√© es dividir y qu√© tiene mal
        // Obtener conteo de cada zona
        const zoneCounts = [];
        for(let i = 0; i < numB; i++){
          zoneCounts.push(byZone['g' + i] || 0);
        }
        const usedZones = zoneCounts.filter(c => c > 0).length;
        const hasUnequalGroups = zoneCounts.filter(c => c > 0).length > 1 &&
          !zoneCounts.filter(c => c > 0).every(c => c === zoneCounts.filter(c => c > 0)[0]);

        if(totalSource > 0){
          spokenMsg = `${PLAYER.name}, dividir es repartir TODO. . A√∫n tienes ${totalSource} objetos arriba. . Reparte todos los ${numA} entre los ${numB} grupos. ¬°No puede quedar ninguno arriba!`;
        } else if(usedZones !== numB){
          spokenMsg = `${PLAYER.name}, hay grupos vac√≠os. . Dividir es repartir entre TODOS los grupos. . Ning√∫n grupo puede quedar vac√≠o. ¬°Reparte en todos!`;
        } else if(hasUnequalGroups){
          spokenMsg = `${PLAYER.name}, los grupos no tienen la misma cantidad. . Dividir es repartir en partes IGUALES. . Mueve algunos de un grupo a otro hasta que todos tengan lo mismo.`;
        } else {
          spokenMsg = `${PLAYER.name}, la cantidad no es correcta. . Piensa: si tienes ${numA} objetos y los repartes entre ${numB} grupos iguales, ¬øcu√°ntos le tocan a cada uno? . Cuenta con los dedos.`;
        }
      } else if(needsMore){
        const msgs = [
          `${PLAYER.nickname}, pusiste ${placed} pero necesitas m√°s. . Piensa: ${numA} ${currentOp === 'suma' ? 'm√°s' : currentOp === 'resta' ? 'menos' : currentOp === 'multi' ? 'por' : 'entre'} ${numB}. ¬°Cuenta bien!`,
          `${PLAYER.name}, te faltan objetos. . Vuelve a contar con los dedos despacio.`,
          `Casi ${PLAYER.nickname}, pero necesitas agregar m√°s. . ¬°Int√©ntalo de nuevo!`
        ];
        spokenMsg = msgs[Math.floor(Math.random() * msgs.length)];
      } else {
        const msgs = [
          `${PLAYER.nickname}, pusiste ${placed} pero son demasiados. . Quita algunos y vuelve a contar.`,
          `${PLAYER.name}, hay de m√°s. . Cuenta de nuevo despacio, tienes m√°s de los que necesitas.`,
          `Casi ${PLAYER.nickname}, pero sobran algunos. . Manda unos cuantos a la basura y cuenta otra vez.`
        ];
        spokenMsg = msgs[Math.floor(Math.random() * msgs.length)];
      }
    } else if(attempts === 2) {
      emoji = 'üí™';
      title = `¬°T√∫ puedes, ${PLAYER.nickname}!`;

      // Explicaci√≥n seg√∫n la operaci√≥n
      if(currentOp === 'divi'){
        spokenMsg = `${PLAYER.name}, escucha bien. . Dividir es repartir en partes iguales. . Tienes ${numA} objetos y ${numB} grupos. . Debes poner la misma cantidad en cada grupo. . Piensa: ve poniendo uno en cada grupo, luego otro en cada grupo, y as√≠ hasta que se acaben. ¬°Int√©ntalo!`;
      } else {
        const opExplanations = {
          suma: `${PLAYER.name}, en la suma juntamos todo. ${numA} m√°s ${numB}. Cuenta con los dedos si necesitas. . Por ejemplo, si tienes 2 manzanas y llegan 3 m√°s, cuentas: 3, 4, 5. ¬°Haz lo mismo aqu√≠!`,
          resta: `${PLAYER.name}, en la resta quitamos. De ${numA} quita ${numB}. . Imagina que tienes los ${numA} y cuentas hacia atr√°s ${numB} veces. ¬øCu√°ntos quedan?`,
          multi: `${PLAYER.name}, multiplicar es repetir. ${numA} grupos de ${numB}. . Cuenta de ${numB} en ${numB}: ${numB}, ${numB*2}... ¬°Sigue contando!`
        };
        spokenMsg = opExplanations[currentOp];
      }
    } else if(attempts >= 3) {
      emoji = 'üìñ';
      title = `${PLAYER.name}, mira la ayuda üëà`;

      // Dar gu√≠a sin revelar la respuesta
      const opVerb = currentOp === 'suma' ? 'm√°s' : currentOp === 'resta' ? 'menos' : currentOp === 'multi' ? 'por' : 'entre';
      const hintMsgs = [
        `${PLAYER.fullName}, piensa paso a paso. . ${numA} ${opVerb} ${numB}. . Usa los dedos para contar despacio.`,
        `${PLAYER.name}, mira el panel de la izquierda. . Ah√≠ tienes pistas que te ayudan. ¬°L√©elas con atenci√≥n!`,
        `Oye ${PLAYER.nickname}, no te rindas. . Piensa: ${numA} ${opVerb} ${numB}. . Cuenta despacio, sin prisa. ¬°T√∫ puedes!`
      ];
      spokenMsg = hintMsgs[Math.floor(Math.random() * hintMsgs.length)];
    }

    // Hablar el mensaje de ayuda
    if(spokenMsg) speakText(spokenMsg, null, { rate: 0.88, pitch: 1.0 });

    renderResult({type:'wrong', emoji, text:title, detail:explanation});
    glowAllFilled(false);
    renderScoreBar();
  }
}

// Diferentes escalas musicales para variedad
const MUSICAL_SCALES = [
  // Do Mayor (alegre, cl√°sica)
  { name: 'major', notes: [262, 294, 330, 349, 392, 440, 494, 523, 587, 659, 698, 784], chord: [523, 659, 784, 1047] },
  // La Menor (melanc√≥lica pero bonita)
  { name: 'minor', notes: [220, 247, 262, 294, 330, 349, 392, 440, 494, 523, 587, 659], chord: [440, 523, 659, 880] },
  // Pentat√≥nica Mayor (sonido asi√°tico/alegre)
  { name: 'pentatonic', notes: [262, 294, 330, 392, 440, 523, 587, 659, 784, 880, 1047, 1175], chord: [523, 659, 784, 1047] },
  // Escala de Blues (divertida)
  { name: 'blues', notes: [262, 311, 349, 370, 392, 466, 523, 622, 698, 740, 784, 932], chord: [523, 622, 784, 1047] },
  // Mixolidia (sonido celta/festivo)
  { name: 'mixolydian', notes: [262, 294, 330, 349, 392, 440, 466, 523, 587, 659, 698, 784], chord: [523, 659, 784, 932] },
  // Escala Japonesa (ex√≥tica)
  { name: 'japanese', notes: [262, 278, 330, 392, 415, 523, 554, 659, 784, 831, 1047, 1109], chord: [523, 659, 784, 1047] },
  // D√≥rica (sonido medieval)
  { name: 'dorian', notes: [294, 330, 349, 392, 440, 494, 523, 587, 659, 698, 784, 880], chord: [587, 698, 880, 1175] },
  // Lidio (sonido m√°gico/so√±ador)
  { name: 'lydian', notes: [262, 294, 330, 370, 392, 440, 494, 523, 587, 659, 740, 784], chord: [523, 659, 784, 1047] }
];

let currentScale = null;

function getRandomScale(){
  return MUSICAL_SCALES[Math.floor(Math.random() * MUSICAL_SCALES.length)];
}

function glowAllFilled(isCorrect){
  const emojis = document.querySelectorAll('.placed-emoji');

  if(isCorrect){
    // Elegir una escala aleatoria para esta celebraci√≥n
    currentScale = getRandomScale();
    const scale = currentScale.notes;
    const delayPerItem = 350; // 350ms entre cada objeto

    emojis.forEach((el, i) => {
      setTimeout(() => {
        // Nota musical ascendente (cicla si hay m√°s objetos que notas)
        const noteIndex = i % scale.length;
        const freq = scale[noteIndex];

        // Tocar nota musical con duraci√≥n m√°s larga
        playCountNote(freq, 0.25);

        // Efecto visual de "contado"
        el.classList.add('counting');
        el.style.transform = 'scale(1.4)';
        el.style.filter = 'drop-shadow(0 0 15px var(--yellow))';
        el.style.transition = 'all 0.3s ease';

        // Mostrar n√∫mero de conteo
        showCountNumber(el, i + 1);

        // Volver a estado normal despu√©s
        setTimeout(() => {
          el.style.transform = 'scale(1.1)';
          el.style.filter = 'drop-shadow(0 0 8px var(--green))';
        }, 250);

      }, i * delayPerItem);
    });

    // Acorde final despu√©s de contar todos
    const totalTime = emojis.length * delayPerItem + 300;
    setTimeout(() => {
      playFinalChord(currentScale.chord);
      // Efecto de brillo final en todos
      emojis.forEach(el => {
        el.classList.add('glow');
        el.classList.add('bounce');
      });
    }, totalTime);

    // Efecto en las zonas despu√©s del conteo
    setTimeout(() => {
      document.querySelectorAll('.drop-zone').forEach((zone, i) => {
        setTimeout(() => {
          zone.classList.add('success');
          setTimeout(() => zone.classList.remove('success'), 600);
        }, i * 100);
      });
    }, totalTime + 200);

    // Sonido de cierre √©pico - el gran final
    setTimeout(() => {
      playClosingFanfare(currentScale);
    }, totalTime + 500);

  } else {
    // Incorrecto - shake r√°pido
    emojis.forEach((el, i) => {
      setTimeout(() => {
        el.classList.add('shake');
      }, i * 50);
    });
  }
}

// Nota musical para el conteo
function playCountNote(freq, dur){
  if(!soundOn) return;
  ensureAudio();
  const o = actx.createOscillator();
  const g = actx.createGain();
  o.type = 'sine';
  o.frequency.value = freq;
  g.gain.setValueAtTime(0.15, actx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01, actx.currentTime + dur);
  o.connect(g).connect(actx.destination);
  o.start();
  o.stop(actx.currentTime + dur);

  // A√±adir arm√≥nico para sonido m√°s rico
  const o2 = actx.createOscillator();
  const g2 = actx.createGain();
  o2.type = 'triangle';
  o2.frequency.value = freq * 2;
  g2.gain.setValueAtTime(0.05, actx.currentTime);
  g2.gain.exponentialRampToValueAtTime(0.001, actx.currentTime + dur * 0.8);
  o2.connect(g2).connect(actx.destination);
  o2.start();
  o2.stop(actx.currentTime + dur);
}

// Acorde final que usa la escala actual
function playFinalChord(chordNotes){
  if(!soundOn) return;
  ensureAudio();
  // Usar el acorde pasado o un acorde mayor por defecto
  const notes = chordNotes || [523, 659, 784, 1047];
  notes.forEach((freq, i) => {
    setTimeout(() => {
      const o = actx.createOscillator();
      const g = actx.createGain();
      o.type = 'sine';
      o.frequency.value = freq;
      g.gain.setValueAtTime(0.1, actx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, actx.currentTime + 0.6);
      o.connect(g).connect(actx.destination);
      o.start();
      o.stop(actx.currentTime + 0.6);

      // A√±adir arm√≥nico para m√°s riqueza
      const o2 = actx.createOscillator();
      const g2 = actx.createGain();
      o2.type = 'triangle';
      o2.frequency.value = freq * 0.5; // Octava abajo
      g2.gain.setValueAtTime(0.04, actx.currentTime);
      g2.gain.exponentialRampToValueAtTime(0.001, actx.currentTime + 0.5);
      o2.connect(g2).connect(actx.destination);
      o2.start();
      o2.stop(actx.currentTime + 0.5);
    }, i * 40);
  });
}

// Fanfarria de cierre √©pica - el gran final con estrellas
function playClosingFanfare(scale){
  if(!soundOn) return;
  ensureAudio();

  // Diferentes finales √©picos
  const finales = [
    // Final tipo "ta-da!" cl√°sico
    () => {
      const baseFreq = scale ? scale.chord[0] : 523;
      // Redoble ascendente r√°pido
      [0, 2, 4, 5, 7].forEach((semitone, i) => {
        const freq = baseFreq * Math.pow(2, semitone/12);
        setTimeout(() => playTone(freq, 0.08, 'triangle', 0.08), i * 40);
      });
      // Acorde final sostenido con brillo
      setTimeout(() => {
        const finalChord = scale ? scale.chord : [523, 659, 784, 1047];
        finalChord.forEach((f, i) => {
          setTimeout(() => {
            // Nota principal
            playTone(f, 0.8, 'sine', 0.12);
            // Octava arriba brillante
            playTone(f * 2, 0.6, 'sine', 0.05);
            // Shimmer
            playTone(f * 1.5, 0.5, 'triangle', 0.03);
          }, i * 25);
        });
      }, 220);
      // Destello final agudo
      setTimeout(() => {
        playTone(2093, 0.4, 'sine', 0.06); // Do muy alto
        playTone(2637, 0.35, 'sine', 0.04); // Mi muy alto
      }, 500);
    },

    // Final tipo "cascada de estrellas"
    () => {
      const baseNotes = scale ? scale.notes.slice(-6) : [523, 587, 659, 784, 880, 1047];
      // Cascada descendente brillante
      baseNotes.reverse().forEach((f, i) => {
        setTimeout(() => {
          playTone(f * 2, 0.15, 'sine', 0.07);
          playTone(f, 0.2, 'triangle', 0.05);
        }, i * 60);
      });
      // Acorde final con reverb simulado
      setTimeout(() => {
        const chord = scale ? scale.chord : [523, 659, 784, 1047];
        chord.forEach(f => {
          playTone(f, 1.0, 'sine', 0.1);
          setTimeout(() => playTone(f, 0.8, 'sine', 0.05), 50);
          setTimeout(() => playTone(f, 0.6, 'triangle', 0.03), 100);
        });
        // Brillo final
        setTimeout(() => playTone(1568, 0.5, 'sine', 0.06), 200);
        setTimeout(() => playTone(2093, 0.4, 'sine', 0.04), 300);
      }, 380);
    },

    // Final tipo "campanas m√°gicas"
    () => {
      const bellNotes = [1047, 1318, 1568, 2093, 1568, 1318, 1047];
      bellNotes.forEach((f, i) => {
        setTimeout(() => {
          playTone(f, 0.3, 'sine', 0.08);
          playTone(f * 0.5, 0.4, 'triangle', 0.04); // Sub-octava
        }, i * 70);
      });
      // Acorde majestuoso final
      setTimeout(() => {
        const chord = scale ? scale.chord : [523, 659, 784, 1047];
        // Construir el acorde gradualmente
        chord.forEach((f, i) => {
          setTimeout(() => {
            playTone(f, 1.2, 'sine', 0.1);
            playTone(f * 2, 0.8, 'sine', 0.04);
          }, i * 60);
        });
      }, 520);
      // Destello de cierre
      setTimeout(() => {
        [1568, 2093, 2637].forEach((f, i) => {
          setTimeout(() => playTone(f, 0.25, 'sine', 0.05 - i*0.01), i * 40);
        });
      }, 850);
    },

    // Final tipo "fuegos artificiales"
    () => {
      // Subida r√°pida como cohete
      [262, 330, 392, 523, 659, 784, 1047].forEach((f, i) => {
        setTimeout(() => playTone(f, 0.06, 'sawtooth', 0.04), i * 25);
      });
      // Explosi√≥n de notas
      setTimeout(() => {
        const sparkles = [1047, 1175, 1318, 1397, 1568, 1760, 1976, 2093];
        sparkles.forEach((f, i) => {
          setTimeout(() => {
            playTone(f + Math.random()*50, 0.2, 'sine', 0.06);
          }, Math.random() * 150);
        });
      }, 200);
      // Acorde final glorioso
      setTimeout(() => {
        const chord = scale ? [...scale.chord, scale.chord[0]*2] : [523, 659, 784, 1047, 1047];
        chord.forEach((f, i) => {
          playTone(f, 1.0, 'sine', 0.09);
          playTone(f, 0.7, 'triangle', 0.04);
        });
      }, 400);
      // Brillo de cierre
      setTimeout(() => {
        playTone(2093, 0.5, 'sine', 0.05);
        setTimeout(() => playTone(2349, 0.4, 'sine', 0.04), 80);
        setTimeout(() => playTone(2637, 0.35, 'sine', 0.03), 150);
      }, 650);
    }
  ];

  // Elegir un final aleatorio
  const finale = finales[Math.floor(Math.random() * finales.length)];
  finale();
}

// ========== S√çNTESIS DE VOZ (TEXT-TO-SPEECH) ==========
let speechSynth = window.speechSynthesis;
let currentUtterance = null;
let isSpeaking = false;
let voiceReady = false;
let spanishVoice = null;

// Buscar la mejor voz en espa√±ol (priorizar voces naturales/premium)
function findSpanishVoice(){
  const voices = speechSynth.getVoices();
  console.log('Voces disponibles:', voices.map(v => `${v.name} (${v.lang}) local:${v.localService}`));

  // Prioridad 1: Voces de red/online (generalmente m√°s naturales)
  const onlineVoice = voices.find(v =>
    v.lang.startsWith('es') && v.localService === false
  );
  if(onlineVoice){
    spanishVoice = onlineVoice;
    console.log('Voz online encontrada:', onlineVoice.name);
    voiceReady = true;
    return;
  }

  // Prioridad 2: Voces premium/naturales de Microsoft, Google o Apple en espa√±ol
  const premiumVoices = [
    // Microsoft Neural voices (Windows 11)
    'Microsoft Dalia Online', 'Microsoft Jorge Online',
    // Microsoft est√°ndar
    'Microsoft Sabina', 'Microsoft Helena', 'Microsoft Laura', 'Microsoft Raul',
    // Google
    'Google espa√±ol', 'Google espa√±ol de Estados Unidos', 'Google espa√±ol de M√©xico',
    // Apple macOS/iOS
    'Paulina', 'Monica', 'Juan', 'Diego', 'Angelica', 'Jimena'
  ];

  for(const premiumName of premiumVoices){
    const found = voices.find(v => v.name.includes(premiumName) && v.lang.startsWith('es'));
    if(found){
      spanishVoice = found;
      console.log('Voz premium encontrada:', found.name);
      voiceReady = true;
      return;
    }
  }

  // Prioridad 2: Cualquier voz que suene m√°s natural (evitar "eSpeak" que es muy rob√≥tica)
  const naturalVoice = voices.find(v =>
    v.lang.startsWith('es') &&
    !v.name.toLowerCase().includes('espeak') &&
    (v.name.includes('Microsoft') || v.name.includes('Google') || v.localService === false)
  );

  if(naturalVoice){
    spanishVoice = naturalVoice;
    console.log('Voz natural encontrada:', naturalVoice.name);
    voiceReady = true;
    return;
  }

  // Prioridad 3: Cualquier voz en espa√±ol latinoamericano
  spanishVoice = voices.find(v => v.lang === 'es-MX') ||
                 voices.find(v => v.lang === 'es-419') ||
                 voices.find(v => v.lang === 'es-US') ||
                 voices.find(v => v.lang === 'es-ES') ||
                 voices.find(v => v.lang.startsWith('es'));

  // Solo usar voz no-espa√±ola como √∫ltimo recurso absoluto
  if(!spanishVoice && voices.length > 0){
    console.warn('‚ö†Ô∏è No se encontr√≥ voz en espa√±ol, usando fallback:', voices[0].name, voices[0].lang);
    spanishVoice = voices[0];
  }

  console.log('Voz seleccionada:', spanishVoice?.name || 'ninguna', spanishVoice?.lang || '');
  voiceReady = true;
}

// Cargar voces (pueden cargarse de forma as√≠ncrona)
if(speechSynth.onvoiceschanged !== undefined){
  speechSynth.onvoiceschanged = findSpanishVoice;
}
findSpanishVoice();

// Funci√≥n principal para hablar texto
function speakText(text, onEnd = null, options = {}){
  try {
    if(!speechSynth) {
      console.log('Speech synthesis no disponible');
      if(onEnd) onEnd();
      return;
    }

    // Cancelar cualquier habla anterior
    stopSpeaking();

    // Bug fix para Chrome: necesita un "resume" si est√° pausado
    speechSynth.cancel();

    // Recargar voces si no est√°n listas
    if(!spanishVoice || speechSynth.getVoices().length === 0){
      findSpanishVoice();
    }

    // Limpiar HTML del texto y agregar pausas naturales
    let cleanText = text.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();

    // Normalizar Unicode NFC para que acentos como √≥ no se lean como "o acento agudo"
    if(cleanText.normalize) cleanText = cleanText.normalize('NFC');

    // Limpiar emojis que la voz podr√≠a intentar describir
    cleanText = cleanText.replace(/[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{FE00}-\u{FE0F}\u{1F000}-\u{1FFFF}]/gu, '');

  // Agregar pausas m√°s largas despu√©s de puntos y signos de exclamaci√≥n/interrogaci√≥n
  // Usamos comas extras que la voz interpreta como pausas
  // Agregar pausas sutiles entre oraciones (no tan largas)
  cleanText = cleanText
    .replace(/\. /g, '. . ')      // Pausa corta despu√©s de punto
    .replace(/! /g, '! . ')       // Pausa despu√©s de exclamaci√≥n
    .replace(/\? /g, '? . ');     // Pausa despu√©s de interrogaci√≥n

  console.log('Intentando hablar:', cleanText.substring(0, 50) + '...');

  currentUtterance = new SpeechSynthesisUtterance(cleanText);

  // Configurar voz - intentar de nuevo buscar si no hay
  if(!spanishVoice){
    const voices = speechSynth.getVoices();
    spanishVoice = voices.find(v => v.lang.startsWith('es')) || voices[0];
  }

  if(spanishVoice) {
    currentUtterance.voice = spanishVoice;
    console.log('Usando voz:', spanishVoice.name, spanishVoice.lang);
  }

  currentUtterance.lang = spanishVoice?.lang || 'es-MX';

  // Velocidad intermedia - 0.88 es pausado pero no lento
  currentUtterance.rate = options.rate || 0.88;
  currentUtterance.pitch = options.pitch || 1.0;
  currentUtterance.volume = options.volume || 1;

  isSpeaking = true;

  currentUtterance.onstart = () => {
    console.log('Voz iniciada');
  };

  currentUtterance.onend = () => {
    console.log('Voz terminada');
    isSpeaking = false;
    currentUtterance = null;
    if(onEnd) onEnd();
  };

  currentUtterance.onerror = (e) => {
    console.log('Error de voz:', e.error);
    isSpeaking = false;
    currentUtterance = null;
    if(onEnd) onEnd();
  };

  // Chrome bug fix: usar timeout y resume
  setTimeout(() => {
    if(!currentUtterance) return;
    speechSynth.speak(currentUtterance);
    // Chrome a veces se pausa solo, forzar resume
    if(speechSynth.paused){
      speechSynth.resume();
    }
  }, 100);

  // Chrome bug fix: mantener vivo el speech cada 10 segundos
  const keepAlive = setInterval(() => {
    if(!isSpeaking){
      clearInterval(keepAlive);
      return;
    }
    if(speechSynth.paused){
      speechSynth.resume();
    }
  }, 10000);
  } catch(e) {
    console.error('Error en speakText:', e);
    isSpeaking = false;
    if(onEnd) onEnd();
  }
}

// Detener lectura
function stopSpeaking(){
  if(speechSynth){
    speechSynth.cancel();
  }
  isSpeaking = false;
  currentUtterance = null;
}

// Leer el cuento completo (problema + pregunta)
function readStoryAloud(storyText, question, onComplete){
  // Construir texto completo
  const fullText = storyText + '. ' + question;

  // Indicador visual de lectura
  const storyEl = document.querySelector('.story-modal-text');
  const questionEl = document.querySelector('.story-modal-question');
  const voiceBtn = document.querySelector('.voice-btn');

  if(storyEl) storyEl.classList.add('reading');
  if(voiceBtn) voiceBtn.classList.add('speaking');

  speakText(fullText, () => {
    // Quitar indicadores visuales
    if(storyEl) storyEl.classList.remove('reading');
    if(questionEl) questionEl.classList.remove('reading');
    if(voiceBtn) voiceBtn.classList.remove('speaking');

    // Activar el quiz
    if(onComplete) onComplete();
  }, { rate: 0.88, pitch: 1.0 }); // Tono natural

  // Cambiar highlight de texto a pregunta a mitad de lectura (aproximado)
  const storyLength = storyText.length;
  const estimatedStoryTime = storyLength * 50; // ~50ms por car√°cter a velocidad 0.85

  setTimeout(() => {
    if(isSpeaking && storyEl && questionEl){
      storyEl.classList.remove('reading');
      questionEl.classList.add('reading');
    }
  }, estimatedStoryTime);
}

// Toggle manual de voz
function toggleVoiceReading(){
  if(isSpeaking){
    stopSpeaking();
    const voiceBtn = document.querySelector('.voice-btn');
    if(voiceBtn) voiceBtn.classList.remove('speaking');
    document.querySelectorAll('.reading').forEach(el => el.classList.remove('reading'));
  } else {
    // Re-leer el cuento actual
    const step = currentStory.steps[currentStep];
    const storyText = step.template
      .replaceAll('{char}', currentStory.character)
      .replaceAll('{a}', numA)
      .replaceAll('{b}', numB);

    readStoryAloud(storyText, step.question, () => {
      enableQuizSection();
    });
  }
}

// Habilitar secci√≥n del quiz
function enableQuizSection(){
  const quizSection = document.querySelector('.quiz-section');
  if(quizSection){
    quizSection.classList.remove('hidden');
  }
  // Peque√±o sonido para indicar que puede responder
  sndClick();
}

// Mostrar n√∫mero flotante de conteo
function showCountNumber(el, num){
  const rect = el.getBoundingClientRect();
  const numEl = document.createElement('div');
  numEl.textContent = num;
  numEl.style.cssText = `
    position: fixed;
    left: ${rect.left + rect.width/2}px;
    top: ${rect.top - 10}px;
    transform: translate(-50%, -50%);
    font-size: 1.4rem;
    font-weight: 900;
    color: var(--yellow);
    text-shadow: 0 0 10px rgba(255,212,59,.8), 0 2px 4px rgba(0,0,0,.5);
    pointer-events: none;
    z-index: 9999;
    animation: countFloat 0.8s ease-out forwards;
  `;
  document.body.appendChild(numEl);
  setTimeout(() => numEl.remove(), 800);
}

function showVictory(){
  sndVictory();
  score.adventures++;
  score.stars += 3;
  moduleTracker.adventuresInModule++;
  spawnConfetti(80);
  spawnStars(8);
  renderScoreBar();

  // Mensajes de victoria personalizados para Emilio
  const victoryMessages = [
    `¬°${PLAYER.fullName} lo logr√≥!`,
    `¬°Incre√≠ble ${PLAYER.name}! ¬°Eres un genio!`,
    `¬°${PLAYER.nickname}, completaste la aventura!`,
    `¬°Felicidades ${PLAYER.name}! ¬°Eres el mejor!`,
    `¬°${PLAYER.fullName} es imparable!`
  ];
  const victoryMsg = victoryMessages[Math.floor(Math.random() * victoryMessages.length)];

  document.getElementById('celebration').style.display = 'flex';
  document.getElementById('celebration').innerHTML = `
    <div class="celebration-content">
      <div class="stars" style="animation:emojiBounce .6s ease infinite">‚≠ê‚≠ê‚≠ê</div>
      <h2>${victoryMsg}</h2>
      <p>${currentStory.character.startsWith('el ') ? 'Ayudaste al' : 'Ayudaste a'} <b>${currentStory.character.replace(/^(el |la )/i, '')}</b></p>
      <p style="color:#ffd43b;font-weight:800;animation:starSparkle 1s ease infinite">+3 estrellas bonus</p>
      <button class="btn btn-new" onclick="closeCelebration()">üé≤ Nueva Aventura</button>
    </div>
  `;

  // Leer la felicitaci√≥n
  speakText(`${victoryMsg} ¬°Ganaste tres estrellas! ¬°Eres s√∫per inteligente, ${PLAYER.nickname}!`, null, { rate: 0.88, pitch: 1.0 });

  // M√°s confetti despu√©s de un momento
  setTimeout(() => spawnConfetti(40), 800);
  setTimeout(() => spawnStars(5), 1200);
}

function closeCelebration(){
  stopSpeaking();
  document.getElementById('celebration').style.display = 'none';
  if(moduleTracker.opsCompleted.size >= 4){
    showModuleResults();
  } else {
    startNewAdventure();
  }
}

// ========== TRIVIA - JUEGO DE PREMIO ==========
const TRIVIA_CATEGORIES = {
  mario: {
    name: 'Mario Bros',
    icon: 'üçÑ',
    color: '#e52521',
    questions: [
      { q: '¬øDe qu√© color es la gorra de Mario?', img: 'üß¢', a: 'Roja', options: ['Roja', 'Verde', 'Azul', 'Amarilla'] },
      { q: '¬øC√≥mo se llama el hermano de Mario?', img: 'üë®‚Äçüë¶', a: 'Luigi', options: ['Luigi', 'Wario', 'Toad', 'Bowser'] },
      { q: '¬øQu√© princesa rescata Mario?', img: 'üë∏', a: 'Peach', options: ['Peach', 'Daisy', 'Rosalina', 'Zelda'] },
      { q: '¬øQui√©n es el enemigo principal de Mario?', img: 'üê¢', a: 'Bowser', options: ['Bowser', 'Wario', 'Donkey Kong', 'Boo'] },
      { q: '¬øQu√© come Mario para hacerse grande?', img: 'üçÑ', a: 'Hongo', options: ['Hongo', 'Estrella', 'Flor', 'Moneda'] },
      { q: '¬øQu√© le da poderes de fuego a Mario?', img: 'üî•', a: 'Flor de fuego', options: ['Flor de fuego', 'Estrella', 'Hongo', 'Pluma'] },
      { q: '¬øC√≥mo se llama el dinosaurio amigo de Mario?', img: 'ü¶ñ', a: 'Yoshi', options: ['Yoshi', 'Rex', 'Birdo', 'Koopa'] },
      { q: '¬øQu√© recoge Mario para ganar vidas?', img: 'üí∞', a: 'Monedas', options: ['Monedas', 'Estrellas', 'Hongos', 'Diamantes'] },
      { q: '¬øEn qu√© reino vive la Princesa Peach?', img: 'üè∞', a: 'Reino Champi√±√≥n', options: ['Reino Champi√±√≥n', 'Reino Koopa', 'Reino Flor', 'Reino Estrella'] },
      { q: '¬øQu√© profesi√≥n tiene Mario?', img: 'üîß', a: 'Plomero', options: ['Plomero', 'Carpintero', 'Doctor', 'Chef'] },
      { q: '¬øDe qu√© color es Luigi?', img: 'üíö', a: 'Verde', options: ['Verde', 'Rojo', 'Azul', 'Amarillo'] },
      { q: '¬øQu√© hace Mario invencible?', img: '‚≠ê', a: 'Estrella', options: ['Estrella', 'Hongo', 'Flor', 'Pluma'] }
    ]
  },
  pokemon: {
    name: 'Pok√©mon',
    icon: '‚ö°',
    color: '#ffcb05',
    questions: [
      { q: '¬øC√≥mo se llama el Pok√©mon amarillo el√©ctrico?', img: '‚ö°', a: 'Pikachu', options: ['Pikachu', 'Raichu', 'Pichu', 'Jolteon'] },
      { q: '¬øDe qu√© tipo es Charmander?', img: 'üî•', a: 'Fuego', options: ['Fuego', 'Agua', 'Planta', 'El√©ctrico'] },
      { q: '¬øQui√©n es el entrenador principal del anime?', img: 'üß¢', a: 'Ash', options: ['Ash', 'Brock', 'Gary', 'Red'] },
      { q: '¬øEn qu√© evoluciona Charmander al final?', img: 'üêâ', a: 'Charizard', options: ['Charizard', 'Charmeleon', 'Dragonite', 'Salamence'] },
      { q: '¬øDe qu√© tipo es Squirtle?', img: 'üíß', a: 'Agua', options: ['Agua', 'Fuego', 'Planta', 'Hielo'] },
      { q: '¬øCu√°ntos Pok√©mon ten√≠a la primera generaci√≥n?', img: 'üì±', a: '151', options: ['151', '100', '200', '250'] },
      { q: '¬øQu√© Pok√©mon es el n√∫mero 1 en la Pok√©dex?', img: 'üå±', a: 'Bulbasaur', options: ['Bulbasaur', 'Pikachu', 'Charmander', 'Squirtle'] },
      { q: '¬øC√≥mo se llama el Pok√©mon gato que siempre pierde?', img: 'üê±', a: 'Meowth', options: ['Meowth', 'Persian', 'Skitty', 'Glameow'] },
      { q: '¬øQu√© se usa para atrapar Pok√©mon?', img: 'üî¥', a: 'Pok√©bola', options: ['Pok√©bola', 'Red', 'Trampa', 'Jaula'] },
      { q: '¬øQui√©n es el Pok√©mon legendario de fuego de Kanto?', img: 'üî•', a: 'Moltres', options: ['Moltres', 'Entei', 'Ho-Oh', 'Charizard'] },
      { q: '¬øDe qu√© tipo es Bulbasaur?', img: 'üåø', a: 'Planta', options: ['Planta', 'Agua', 'Fuego', 'Tierra'] },
      { q: '¬øCu√°l es la evoluci√≥n de Pikachu?', img: '‚ö°', a: 'Raichu', options: ['Raichu', 'Pichu', 'Jolteon', 'Electabuzz'] }
    ]
  },
  dinos: {
    name: 'Dinosaurios',
    icon: 'ü¶ï',
    color: '#4ade80',
    questions: [
      { q: '¬øCu√°l dinosaurio ten√≠a tres cuernos?', img: 'ü¶è', a: 'Triceratops', options: ['Triceratops', 'Stegosaurus', 'Ankylosaurus', 'Pachycephalosaurus'] },
      { q: '¬øCu√°l era el dinosaurio carn√≠voro m√°s famoso?', img: 'ü¶ñ', a: 'T-Rex', options: ['T-Rex', 'Velociraptor', 'Spinosaurus', 'Allosaurus'] },
      { q: '¬øQu√© dinosaurio ten√≠a placas en la espalda?', img: 'üî∂', a: 'Stegosaurus', options: ['Stegosaurus', 'Ankylosaurus', 'Triceratops', 'Diplodocus'] },
      { q: '¬øQu√© dinosaurio volaba?', img: 'ü¶Ö', a: 'Pterod√°ctilo', options: ['Pterod√°ctilo', 'Velociraptor', 'Archaeopteryx', 'T-Rex'] },
      { q: '¬øCu√°l dinosaurio ten√≠a cuello muy largo?', img: 'ü¶ï', a: 'Brachiosaurus', options: ['Brachiosaurus', 'T-Rex', 'Triceratops', 'Velociraptor'] },
      { q: '¬øHace cu√°ntos millones de a√±os se extinguieron los dinosaurios?', img: '‚òÑÔ∏è', a: '65 millones', options: ['65 millones', '100 millones', '10 millones', '200 millones'] },
      { q: '¬øQu√© com√≠an los dinosaurios herb√≠voros?', img: 'üåø', a: 'Plantas', options: ['Plantas', 'Carne', 'Pescado', 'Insectos'] },
      { q: '¬øEn qu√© era vivieron los dinosaurios?', img: 'üåç', a: 'Mesozoica', options: ['Mesozoica', 'Paleozoica', 'Cenozoica', 'Moderna'] },
      { q: '¬øCu√°l dinosaurio era muy r√°pido y peque√±o?', img: 'üí®', a: 'Velociraptor', options: ['Velociraptor', 'T-Rex', 'Brachiosaurus', 'Triceratops'] },
      { q: '¬øQu√© significa dinosaurio?', img: 'üìñ', a: 'Lagarto terrible', options: ['Lagarto terrible', 'Reptil grande', 'Animal antiguo', 'Bestia feroz'] },
      { q: '¬øCu√°l dinosaurio ten√≠a una cola con picos?', img: 'üî±', a: 'Stegosaurus', options: ['Stegosaurus', 'Ankylosaurus', 'Triceratops', 'Diplodocus'] },
      { q: '¬øLos dinosaurios pon√≠an...?', img: 'ü•ö', a: 'Huevos', options: ['Huevos', 'Cr√≠as vivas', 'Semillas', 'Nada'] }
    ]
  },
  capitales: {
    name: 'Capitales del Mundo',
    icon: 'üåç',
    color: '#38bdf8',
    questions: [
      { q: '¬øCu√°l es la capital de Colombia?', img: '‚òïüå∫', a: 'Bogot√°', options: ['Bogot√°', 'Medell√≠n', 'Cali', 'Cartagena'] },
      { q: '¬øCu√°l es la capital de Estados Unidos?', img: 'üóΩü¶Ö', a: 'Washington D.C.', options: ['Washington D.C.', 'Nueva York', 'Los √Ångeles', 'Miami'] },
      { q: '¬øCu√°l es la capital de Francia?', img: 'üóºü•ê', a: 'Par√≠s', options: ['Par√≠s', 'Lyon', 'Marsella', 'Niza'] },
      { q: '¬øCu√°l es la capital de M√©xico?', img: 'üåÆüé∫', a: 'Ciudad de M√©xico', options: ['Ciudad de M√©xico', 'Guadalajara', 'Canc√∫n', 'Monterrey'] },
      { q: '¬øCu√°l es la capital de Brasil?', img: '‚öΩüå¥', a: 'Brasilia', options: ['Brasilia', 'R√≠o de Janeiro', 'S√£o Paulo', 'Salvador'] },
      { q: '¬øCu√°l es la capital de Espa√±a?', img: 'üíÉüêÇ', a: 'Madrid', options: ['Madrid', 'Barcelona', 'Sevilla', 'Valencia'] },
      { q: '¬øCu√°l es la capital de Argentina?', img: 'ü•©‚öΩ', a: 'Buenos Aires', options: ['Buenos Aires', 'C√≥rdoba', 'Rosario', 'Mendoza'] },
      { q: '¬øCu√°l es la capital de Jap√≥n?', img: 'üóæüç£', a: 'Tokio', options: ['Tokio', 'Osaka', 'Kioto', 'Hiroshima'] },
      { q: '¬øCu√°l es la capital de Italia?', img: 'üçïüèõÔ∏è', a: 'Roma', options: ['Roma', 'Mil√°n', 'Venecia', 'Florencia'] },
      { q: '¬øCu√°l es la capital de Per√∫?', img: 'ü¶ôüèîÔ∏è', a: 'Lima', options: ['Lima', 'Cusco', 'Arequipa', 'Trujillo'] },
      { q: '¬øCu√°l es la capital de Inglaterra?', img: 'üé°üëë', a: 'Londres', options: ['Londres', 'Manchester', 'Liverpool', 'Birmingham'] },
      { q: '¬øCu√°l es la capital de Alemania?', img: 'üç∫üè∞', a: 'Berl√≠n', options: ['Berl√≠n', 'M√∫nich', 'Frankfurt', 'Hamburgo'] },
      { q: '¬øCu√°l es la capital de Chile?', img: 'üèîÔ∏èüçá', a: 'Santiago', options: ['Santiago', 'Valpara√≠so', 'Concepci√≥n', 'Antofagasta'] },
      { q: '¬øCu√°l es la capital de Ecuador?', img: 'üåãüçå', a: 'Quito', options: ['Quito', 'Guayaquil', 'Cuenca', 'Manta'] }
    ]
  },
  carros: {
    name: 'Marcas de Carros',
    icon: 'üöó',
    color: '#f472b6',
    questions: [
      { q: '¬øQu√© marca tiene un caballo como logo?', img: 'üê¥üèéÔ∏è', a: 'Ferrari', options: ['Ferrari', 'Lamborghini', 'Porsche', 'Mustang'] },
      { q: '¬øQu√© marca tiene un toro como logo?', img: 'üêÇüèéÔ∏è', a: 'Lamborghini', options: ['Lamborghini', 'Ferrari', 'Maserati', 'Alfa Romeo'] },
      { q: '¬øDe qu√© pa√≠s es Toyota?', img: 'üóæüöó', a: 'Jap√≥n', options: ['Jap√≥n', 'Corea', 'China', 'Alemania'] },
      { q: '¬øQu√© marca tiene cuatro aros como logo?', img: '‚≠ï‚≠ï', a: 'Audi', options: ['Audi', 'BMW', 'Mercedes', 'Volkswagen'] },
      { q: '¬øDe qu√© pa√≠s es BMW?', img: 'üè∞üöó', a: 'Alemania', options: ['Alemania', 'Italia', 'Francia', 'Jap√≥n'] },
      { q: '¬øQu√© marca tiene una estrella de tres puntas?', img: '‚ú®üöó', a: 'Mercedes-Benz', options: ['Mercedes-Benz', 'BMW', 'Audi', 'Lexus'] },
      { q: '¬øQu√© marca hace el Mustang?', img: 'üêéüí®', a: 'Ford', options: ['Ford', 'Chevrolet', 'Dodge', 'Jeep'] },
      { q: '¬øQu√© marca hace el Corvette?', img: 'üèéÔ∏èüí®', a: 'Chevrolet', options: ['Chevrolet', 'Ford', 'Dodge', 'Cadillac'] },
      { q: '¬øDe qu√© pa√≠s es Hyundai?', img: 'üééüöó', a: 'Corea del Sur', options: ['Corea del Sur', 'Jap√≥n', 'China', 'Taiw√°n'] },
      { q: '¬øQu√© marca tiene un le√≥n como logo?', img: 'ü¶Åüöó', a: 'Peugeot', options: ['Peugeot', 'Renault', 'Citro√´n', 'Fiat'] },
      { q: '¬øQu√© marca hace el Beetle (escarabajo)?', img: 'üêûüöô', a: 'Volkswagen', options: ['Volkswagen', 'Fiat', 'Mini', 'Renault'] },
      { q: '¬øDe qu√© pa√≠s es Ferrari?', img: 'üçïüèéÔ∏è', a: 'Italia', options: ['Italia', 'Alemania', 'Francia', 'Espa√±a'] },
      { q: '¬øQu√© significa Volkswagen en alem√°n?', img: 'üöôüë•', a: 'Carro del pueblo', options: ['Carro del pueblo', 'Carro veloz', 'Carro grande', 'Carro lujoso'] }
    ]
  },
  rimas: {
    name: 'Completa la Rima',
    icon: 'üé§',
    color: '#a78bfa',
    questions: [
      { q: 'El gato con botas, com√≠a ¬ø...?', img: 'üê±üë¢', a: 'zanahorias', options: ['zanahorias', 'manzanas', 'pescados', 'galletas'] },
      { q: 'Hab√≠a una vez un pato, que usaba un ¬ø...?', img: 'ü¶Ü', a: 'zapato', options: ['zapato', 'sombrero', 'pantal√≥n', 'vestido'] },
      { q: 'La abeja Luc√≠a, volaba con ¬ø...?', img: 'üêù', a: 'alegr√≠a', options: ['alegr√≠a', 'tristeza', 'pereza', 'fuerza'] },
      { q: 'En el mar hab√≠a un pez, que contaba hasta ¬ø...?', img: 'üêü', a: 'diez', options: ['diez', 'cien', 'tres', 'seis'] },
      { q: 'El rat√≥n Ram√≥n, tocaba el ¬ø...?', img: 'üê≠üéµ', a: 'tromb√≥n', options: ['tromb√≥n', 'piano', 'tambor', 'viol√≠n'] },
      { q: 'La rana cantaba, mientras ¬ø...?', img: 'üê∏üé§', a: 'saltaba', options: ['saltaba', 'dorm√≠a', 'com√≠a', 'nadaba'] },
      { q: 'El oso Mateo, gan√≥ el ¬ø...?', img: 'üêªüèÜ', a: 'trofeo', options: ['trofeo', 'premio', 'juego', 'torneo'] },
      { q: 'La estrella Estela, brillaba en la ¬ø...?', img: '‚≠êüåô', a: 'escuela', options: ['escuela', 'ventana', 'cocina', 'calle'] },
      { q: 'El le√≥n Sim√≥n, com√≠a ¬ø...?', img: 'ü¶Åüçâ', a: 'mel√≥n', options: ['mel√≥n', 'manzana', 'naranja', 'fresa'] },
      { q: 'El perro Beto, montaba en ¬ø...?', img: 'üêïüõπ', a: 'patineto', options: ['patineto', 'bicicleta', 'carro', 'moto'] },
      { q: 'La tortuga Ruga, com√≠a ¬ø...?', img: 'üê¢ü•¨', a: 'lechuga', options: ['lechuga', 'pizza', 'carne', 'huevo'] },
      { q: 'El elefante elegante, era muy ¬ø...?', img: 'üêò‚ú®', a: 'importante', options: ['importante', 'peque√±o', 'r√°pido', 'silencioso'] },
      { q: 'La gallina Catalina, bailaba ¬ø...?', img: 'üêîüíÉ', a: 'bailarina', options: ['bailarina', 'cantando', 'saltando', 'corriendo'] },
      { q: 'El mono To√±o, se comi√≥ un ¬ø...?', img: 'üêµüç©', a: 'mo√±o', options: ['mo√±o', 'pl√°tano', 'coco', 'mango'] },
      { q: 'El conejo Alejo, se mir√≥ en el ¬ø...?', img: 'üê∞ü™û', a: 'espejo', options: ['espejo', 'agua', 'lago', 'vidrio'] }
    ]
  }
};

let currentTriviaCategory = null;
let currentTriviaQuestion = null;
let triviaCallback = null;
let triviaQuestions = [];
let triviaCurrentIndex = 0;
let triviaCorrectCount = 0;
const TRIVIA_TOTAL_QUESTIONS = 3;

function showTriviaGame(onComplete){
  triviaCallback = onComplete;
  triviaQuestions = [];
  triviaCurrentIndex = 0;
  triviaCorrectCount = 0;

  // Seleccionar 3 preguntas de categor√≠as aleatorias (pueden ser diferentes)
  const categories = Object.keys(TRIVIA_CATEGORIES);
  for(let i = 0; i < TRIVIA_TOTAL_QUESTIONS; i++){
    const randomCat = categories[Math.floor(Math.random() * categories.length)];
    const cat = TRIVIA_CATEGORIES[randomCat];
    const q = cat.questions[Math.floor(Math.random() * cat.questions.length)];
    triviaQuestions.push({ ...q, category: cat });
  }

  // Mostrar primera pregunta
  showTriviaQuestion();
}

function showTriviaQuestion(){
  currentTriviaCategory = triviaQuestions[triviaCurrentIndex].category;
  currentTriviaQuestion = triviaQuestions[triviaCurrentIndex];

  const shuffledOptions = shuffleArray([...currentTriviaQuestion.options]);

  const optionsHTML = shuffledOptions.map(opt => `
    <button class="trivia-option" onclick="checkTriviaAnswer('${opt.replace(/'/g, "\\'")}')">${opt}</button>
  `).join('');

  // Progreso visual
  const progressDots = Array.from({length: TRIVIA_TOTAL_QUESTIONS}, (_, i) => {
    if(i < triviaCurrentIndex) return '<span class="trivia-dot done">‚úì</span>';
    if(i === triviaCurrentIndex) return '<span class="trivia-dot current">‚óè</span>';
    return '<span class="trivia-dot">‚óã</span>';
  }).join('');

  document.getElementById('triviaModal').style.display = 'flex';
  document.getElementById('triviaModal').innerHTML = `
    <div class="trivia-content">
      <div class="trivia-header">
        <div class="trivia-progress">${progressDots}</div>
        <div class="trivia-category">
          <span class="trivia-category-icon">${currentTriviaCategory.icon}</span>
          ${currentTriviaCategory.name}
        </div>
        <div class="trivia-title">üéÅ Pregunta ${triviaCurrentIndex + 1} de ${TRIVIA_TOTAL_QUESTIONS}</div>
        <div class="trivia-subtitle">‚≠ê ${triviaCorrectCount} estrellas ganadas</div>
      </div>

      <div class="trivia-question-box">
        <div class="trivia-image">${currentTriviaQuestion.img}</div>
        <div class="trivia-question">${currentTriviaQuestion.q}</div>
      </div>

      <div class="trivia-options">${optionsHTML}</div>

      <div class="trivia-feedback" id="triviaFeedback"></div>
      <button class="trivia-continue-btn" id="triviaContinueBtn" onclick="nextTriviaQuestion()">Siguiente ‚ûú</button>
    </div>
  `;

  // Deshabilitar botones mientras habla
  const allBtns = document.querySelectorAll('.trivia-option');
  allBtns.forEach(b => b.classList.add('disabled'));

  // Anunciar pregunta con iluminaci√≥n de opciones
  const intro = triviaCurrentIndex === 0
    ? `¬°${PLAYER.nickname}, tienes ${TRIVIA_TOTAL_QUESTIONS} preguntas premio! Primera pregunta, de ${currentTriviaCategory.name}.`
    : `Pregunta ${triviaCurrentIndex + 1}, de ${currentTriviaCategory.name}.`;

  // Leer intro y pregunta primero
  speakText(`${intro} . . ${currentTriviaQuestion.q} . . Las opciones son:`, () => {
    // Ahora leer cada opci√≥n ilumin√°ndola
    readOptionsSequentially(shuffledOptions, 0, allBtns);
  }, { rate: 0.88, pitch: 1.0 });
}

function readOptionsSequentially(options, index, btns){
  if(index >= options.length){
    // Termin√≥ de leer opciones, preguntar cu√°l es la respuesta
    btns.forEach(b => b.classList.remove('reading'));
    speakText('¬øCu√°l es tu respuesta?', () => {
      btns.forEach(b => b.classList.remove('disabled'));
    }, { rate: 0.88, pitch: 1.0 });
    return;
  }

  const letters = ['A', 'B', 'C', 'D'];
  const optionText = `${letters[index]}: ${options[index]}`;

  // Iluminar la opci√≥n actual
  btns.forEach(b => b.classList.remove('reading'));
  if(btns[index]) btns[index].classList.add('reading');

  // Leer esta opci√≥n
  speakText(optionText, () => {
    // Peque√±a pausa y luego siguiente opci√≥n
    setTimeout(() => {
      readOptionsSequentially(options, index + 1, btns);
    }, 200);
  }, { rate: 0.88, pitch: 1.0 });
}

function checkTriviaAnswer(selected){
  const btns = document.querySelectorAll('.trivia-option');
  const feedback = document.getElementById('triviaFeedback');
  const correct = currentTriviaQuestion.a;

  btns.forEach(btn => {
    btn.classList.add('disabled');
    if(btn.textContent === correct) btn.classList.add('correct');
  });

  const selectedBtn = Array.from(btns).find(b => b.textContent === selected);

  if(selected === correct){
    sndCorrect();
    spawnConfetti(15);
    triviaCorrectCount++;
    score.stars++;
    renderScoreBar();

    feedback.className = 'trivia-feedback success show';
    feedback.innerHTML = `üéâ ¬°Correcto! +1 ‚≠ê`;

    const msgs = [`¬°Bien ${PLAYER.nickname}!`, `¬°Correcto!`, `¬°Eso es!`, `¬°Muy bien!`];
    speakText(msgs[Math.floor(Math.random() * msgs.length)], () => {
      document.getElementById('triviaContinueBtn').classList.add('show');
    }, { rate: 0.88, pitch: 1.0 });

  } else {
    sndWrong();
    if(selectedBtn) selectedBtn.classList.add('wrong');

    feedback.className = 'trivia-feedback error show';
    feedback.innerHTML = `Era: <b>${correct}</b>`;

    speakText(`No ${PLAYER.name}, era ${correct}.`, () => {
      document.getElementById('triviaContinueBtn').classList.add('show');
    }, { rate: 0.88, pitch: 1.0 });
  }
}

function nextTriviaQuestion(){
  triviaCurrentIndex++;

  if(triviaCurrentIndex < TRIVIA_TOTAL_QUESTIONS){
    showTriviaQuestion();
  } else {
    // Mostrar resumen final
    showTriviaSummary();
  }
}

function showTriviaSummary(){
  moduleTracker.totalTriviaCorrect += triviaCorrectCount;
  moduleTracker.totalTriviaTotal += TRIVIA_TOTAL_QUESTIONS;
  const stars = '‚≠ê'.repeat(triviaCorrectCount);
  const message = triviaCorrectCount === 3
    ? `¬°${PLAYER.fullName} es un genio! ¬°Perfecto!`
    : triviaCorrectCount === 2
    ? `¬°Muy bien ${PLAYER.nickname}! ¬°2 de 3!`
    : triviaCorrectCount === 1
    ? `¬°Bien ${PLAYER.nickname}! ¬°1 de 3!`
    : `¬°Sigue practicando ${PLAYER.name}!`;

  document.getElementById('triviaModal').innerHTML = `
    <div class="trivia-content">
      <div class="trivia-header">
        <div class="trivia-title" style="font-size:2rem">üèÜ</div>
        <div class="trivia-title">¬°Ronda Completada!</div>
        <div class="trivia-subtitle">${message}</div>
      </div>
      <div style="font-size:3rem;margin:20px 0">${stars || 'üòÖ'}</div>
      <div style="font-size:1.2rem;color:var(--cyan);font-weight:700">${triviaCorrectCount} de ${TRIVIA_TOTAL_QUESTIONS} correctas</div>
      <button class="trivia-continue-btn show" onclick="closeTriviaGame()">¬°Continuar! ‚ûú</button>
    </div>
  `;

  if(triviaCorrectCount > 0) spawnConfetti(triviaCorrectCount * 15);
  speakText(message, null, { rate: 0.88, pitch: 1.0 });
}

function closeTriviaGame(){
  stopSpeaking();
  document.getElementById('triviaModal').style.display = 'none';

  if(triviaCallback){
    triviaCallback();
    triviaCallback = null;
  }
}

// ========== DESAF√çO REL√ÅMPAGO - C√ÅLCULO MENTAL R√ÅPIDO ==========
let desafioProblems = [];
let desafioCurrentIndex = 0;
let desafioCorrectCount = 0;
let desafioCombo = 0;
let desafioMaxCombo = 0;
let desafioStartTime = 0;
let desafioSpeedBonuses = 0;
let desafioCallback = null;
const DESAFIO_TOTAL = 20;

const desafioUsedKeys = new Set();
const desafioOpsPool = ['suma','suma','resta','resta','multi','multi','divi','suma','resta','multi'];
let desafioShuffledOps = [];

function generateDesafioProblems(){
  desafioProblems = [];
  desafioUsedKeys.clear();
  desafioShuffledOps = shuffleArray([...desafioOpsPool]);

  for(let i = 0; i < DESAFIO_TOTAL; i++){
    desafioProblems.push(generateOneDesafioProblem(i, 0));
  }
}

// nivel: 0=f√°cil, 1=medio, 2=dif√≠cil (se ajusta por racha)
function generateOneDesafioProblem(index, nivel){
  const op = desafioShuffledOps[index % desafioShuffledOps.length];
  let a, b, ans, sym, readText, key;
  let tries = 0;

  do {
    if(op === 'suma'){
      if(nivel === 0){       a = rand(1,9);   b = rand(1,9); }
      else if(nivel === 1){  a = rand(5,15);  b = rand(5,15); }
      else if(nivel === 2){  a = rand(10,30); b = rand(10,30); }
      else if(nivel === 3){  a = rand(20,50); b = rand(15,40); }
      else {                 a = rand(30,99); b = rand(20,70); }
      ans = a + b; sym = '+';
      readText = `${a} m√°s ${b}`;
    } else if(op === 'resta'){
      if(nivel === 0){       a = rand(5,15);  b = rand(1, a - 1); }
      else if(nivel === 1){  a = rand(15,30); b = rand(5, a - 1); }
      else if(nivel === 2){  a = rand(25,50); b = rand(10, a - 1); }
      else if(nivel === 3){  a = rand(40,80); b = rand(15, a - 1); }
      else {                 a = rand(50,99); b = rand(20, a - 1); }
      ans = a - b; sym = '‚àí';
      readText = `${a} menos ${b}`;
    } else if(op === 'multi'){
      if(nivel === 0){       a = rand(2,5);  b = rand(2,4); }
      else if(nivel === 1){  a = rand(3,7);  b = rand(3,6); }
      else if(nivel === 2){  a = rand(5,12); b = rand(4,9); }
      else if(nivel === 3){  a = rand(6,12); b = rand(6,12); }
      else {                 a = rand(7,15); b = rand(7,13); }
      ans = a * b; sym = '√ó';
      readText = `${a} por ${b}`;
    } else {
      if(nivel === 0){       b = rand(2,4);  ans = rand(2,5); }
      else if(nivel === 1){  b = rand(3,6);  ans = rand(3,8); }
      else if(nivel === 2){  b = rand(4,9);  ans = rand(5,12); }
      else if(nivel === 3){  b = rand(5,12); ans = rand(6,15); }
      else {                 b = rand(6,15); ans = rand(7,18); }
      a = b * ans; sym = '√∑';
      readText = `${a} entre ${b}`;
    }
    key = `${a}${sym}${b}`;
    tries++;
  } while(desafioUsedKeys.has(key) && tries < 50);

  desafioUsedKeys.add(key);
  const distractors = generateDesafioDistractors(ans, nivel);
  const options = shuffleArray([ans, ...distractors]);

  return { op, a, b, answer: ans, sym, options, readText };
}

function getDesafioDifficulty(){
  // Escala progresiva: racha m√°s larga = m√°s dif√≠cil
  // Tambi√©n sube con el avance de preguntas
  const rachaBonus = desafioCombo >= 10 ? 4 : desafioCombo >= 7 ? 3 : desafioCombo >= 4 ? 2 : desafioCombo >= 2 ? 1 : 0;
  const progressBonus = desafioCurrentIndex >= 15 ? 2 : desafioCurrentIndex >= 10 ? 1 : 0;
  return Math.min(rachaBonus + progressBonus, 4);
}

function generateDesafioDistractors(correct, nivel){
  const set = new Set();
  // Distractores m√°s enga√±osos en niveles altos
  const maxOffset = nivel >= 3 ? 8 : nivel >= 2 ? 5 : 3;
  while(set.size < 3){
    let offset = rand(1, maxOffset) * (Math.random() > 0.5 ? 1 : -1);
    let d = correct + offset;
    if(d < 0) d = correct + Math.abs(offset);
    if(d !== correct && !set.has(d)) set.add(d);
  }
  return [...set];
}

function showDesafioRelampago(onComplete){
  desafioCallback = onComplete;
  desafioCurrentIndex = 0;
  desafioCorrectCount = 0;
  desafioCombo = 0;
  desafioMaxCombo = 0;
  desafioSpeedBonuses = 0;
  desafioStartTime = Date.now();

  generateDesafioProblems();

  document.getElementById('desafioModal').style.display = 'flex';
  document.getElementById('desafioModal').innerHTML = `
    <div class="desafio-content">
      <div style="font-size:4rem;margin-bottom:16px">üöÄ</div>
      <div class="desafio-title">‚ö° ¬°Desaf√≠o Rel√°mpago! ‚ö°</div>
      <div class="desafio-subtitle" style="margin:12px 0;font-size:1rem;color:var(--text)">
        Responde r√°pido para llevar el cohete a las estrellas
      </div>
      <div style="font-size:.9rem;color:var(--text-dim);margin-bottom:20px">
        ${DESAFIO_TOTAL} operaciones ¬∑ Toca la respuesta correcta
      </div>
      <button class="desafio-continue-btn" id="desafioStartBtn" onclick="showDesafioQuestion()" style="pointer-events:none;opacity:.5">¬°Empezar! üöÄ</button>
    </div>
  `;

  speakText(`¬°${PLAYER.nickname}, es hora del Desaf√≠o Rel√°mpago! Responde r√°pido para llevar el cohete a las estrellas. Tienes ${DESAFIO_TOTAL} preguntas. ¬°Vamos!`, () => {
    const btn = document.getElementById('desafioStartBtn');
    if(btn){ btn.style.pointerEvents = 'auto'; btn.style.opacity = '1'; }
  }, { rate: 0.92, pitch: 1.05 });
}

function showDesafioQuestion(){
  const problem = desafioProblems[desafioCurrentIndex];
  const rocketBottom = 5 + (desafioCurrentIndex > 0 ? getDesafioRocketPosition() : 0);

  const progressDots = Array.from({length: DESAFIO_TOTAL}, (_, i) => {
    if(i < desafioCurrentIndex){
      const wasCorrect = desafioProblems[i].wasCorrect;
      return `<span class="desafio-dot ${wasCorrect ? 'done' : 'wrong-dot'}">${wasCorrect ? '‚úì' : '‚úó'}</span>`;
    }
    if(i === desafioCurrentIndex) return '<span class="desafio-dot current">‚óè</span>';
    return '<span class="desafio-dot">‚óã</span>';
  }).join('');

  const checkpoints = [
    { pct: 30, pos: '30%' },
    { pct: 60, pos: '60%' },
    { pct: 95, pos: '95%' }
  ];
  const reachedPct = (desafioCorrectCount / DESAFIO_TOTAL) * 100;
  const checkpointHTML = checkpoints.map(cp =>
    `<div class="desafio-checkpoint ${reachedPct >= cp.pct ? 'reached' : ''}" style="bottom:${cp.pos}">‚≠ê</div>`
  ).join('');

  const optionsHTML = problem.options.map(opt =>
    `<button class="desafio-option" onclick="checkDesafioAnswer(${opt})">${opt}</button>`
  ).join('');

  const nivel = getDesafioDifficulty();
  const nivelLabels = ['üü¢ F√°cil', 'üü° Medio', 'üî¥ Dif√≠cil'];
  const comboText = desafioCombo >= 3 ? `${'üî•'.repeat(Math.min(desafioCombo - 2, 5))} ¬°Racha de ${desafioCombo}!` : '';

  document.getElementById('desafioModal').innerHTML = `
    <div class="desafio-content">
      <div class="desafio-header">
        <div class="desafio-progress">${progressDots}</div>
        <div class="desafio-title">‚ö° Pregunta ${desafioCurrentIndex + 1} de ${DESAFIO_TOTAL}</div>
        <div class="desafio-subtitle">‚≠ê ${desafioCorrectCount} correctas ¬∑ ${nivelLabels[nivel]}</div>
      </div>

      <div class="desafio-track">
        ${checkpointHTML}
        <div class="desafio-rocket" style="bottom:${rocketBottom}%">üöÄ</div>
      </div>

      <div class="desafio-equation-box">
        <div class="desafio-equation">
          ${problem.a} <span class="desafio-op">${problem.sym}</span> ${problem.b} <span class="desafio-op">=</span> <span class="desafio-q">?</span>
        </div>
      </div>

      <div class="desafio-options">${optionsHTML}</div>
      <div class="desafio-combo ${comboText ? 'active' : ''}">${comboText}</div>
    </div>
  `;

  // Deshabilitar mientras lee
  const allBtns = document.querySelectorAll('.desafio-option');
  allBtns.forEach(b => b.classList.add('disabled'));

  problem.questionStartTime = Date.now();

  speakText(problem.readText, () => {
    allBtns.forEach(b => b.classList.remove('disabled'));
  }, { rate: 1.0, pitch: 1.05 });
}

function getDesafioRocketPosition(){
  let pos = 0;
  for(let i = 0; i < desafioCurrentIndex; i++){
    pos += desafioProblems[i].wasCorrect ? 9.5 : 3;
  }
  return Math.min(pos, 90);
}

function checkDesafioAnswer(selected){
  const problem = desafioProblems[desafioCurrentIndex];
  const btns = document.querySelectorAll('.desafio-option');
  const correct = problem.answer;
  const elapsed = Date.now() - problem.questionStartTime;

  btns.forEach(btn => {
    btn.classList.add('disabled');
    if(parseInt(btn.textContent) === correct) btn.classList.add('correct');
  });

  if(selected === correct){
    problem.wasCorrect = true;
    desafioCorrectCount++;
    desafioCombo++;
    if(desafioCombo > desafioMaxCombo) desafioMaxCombo = desafioCombo;

    const isSpeed = elapsed < 4000;
    if(isSpeed) desafioSpeedBonuses++;

    score.stars++;
    if(isSpeed){ score.stars++; }
    renderScoreBar();

    sndCorrect();
    spawnConfetti(8);

    // Animar cohete subiendo
    const rocket = document.querySelector('.desafio-rocket');
    if(rocket){
      const newPos = getDesafioRocketPosition() + 9.5;
      rocket.style.bottom = Math.min(newPos, 95) + '%';
    }

    // Actualizar combo visual
    const comboEl = document.querySelector('.desafio-combo');
    if(comboEl && desafioCombo >= 3){
      comboEl.className = 'desafio-combo active';
      comboEl.innerHTML = `${'üî•'.repeat(Math.min(desafioCombo - 2, 5))} ¬°Racha de ${desafioCombo}!`;
    }

    const msgs = ['¬°Bien!', '¬°Eso!', '¬°S√≠!', '¬°Genial!'];
    speakText(msgs[rand(0, msgs.length - 1)], () => {
      setTimeout(nextDesafioQuestion, 400);
    }, { rate: 1.1, pitch: 1.1 });

  } else {
    problem.wasCorrect = false;
    desafioCombo = 0;

    const selectedBtn = Array.from(btns).find(b => parseInt(b.textContent) === selected);
    if(selectedBtn) selectedBtn.classList.add('wrong');

    sndWrong();

    const rocket = document.querySelector('.desafio-rocket');
    if(rocket){
      rocket.style.animation = 'rocketShake .4s ease';
      const newPos = getDesafioRocketPosition() + 3;
      rocket.style.bottom = Math.min(newPos, 95) + '%';
      setTimeout(() => { if(rocket) rocket.style.animation = ''; }, 400);
    }

    const comboEl = document.querySelector('.desafio-combo');
    if(comboEl){ comboEl.className = 'desafio-combo'; comboEl.innerHTML = ''; }

    speakText(`Era ${correct}`, () => {
      setTimeout(nextDesafioQuestion, 400);
    }, { rate: 1.0, pitch: 0.9 });
  }
}

function nextDesafioQuestion(){
  desafioCurrentIndex++;
  if(desafioCurrentIndex < DESAFIO_TOTAL){
    // Regenerar la siguiente pregunta con dificultad ajustada a la racha
    desafioProblems[desafioCurrentIndex] = generateOneDesafioProblem(desafioCurrentIndex, getDesafioDifficulty());
    showDesafioQuestion();
  } else {
    showDesafioSummary();
  }
}

function showDesafioSummary(){
  moduleTracker.totalDesafioCorrect += desafioCorrectCount;
  moduleTracker.totalDesafioTotal += DESAFIO_TOTAL;
  const totalTime = Math.round((Date.now() - desafioStartTime) / 1000);
  const stars = '‚≠ê'.repeat(desafioCorrectCount);
  const speedStars = desafioSpeedBonuses > 0 ? ` (+${desafioSpeedBonuses} bonus rapidez ‚ö°)` : '';

  let message, emoji;
  if(desafioCorrectCount === DESAFIO_TOTAL){
    message = `¬°${PLAYER.fullName} es un rayo matem√°tico! ¬°PERFECTO!`;
    emoji = 'üèÜ';
  } else if(desafioCorrectCount >= DESAFIO_TOTAL * 0.8){
    message = `¬°Incre√≠ble ${PLAYER.nickname}! ¬°${desafioCorrectCount} de ${DESAFIO_TOTAL}!`;
    emoji = 'üåü';
  } else if(desafioCorrectCount >= DESAFIO_TOTAL * 0.6){
    message = `¬°Muy bien ${PLAYER.nickname}! ¬°${desafioCorrectCount} de ${DESAFIO_TOTAL}!`;
    emoji = 'üëè';
  } else if(desafioCorrectCount >= DESAFIO_TOTAL * 0.4){
    message = `¬°Bien ${PLAYER.nickname}! ¬°${desafioCorrectCount} de ${DESAFIO_TOTAL}!`;
    emoji = 'üí™';
  } else {
    message = `¬°Sigue practicando ${PLAYER.name}! ¬°T√∫ puedes!`;
    emoji = 'üöÄ';
  }

  const comboMsg = desafioMaxCombo >= 3 ? `<div style="margin-top:8px;font-size:.9rem;color:var(--orange)">üî• Mejor racha: ${desafioMaxCombo} seguidas</div>` : '';

  document.getElementById('desafioModal').innerHTML = `
    <div class="desafio-content">
      <div class="desafio-header">
        <div style="font-size:3rem;margin-bottom:8px">${emoji}</div>
        <div class="desafio-title">¬°Desaf√≠o Completado!</div>
        <div class="desafio-subtitle">${message}</div>
      </div>
      <div class="desafio-summary">
        <div class="summary-stars">${stars || 'üòÖ'}</div>
        <div class="summary-score"><b>${desafioCorrectCount}</b> de ${DESAFIO_TOTAL} correctas${speedStars}</div>
        <div style="font-size:.85rem;color:var(--text-dim);margin-top:8px">‚è±Ô∏è Tiempo: ${totalTime} segundos</div>
        ${comboMsg}
        <button class="desafio-continue-btn" style="margin-top:20px" onclick="closeDesafioRelampago()">¬°Continuar! ‚ûú</button>
      </div>
    </div>
  `;

  if(desafioCorrectCount >= 8) spawnConfetti(desafioCorrectCount * 10);
  else if(desafioCorrectCount > 0) spawnConfetti(desafioCorrectCount * 5);

  speakText(message, null, { rate: 0.92, pitch: 1.05 });
}

function closeDesafioRelampago(){
  stopSpeaking();
  document.getElementById('desafioModal').style.display = 'none';
  if(desafioCallback){
    desafioCallback();
    desafioCallback = null;
  }
}

// ========== MODULE RESULTS ==========

function generateModuleAnalysis(){
  const ops = ['suma', 'resta', 'multi', 'divi'];
  const opNames = { suma: 'Suma', resta: 'Resta', multi: 'Multiplicaci√≥n', divi: 'Divisi√≥n' };
  const opSymbols = { suma: '+', resta: '‚àí', multi: '√ó', divi: '√∑' };

  const analysis = { strong: [], needsPractice: [], weak: [] };

  ops.forEach(op => {
    const p = moduleTracker.performance[op];
    if(p.stepCount === 0) return;

    let opScore = 100;
    opScore -= Math.min(p.quizErrors * 15, 45);
    opScore -= Math.min(p.practiceErrors * 10, 30);
    const avgAttempts = p.dragAttempts / p.stepCount;
    if(avgAttempts > 1) opScore -= Math.min((avgAttempts - 1) * 12, 30);
    const avgHints = p.hintsUsed / p.stepCount;
    opScore -= Math.min(avgHints * 8, 24);
    opScore -= Math.min(p.termsErrors * 5, 20);
    const avgStars = p.starsEarned / p.stepCount;
    if(avgStars >= 2.5) opScore += 5;
    opScore = Math.max(0, Math.min(100, opScore));

    const entry = {
      op, name: opNames[op], sym: opSymbols[op], score: opScore,
      quizErrors: p.quizErrors, quizCorrect: p.quizCorrect,
      practiceErrors: p.practiceErrors,
      avgAttempts: avgAttempts.toFixed(1),
      avgHints: avgHints.toFixed(1),
      avgStars: avgStars.toFixed(1),
      termsErrors: p.termsErrors, termsCorrect: p.termsCorrect,
      stepCount: p.stepCount
    };

    if(opScore >= 75) analysis.strong.push(entry);
    else if(opScore >= 45) analysis.needsPractice.push(entry);
    else analysis.weak.push(entry);
  });

  return analysis;
}

function generateModuleSpeech(analysis, desafioPct, triviaPct, devMsg){
  let speech = '';

  // INTRO: saludo natural a los pap√°s
  const intros = [
    `¬°Hola pap√°s! Vengan, les cuento. . ${PLAYER.name} acaba de terminar un m√≥dulo completo donde practic√≥ las cuatro operaciones: suma, resta, multiplicaci√≥n y divisi√≥n.`,
    `¬°Buenas! Pap√°s, les tengo noticias. . ${PLAYER.name} termin√≥ su m√≥dulo de matem√°ticas y practic√≥ suma, resta, multiplicaci√≥n y divisi√≥n.`,
    `¬°Hola! Qu√© bueno que est√°n aqu√≠. . Les voy a contar c√≥mo le fue a ${PLAYER.name} en las cuatro operaciones que practicamos: suma, resta, multiplicaci√≥n y divisi√≥n.`
  ];
  speech += intros[Math.floor(Math.random() * intros.length)] + ' . ';

  // LO QUE HIZO BIEN
  if(analysis.strong.length > 0){
    if(analysis.strong.length === 4){
      const perfectIntros = [
        `Y la verdad, ¬°les fue incre√≠ble! ${PLAYER.name} domin√≥ las cuatro operaciones sin ning√∫n problema.`,
        `¬°Y les cuento algo! ${PLAYER.name} estuvo excelente en TODO. . Las cuatro operaciones, perfecto.`,
        `La buena noticia es que ${PLAYER.name} mostr√≥ un nivel excelente en las cuatro operaciones.`
      ];
      speech += perfectIntros[Math.floor(Math.random() * perfectIntros.length)] + ' ';

      // Dar detalles de alguna operaci√≥n destacada
      const best = analysis.strong.reduce((a, b) => parseFloat(a.avgStars) >= parseFloat(b.avgStars) ? a : b);
      if(best.quizErrors === 0 && best.termsErrors === 0){
        speech += `Por ejemplo, en la ${best.name} estuvo perfecto: identific√≥ la operaci√≥n siempre bien, resolvi√≥ los ejercicios y el vocabulario sin errores. `;
      }
    } else {
      const names = analysis.strong.map(e => e.name);
      if(names.length === 1){
        speech += `Empecemos por lo bueno: en la ${names[0]} le fue muy bien. `;
      } else if(names.length === 2){
        speech += `Empecemos por lo bueno: en ${names[0]} y ${names[1]} estuvo muy bien. `;
      } else {
        speech += `Empecemos por lo bueno: en ${names.slice(0, -1).join(', ')} y ${names[names.length-1]} le fue muy bien. `;
      }

      // Detalles de las fuertes (m√°ximo 2 para no alargar)
      analysis.strong.slice(0, 2).forEach(e => {
        const details = [];
        if(e.quizErrors === 0) details.push('siempre supo identificarla en los cuentos');
        if(e.termsErrors === 0) details.push('se aprendi√≥ todo el vocabulario');
        if(parseFloat(e.avgStars) >= 2.5) details.push('sac√≥ muchas estrellas');
        if(details.length > 0){
          speech += `En la ${e.name}, ${details.join(' y ')}. `;
        }
      });
    }
  }

  // LO QUE PUEDE MEJORAR
  if(analysis.needsPractice.length > 0){
    const transition = analysis.strong.length > 0
      ? `Ahora, hay algunas cositas que puede mejorar. `
      : `Bueno, hay √°reas donde todav√≠a puede crecer. `;
    speech += transition;

    analysis.needsPractice.forEach((e, i) => {
      const connector = i === 0 ? '' : 'Tambi√©n, ';
      speech += `${connector}en la ${e.name} `;

      const issues = [];
      if(e.quizErrors > 0 && e.practiceErrors > 0){
        issues.push(`a veces le cost√≥ reconocer cu√°ndo un problema era de ${e.name.toLowerCase()}, por eso lo mandamos a practicar ${e.practiceErrors > 1 ? 'un par de veces' : 'una vez'}`);
      } else if(e.quizErrors > 0){
        issues.push(`le cost√≥ un poco identificar cu√°ndo el cuento hablaba de ${e.name.toLowerCase()}`);
      }
      if(e.termsErrors > 0){
        issues.push(`hay que repasar los t√©rminos, como los nombres de los n√∫meros en esa operaci√≥n`);
      }
      if(parseFloat(e.avgHints) > 0.5){
        issues.push(`necesit√≥ algunas pistas para resolver los ejercicios`);
      }

      if(issues.length > 0){
        speech += issues.join(', y ') + '. ';
      } else {
        speech += `puede practicar un poco m√°s. `;
      }
    });

    speech += `Pero nada grave, con un poco m√°s de pr√°ctica va a mejorar r√°pido. `;
  }

  // LO QUE NECESITA REFORZAR
  if(analysis.weak.length > 0){
    const weakTransition = analysis.needsPractice.length > 0
      ? `Y algo importante: `
      : (analysis.strong.length > 0 ? `Ahora, algo que s√≠ necesita m√°s trabajo: ` : `Les cuento algo: `);
    speech += weakTransition;

    const names = analysis.weak.map(e => e.name);
    speech += `la ${names.join(' y la ')} necesita m√°s pr√°ctica. `;

    analysis.weak.forEach(e => {
      const issues = [];
      if(e.quizErrors > 0) issues.push(`todav√≠a no reconoce bien cu√°ndo un problema es de ${e.name.toLowerCase()}`);
      if(e.practiceErrors > 0) issues.push(`tuvo que ir a cuentos de pr√°ctica ${e.practiceErrors} ${e.practiceErrors > 1 ? 'veces' : 'vez'}`);
      if(parseFloat(e.avgAttempts) > 2) issues.push(`necesit√≥ varios intentos para resolver los ejercicios`);
      if(e.termsErrors > 1) issues.push(`los t√©rminos de la ${e.name.toLowerCase()} hay que repasarlos en casa`);

      if(issues.length > 0){
        speech += `En la ${e.name}, ${issues.join(', y ')}. `;
      }
    });

    speech += `Pero tranquilos, es completamente normal. Vamos a seguir practicando y van a ver c√≥mo va mejorando. `;
  }

  // C√ÅLCULO MENTAL Y TRIVIA (integrado naturalmente)
  if(desafioPct > 0 || triviaPct > 0){
    speech += '. Ah, y tambi√©n les cuento sobre las actividades extras. ';
    if(desafioPct > 0){
      if(desafioPct >= 80) speech += `En el c√°lculo mental r√°pido estuvo incre√≠ble, sac√≥ ${desafioPct} por ciento de aciertos. `;
      else if(desafioPct >= 60) speech += `En el c√°lculo mental r√°pido le fue bien, sac√≥ ${desafioPct} por ciento. `;
      else speech += `En el c√°lculo mental r√°pido sac√≥ ${desafioPct} por ciento, ah√≠ puede mejorar la velocidad. `;
    }
    if(triviaPct > 0){
      if(triviaPct >= 80) speech += `Y en la trivia de cultura general estuvo genial con ${triviaPct} por ciento de aciertos. `;
      else if(triviaPct >= 50) speech += `En la trivia de cultura general sac√≥ ${triviaPct} por ciento, nada mal. `;
      else speech += `La trivia estuvo dif√≠cil, sac√≥ ${triviaPct} por ciento, pero as√≠ va aprendiendo cosas nuevas. `;
    }
  }

  // CIERRE
  const allStrong = analysis.weak.length === 0 && analysis.needsPractice.length === 0;
  if(allStrong){
    const closes = [
      `. En resumen, ¬°${PLAYER.fullName} es un campe√≥n de las matem√°ticas! Felic√≠tenlo mucho porque se lo merece.`,
      `. Para cerrar, ¬°${PLAYER.fullName} domina las cuatro operaciones! Estoy muy orgulloso de c√≥mo trabaj√≥ hoy.`,
      `. En conclusi√≥n, ¬°excelente trabajo de ${PLAYER.fullName}! Todas las operaciones las maneja muy bien.`
    ];
    speech += closes[Math.floor(Math.random() * closes.length)] + ' ';
  } else {
    const closes = [
      `. En general, ${PLAYER.name} est√° aprendiendo muy bien. Lo importante es que siga practicando y divirti√©ndose con las matem√°ticas.`,
      `. En resumen, ${PLAYER.name} va por buen camino. Con pr√°ctica constante va a dominar todo. ¬°√Ånimo!`,
      `. Para cerrar, ${PLAYER.name} est√° progresando. Les recomiendo practicar juntos un ratito en casa, sobre todo las operaciones que le costaron m√°s.`
    ];
    speech += closes[Math.floor(Math.random() * closes.length)] + ' ';
  }

  // MENSAJE DEL DESARROLLADOR (transici√≥n natural)
  speech += `. . Ah, y una √∫ltima cosa: . ${devMsg} . `;

  // PREGUNTA FINAL
  speech += `. . Bueno ${PLAYER.name}, ¬øquieres empezar un nuevo m√≥dulo?`;
  return speech;
}

function showModuleResults(){
  // Paso 1: Mostrar aviso para llamar a los pap√°s
  sndVictory();
  spawnConfetti(60);

  const callMsgs = [
    `¬°${PLAYER.name}! ¬°Corre a llamar a tus pap√°s! Diles que vengan a escuchar tu reporte, quiero contarles c√≥mo te fue.`,
    `¬°Oye ${PLAYER.name}! Ve r√°pido por mam√° o pap√°. Necesito que escuchen c√≥mo te fue en el m√≥dulo.`,
    `¬°${PLAYER.nickname}! Llama a tus pap√°s, diles que tienen que venir a escuchar este mensaje. ¬°Es importante!`,
    `¬°${PLAYER.name}! Ve a buscar a mam√° o a pap√° y diles que vengan. Les tengo un reporte de c√≥mo trabajaste hoy.`
  ];
  const callMsg = callMsgs[Math.floor(Math.random() * callMsgs.length)];

  document.getElementById('moduleModal').style.display = 'flex';
  document.getElementById('moduleModal').innerHTML = `
    <div class="module-content">
      <div style="font-size:3.5rem;margin-bottom:12px">üì¢</div>
      <div class="module-title">¬°M√≥dulo Completado!</div>
      <div class="module-subtitle" style="margin-bottom:24px">${PLAYER.name}, completaste las 4 operaciones</div>
      <div style="font-size:1.1rem;color:var(--cyan);font-weight:700;line-height:1.6;margin-bottom:20px">
        ¬°Llama a mam√° o pap√° para que escuchen juntos c√≥mo te fue!
      </div>
      <button class="module-btn" id="callParentsBtn" onclick="showModuleReport()" style="opacity:.5;pointer-events:none">
        üë®‚Äçüë©‚Äçüë¶ ¬°Ya est√°n aqu√≠!
      </button>
    </div>
  `;

  speakText(callMsg, () => {
    const btn = document.getElementById('callParentsBtn');
    if(btn){ btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; }
  }, { rate: 0.85, pitch: 1.0 });
}

function showModuleReport(){
  stopSpeaking();
  const analysis = generateModuleAnalysis();

  spawnConfetti(100);
  spawnStars(12);

  // Helper para generar barra de progreso
  function statBar(label, value, max, color){
    const pct = max > 0 ? Math.round((value / max) * 100) : 0;
    return `<div class="module-stat-row">
      <span class="module-stat-label">${label}</span>
      <div class="module-stat-bar-bg"><div class="module-stat-bar ${color}" style="width:${pct}%"></div></div>
      <span class="module-stat-value">${value}/${max}</span>
    </div>`;
  }

  // Helper para score badge
  function scoreBadge(score){
    if(score >= 75) return `<span class="module-op-score high">${score}%</span>`;
    if(score >= 45) return `<span class="module-op-score mid">${score}%</span>`;
    return `<span class="module-op-score low">${score}%</span>`;
  }

  // Generar HTML detallado por cada operaci√≥n
  const ops = ['suma', 'resta', 'multi', 'divi'];
  const opNames = { suma: 'Suma', resta: 'Resta', multi: 'Multiplicaci√≥n', divi: 'Divisi√≥n' };
  const opSymbols = { suma: '+', resta: '‚àí', multi: '√ó', divi: '√∑' };

  let opsHTML = '';
  ops.forEach(op => {
    const p = moduleTracker.performance[op];
    if(p.stepCount === 0) return;

    const entry = [...analysis.strong, ...analysis.needsPractice, ...analysis.weak].find(e => e.op === op);
    if(!entry) return;

    const scoreColor = entry.score >= 75 ? 'strong' : entry.score >= 45 ? 'practice' : 'weak';
    const totalQuiz = p.quizCorrect + p.quizErrors;
    const totalTerms = p.termsCorrect + p.termsErrors;
    const quizColor = p.quizErrors === 0 ? 'green' : p.quizErrors <= 1 ? 'yellow' : 'red';
    const termsColor = p.termsErrors === 0 ? 'green' : p.termsErrors <= 1 ? 'yellow' : 'red';
    const starsColor = parseFloat(entry.avgStars) >= 2.5 ? 'green' : parseFloat(entry.avgStars) >= 1.5 ? 'yellow' : 'red';

    opsHTML += `
      <div class="module-op-card ${scoreColor}" style="margin-bottom:12px">
        <div class="module-op-header">
          <div class="module-op-name" style="font-size:.95rem">${opSymbols[op]} ${opNames[op]}</div>
          ${scoreBadge(entry.score)}
        </div>
        ${statBar('Identificar operaci√≥n', p.quizCorrect, totalQuiz, quizColor)}
        ${statBar('Estrellas', p.starsEarned, p.stepCount * 3, starsColor)}
        ${statBar('Vocabulario', p.termsCorrect, totalTerms, termsColor)}
        <div class="module-stat-row">
          <span class="module-stat-label">Intentos promedio</span>
          <div class="module-stat-bar-bg"><div class="module-stat-bar ${parseFloat(entry.avgAttempts) <= 1 ? 'green' : parseFloat(entry.avgAttempts) <= 2 ? 'yellow' : 'red'}" style="width:${Math.min(100, (1 / parseFloat(entry.avgAttempts)) * 100)}%"></div></div>
          <span class="module-stat-value">${entry.avgAttempts}</span>
        </div>
        ${p.practiceErrors > 0 ? `<div style="font-size:.7rem;color:var(--yellow);margin-top:4px">‚ö†Ô∏è Fue a cuento de pr√°ctica ${p.practiceErrors} ${p.practiceErrors > 1 ? 'veces' : 'vez'}</div>` : ''}
        ${parseFloat(entry.avgHints) > 0 ? `<div style="font-size:.7rem;color:var(--cyan);margin-top:2px">üí° Us√≥ pistas: ${entry.avgHints} promedio</div>` : ''}
      </div>`;
  });

  const desafioPct = moduleTracker.totalDesafioTotal > 0
    ? Math.round((moduleTracker.totalDesafioCorrect / moduleTracker.totalDesafioTotal) * 100) : 0;
  const triviaPct = moduleTracker.totalTriviaTotal > 0
    ? Math.round((moduleTracker.totalTriviaCorrect / moduleTracker.totalTriviaTotal) * 100) : 0;

  const allStrong = analysis.weak.length === 0 && analysis.needsPractice.length === 0;
  const hasWeak = analysis.weak.length > 0;
  let overallMsg = '';
  let overallEmoji = 'üìä';
  if(allStrong){
    overallMsg = `üèÜ ¬°${PLAYER.fullName} domina las 4 operaciones!`;
    overallEmoji = 'üèÜ';
  } else if(hasWeak){
    const weakNames = analysis.weak.map(e => e.name).join(' y ');
    overallMsg = `üí™ Hay que reforzar la ${weakNames} en casa.`;
  } else {
    overallMsg = `üëè Va por buen camino, sigan practicando juntos.`;
  }

  const devMessages = [
    '¬°Y no olviden invitar al desarrollador de este software a una hamburguesa!',
    '¬°Y no olviden invitar al desarrollador de este software al cine!',
    '¬°Y no olviden invitar al desarrollador de este software a pasear!',
    '¬°Y no olviden invitar al desarrollador de este software a un helado!',
    '¬°Y no olviden invitar al desarrollador de este software a comer pizza!',
    '¬°Y no olviden invitar al desarrollador de este software a un d√≠a de aventura!'
  ];
  const devMsg = devMessages[Math.floor(Math.random() * devMessages.length)];

  // Calcular score global promedio
  const allEntries = [...analysis.strong, ...analysis.needsPractice, ...analysis.weak];
  const avgScore = allEntries.length > 0 ? Math.round(allEntries.reduce((s, e) => s + e.score, 0) / allEntries.length) : 0;
  const totalStars = allEntries.reduce((s, e) => s + parseInt(moduleTracker.performance[e.op].starsEarned), 0);
  const maxStars = allEntries.reduce((s, e) => s + moduleTracker.performance[e.op].stepCount * 3, 0);

  document.getElementById('moduleModal').innerHTML = `
    <div class="module-content">
      <div style="font-size:3.5rem;margin-bottom:8px">${overallEmoji}</div>
      <div class="module-title">Reporte del M√≥dulo</div>
      <div class="module-subtitle">Pap√°s, as√≠ le fue a ${PLAYER.name} en las 4 operaciones</div>

      <!-- Score global -->
      <div style="background:rgba(167,139,250,.1);border-radius:14px;padding:14px;margin-bottom:16px;border:1px solid rgba(167,139,250,.2)">
        <div style="display:flex;align-items:center;justify-content:space-around;gap:8px;text-align:center">
          <div>
            <div style="font-size:1.6rem;font-weight:900;color:${avgScore >= 75 ? 'var(--green)' : avgScore >= 45 ? 'var(--yellow)' : 'var(--red)'}">${avgScore}%</div>
            <div style="font-size:.6rem;color:var(--text-dim);text-transform:uppercase;font-weight:700">Score</div>
          </div>
          <div>
            <div style="font-size:1.6rem;font-weight:900;color:var(--yellow)">${totalStars}‚≠ê</div>
            <div style="font-size:.6rem;color:var(--text-dim);text-transform:uppercase;font-weight:700">de ${maxStars}</div>
          </div>
          <div>
            <div style="font-size:1.6rem;font-weight:900;color:var(--cyan)">${moduleTracker.adventuresInModule}</div>
            <div style="font-size:.6rem;color:var(--text-dim);text-transform:uppercase;font-weight:700">Aventuras</div>
          </div>
        </div>
      </div>

      <!-- Detalle por operaci√≥n -->
      <div class="module-section" style="margin-bottom:16px">
        <div class="module-section-title" style="color:var(--cyan);font-size:.9rem;margin-bottom:12px">üìä Detalle por operaci√≥n</div>
        ${opsHTML}
      </div>

      <!-- Actividades extras -->
      <div class="module-global-stats">
        <div class="module-big-stat">
          <div class="module-big-stat-icon">üß†</div>
          <div class="module-big-stat-info">
            <div class="module-big-stat-title">C√°lculo Mental</div>
            <div class="module-big-stat-detail">${moduleTracker.totalDesafioCorrect} correctas de ${moduleTracker.totalDesafioTotal}</div>
          </div>
          <div class="module-big-stat-pct" style="color:${desafioPct >= 70 ? 'var(--green)' : desafioPct >= 50 ? 'var(--yellow)' : 'var(--red)'}">${desafioPct}%</div>
        </div>
        ${statBar('', moduleTracker.totalDesafioCorrect, moduleTracker.totalDesafioTotal, desafioPct >= 70 ? 'green' : desafioPct >= 50 ? 'yellow' : 'red')}
        <div class="module-big-stat" style="margin-top:6px">
          <div class="module-big-stat-icon">üéØ</div>
          <div class="module-big-stat-info">
            <div class="module-big-stat-title">Trivia de Cultura</div>
            <div class="module-big-stat-detail">${moduleTracker.totalTriviaCorrect} correctas de ${moduleTracker.totalTriviaTotal}</div>
          </div>
          <div class="module-big-stat-pct" style="color:${triviaPct >= 70 ? 'var(--green)' : triviaPct >= 50 ? 'var(--yellow)' : 'var(--red)'}">${triviaPct}%</div>
        </div>
        ${statBar('', moduleTracker.totalTriviaCorrect, moduleTracker.totalTriviaTotal, triviaPct >= 70 ? 'green' : triviaPct >= 50 ? 'yellow' : 'red')}
      </div>

      <div class="module-overall">${overallMsg}</div>

      <div style="margin-top:12px;font-size:.85rem;color:var(--pink);font-weight:700;font-style:italic">${devMsg}</div>

      <button class="module-btn" id="moduleCloseBtn" onclick="closeModuleResults()" style="pointer-events:none;opacity:.5">
        üé≤ ¬øQuieres empezar un nuevo m√≥dulo?
      </button>
    </div>
  `;

  const speechText = generateModuleSpeech(analysis, desafioPct, triviaPct, devMsg);
  speakText(speechText, () => {
    const btn = document.getElementById('moduleCloseBtn');
    if(btn){ btn.style.pointerEvents = 'auto'; btn.style.opacity = '1'; }
  }, { rate: 0.85, pitch: 1.0 });
}

function closeModuleResults(){
  stopSpeaking();
  document.getElementById('moduleModal').style.display = 'none';
  resetModuleTracker();
  startNewAdventure();
}

// DEBUG: Ctrl+Shift+M para forzar reporte de m√≥dulo (QUITAR DESPU√âS)
document.addEventListener('keydown', (e) => {
  if(e.ctrlKey && e.shiftKey && e.key === 'M'){
    // Simular datos de las 4 operaciones
    ['suma','resta','multi','divi'].forEach(op => {
      moduleTracker.opsCompleted.add(op);
      moduleTracker.performance[op].stepCount = 2;
      moduleTracker.performance[op].quizCorrect = 1;
      moduleTracker.performance[op].starsEarned = 5;
      moduleTracker.performance[op].dragAttempts = 3;
    });
    // Simular algunos errores para ver el an√°lisis
    moduleTracker.performance.resta.quizErrors = 2;
    moduleTracker.performance.resta.practiceErrors = 2;
    moduleTracker.performance.resta.termsErrors = 3;
    moduleTracker.performance.divi.quizErrors = 3;
    moduleTracker.performance.divi.practiceErrors = 3;
    moduleTracker.performance.divi.hintsUsed = 4;
    moduleTracker.performance.divi.termsErrors = 4;
    moduleTracker.performance.divi.starsEarned = 2;
    moduleTracker.totalDesafioCorrect = 14;
    moduleTracker.totalDesafioTotal = 20;
    moduleTracker.totalTriviaCorrect = 5;
    moduleTracker.totalTriviaTotal = 6;
    moduleTracker.adventuresInModule = 3;
    showModuleResults();
  }
});

// ========== START ==========
init();
</script>
</body>
</html>
<!-- Deploy ju.,  5 de feb. de 2026 14:00:30 -->
